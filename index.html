<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡å°ˆæ¥­åˆ†æç³»çµ± | Professional Stock Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --bg-hover: #243044;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-up: #ef4444;          /* æ¼² - ç´…è‰² */
            --accent-up-glow: rgba(239, 68, 68, 0.3);
            --accent-down: #10b981;        /* è·Œ - ç¶ è‰² */
            --accent-down-glow: rgba(16, 185, 129, 0.3);
            --accent-yellow: #f59e0b;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --border-color: #2d3a4f;
            --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Input Section */
        .input-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stock-input {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 25px;
            font-size: 1.2rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            width: 200px;
            transition: all 0.3s ease;
        }

        .stock-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .analyze-btn {
            background: var(--gradient-blue);
            border: none;
            border-radius: 12px;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Market Selector */
        .market-selector {
            display: flex;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .market-btn {
            background: transparent;
            border: none;
            padding: 15px 20px;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .market-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .market-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        .market-btn:first-child {
            border-right: 1px solid var(--border-color);
        }

        /* Date Inputs */
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 20px;
        }

        .date-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .date-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .date-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.95rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-separator {
            color: var(--text-muted);
            font-size: 1.2rem;
            margin-top: 15px;
        }

        .date-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .date-info span {
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Quick Date Buttons */
        .quick-date-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 18px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .quick-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Watchlist Add Button */
        .watchlist-add-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 12px;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .watchlist-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }

        /* Watchlist Section */
        .watchlist-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .watchlist-header h3 {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin: 0;
        }

        .watchlist-actions {
            display: flex;
            gap: 10px;
        }

        .watchlist-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .watchlist-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .watchlist-btn.danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .watchlist-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .watchlist-market-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .watchlist-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.95rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .watchlist-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .watchlist-quick-add {
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1.2rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-quick-add:hover {
            background: #2563eb;
        }

        .watchlist-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .watchlist-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-tag:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }

        .watchlist-tag .tag-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .watchlist-tag .tag-code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }

        .watchlist-tag .tag-market {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .watchlist-tag .tag-market.tpex {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .watchlist-tag .tag-remove {
            color: var(--text-muted);
            font-size: 1.1rem;
            line-height: 1;
        }

        .watchlist-tag .tag-remove:hover {
            color: #ef4444;
        }

        /* Watchlist Table */
        .watchlist-table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
        }

        .watchlist-table th,
        .watchlist-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .watchlist-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .watchlist-table td {
            font-family: 'JetBrains Mono', monospace;
        }

        .watchlist-table tr:hover {
            background: var(--bg-hover);
        }

        .watchlist-table .stock-name {
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-primary);
        }

        .watchlist-table .stock-code {
            color: var(--accent-cyan);
            font-size: 0.85rem;
        }

        .watchlist-table .price-up {
            color: var(--accent-up);
        }

        .watchlist-table .price-down {
            color: var(--accent-down);
        }

        .watchlist-table .price-flat {
            color: var(--text-secondary);
        }

        .watchlist-table .analyze-link {
            color: var(--accent-blue);
            cursor: pointer;
            text-decoration: none;
        }

        .watchlist-table .analyze-link:hover {
            text-decoration: underline;
        }

        .watchlist-table .remove-btn {
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }

        .watchlist-table .remove-btn:hover {
            color: #ef4444;
        }

        .watchlist-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            color: var(--text-secondary);
        }

        .spinner-small {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .watchlist-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        /* Toast Animation */
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes toastOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
        }

        /* Responsive for Watchlist */
        @media (max-width: 768px) {
            .watchlist-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .watchlist-input-row {
                flex-direction: column;
            }

            .watchlist-market-select {
                width: 100%;
            }

            .watchlist-table th,
            .watchlist-table td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            .watchlist-add-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Container */
        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        /* Stock Header Card */
        .stock-header {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .stock-info h2 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stock-code {
            color: var(--accent-blue);
            font-family: 'JetBrains Mono', monospace;
        }

        .market-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
            margin-left: 10px;
            vertical-align: middle;
        }

        .market-tag.twse {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .market-tag.tpex {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .stock-price {
            text-align: right;
        }

        .current-price {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .price-up {
            color: var(--accent-up);
        }

        .price-down {
            color: var(--accent-down);
        }

        .price-change {
            font-size: 1.2rem;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-3px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .card-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        /* Alert Section */
        .alerts-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .alert-summary {
            display: flex;
            gap: 20px;
        }

        .alert-count {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-count.bullish {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-up);
        }

        .alert-count.bearish {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-down);
        }

        .alert-count.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-yellow);
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: var(--bg-secondary);
            border-left: 4px solid;
        }

        .alert-item.priority-1 {
            border-left-color: #ef4444;
        }

        .alert-item.priority-2 {
            border-left-color: var(--accent-yellow);
        }

        .alert-item.priority-3 {
            border-left-color: var(--accent-cyan);
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .alert-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .alert-tag {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tag-bullish {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-up);
        }

        .tag-bearish {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-down);
        }

        .tag-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        .tag-neutral {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        /* Score Display */
        .score-display {
            text-align: center;
            padding: 30px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 4rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .score-range {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 10px;
        }

        /* AI Analysis Section */
        .ai-analysis {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .ai-analysis h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-content {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1rem;
        }

        .analysis-section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .analysis-section h4 {
            color: var(--accent-blue);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        /* Technical Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-family: 'JetBrains Mono', monospace;
        }

        .data-table tr:hover {
            background: var(--bg-hover);
        }

        /* Legend */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .input-section {
                flex-direction: column;
            }

            .market-selector {
                width: 100%;
            }

            .market-btn {
                flex: 1;
            }

            .date-inputs {
                width: 100%;
                justify-content: center;
            }

            .stock-input {
                width: 100%;
            }

            .analyze-btn {
                width: 100%;
                justify-content: center;
            }

            .stock-header {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .stock-price {
                text-align: center;
            }

            .current-price {
                font-size: 2.5rem;
            }

            .chart-wrapper {
                height: 300px;
            }

            .tabs {
                justify-content: center;
            }

            .market-tag {
                display: block;
                margin: 10px auto 0;
                width: fit-content;
            }
        }

        @media (max-width: 480px) {
            .date-inputs {
                flex-direction: column;
                gap: 15px;
            }

            .date-separator {
                display: none;
            }

            .date-group {
                width: 100%;
            }

            .date-input {
                width: 100%;
            }
        }

        /* Copy Button for AI Analysis */
        .copy-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Key Levels */
        .key-levels {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .level-item {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            text-align: center;
        }

        .level-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .level-value {
            font-size: 1.3rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .level-resistance {
            color: var(--accent-down);
        }

        .level-support {
            color: var(--accent-up);
        }

        /* Error Display */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: var(--accent-red);
            margin: 20px 0;
            white-space: pre-line;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>å°è‚¡å°ˆæ¥­åˆ†æç³»çµ±</h1>
            <p>æ•´åˆæŠ€è¡“åˆ†æã€ç±Œç¢¼é¢ã€æ¶ˆæ¯é¢ | æ”¯æ´ä¸Šå¸‚ (TWSE) åŠä¸Šæ«ƒ (TPEx) è‚¡ç¥¨</p>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">ğŸ“Œ è­‰äº¤æ‰€/æ«ƒè²·ä¸­å¿ƒè³‡æ–™ç´„æ–¼æ¯æ—¥ 18:00 å¾Œæ›´æ–°ï¼Œç•¶æ—¥è³‡æ–™è«‹æ–¼ç›¤å¾ŒæŸ¥è©¢</p>
        </header>

        <div class="input-section">
            <div class="market-selector">
                <button class="market-btn active" data-market="twse" onclick="selectMarket('twse')">ä¸Šå¸‚ TWSE</button>
                <button class="market-btn" data-market="tpex" onclick="selectMarket('tpex')">ä¸Šæ«ƒ TPEx</button>
            </div>
            <input type="text" class="stock-input" id="stockCode" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ" maxlength="6">
            <div class="date-inputs">
                <div class="date-group">
                    <label for="startDate">èµ·å§‹æ—¥</label>
                    <input type="date" class="date-input" id="startDate">
                </div>
                <span class="date-separator">ï½</span>
                <div class="date-group">
                    <label for="endDate">çµ‚æ­¢æ—¥</label>
                    <input type="date" class="date-input" id="endDate">
                </div>
            </div>
            <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysis()">
                <span>ğŸ”</span>
                <span>é–‹å§‹åˆ†æ</span>
            </button>
            <button class="watchlist-add-btn" onclick="addToWatchlist()">
                <span>â­</span>
                <span>åŠ å…¥è‡ªé¸</span>
            </button>
        </div>

        <!-- è‡ªé¸è‚¡å€å¡Š -->
        <div class="watchlist-section" id="watchlistSection">
            <div class="watchlist-header">
                <h3>â­ æˆ‘çš„è‡ªé¸è‚¡</h3>
                <div class="watchlist-actions">
                    <button class="watchlist-btn" onclick="fetchAllWatchlist()">ğŸ“Š æ›´æ–°å ±åƒ¹</button>
                    <button class="watchlist-btn danger" onclick="clearWatchlist()">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
            </div>
            <div class="watchlist-input-row">
                <select id="watchlistMarket" class="watchlist-market-select">
                    <option value="twse">ä¸Šå¸‚</option>
                    <option value="tpex">ä¸Šæ«ƒ</option>
                </select>
                <input type="text" class="watchlist-input" id="watchlistCode" placeholder="è¼¸å…¥ä»£è™Ÿå¿«é€ŸåŠ å…¥" maxlength="6">
                <button class="watchlist-quick-add" onclick="quickAddWatchlist()">+</button>
            </div>
            <div class="watchlist-tags" id="watchlistTags">
                <!-- è‡ªé¸è‚¡æ¨™ç±¤æœƒå‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="watchlist-table-container" id="watchlistTableContainer" style="display: none;">
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨</th>
                            <th>å¸‚å ´</th>
                            <th>æˆäº¤åƒ¹</th>
                            <th>æ˜¨æ”¶</th>
                            <th>æ¼²è·Œ</th>
                            <th>æ¼²è·Œå¹…</th>
                            <th>æˆäº¤é‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistBody">
                    </tbody>
                </table>
            </div>
            <div class="watchlist-loading" id="watchlistLoading" style="display: none;">
                <div class="spinner-small"></div>
                <span>æ­£åœ¨æ›´æ–°å ±åƒ¹...</span>
            </div>
        </div>
        <div class="date-info" id="dateInfo"></div>
        
        <div class="quick-date-btns">
            <button class="quick-btn" onclick="setDateRange(30)">è¿‘30æ—¥</button>
            <button class="quick-btn active" onclick="setDateRange(60)">è¿‘60æ—¥</button>
            <button class="quick-btn" onclick="setDateRange(90)">è¿‘90æ—¥</button>
            <button class="quick-btn" onclick="setDateRange(180)">è¿‘åŠå¹´</button>
            <button class="quick-btn" onclick="setDateRange(365)">è¿‘ä¸€å¹´</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">æ­£åœ¨ç²å–è‚¡ç¥¨æ•¸æ“š...</p>
        </div>

        <div class="error-message" id="errorMessage" style="display: none;"></div>

        <div class="results" id="results">
            <!-- Stock Header -->
            <div class="stock-header" id="stockHeader">
                <div class="stock-info">
                    <h2><span id="stockName">-</span> <span class="stock-code" id="displayCode">-</span> <span class="market-tag" id="marketTag">ä¸Šå¸‚</span></h2>
                    <p id="stockDate">æœ€å¾Œæ›´æ–°ï¼š-</p>
                </div>
                <div class="stock-price">
                    <div class="current-price" id="currentPrice">-</div>
                    <div class="price-change" id="priceChange">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('overview')">ğŸ“ˆ ç¸½è¦½</button>
                <button class="tab-btn" onclick="showTab('technical')">ğŸ“Š æŠ€è¡“åˆ†æ</button>
                <button class="tab-btn" onclick="showTab('kd-chart')">ğŸ“‰ KD ç·šåœ–</button>
                <button class="tab-btn" onclick="showTab('macd-chart')">ğŸ“Š MACD åœ–è¡¨</button>
                <button class="tab-btn" onclick="showTab('alerts')">ğŸš¨ æ™ºèƒ½è­¦ç¤º</button>
                <button class="tab-btn" onclick="showTab('ai-report')">ğŸ¤– AI åˆ†æå ±å‘Š</button>
            </div>

            <!-- Tab: Overview -->
            <div class="tab-content active" id="tab-overview">
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">æŠ€è¡“è©•åˆ†</span>
                            <span class="card-icon">ğŸ“ˆ</span>
                        </div>
                        <div class="card-value" id="techScore">-</div>
                        <div class="card-subtitle">ç¶œåˆæŠ€è¡“é¢æŒ‡æ¨™</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="techProgress" style="width: 0%; background: var(--accent-blue);"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">RSI (14)</span>
                            <span class="card-icon">ğŸ“Š</span>
                        </div>
                        <div class="card-value" id="rsiValue">-</div>
                        <div class="card-subtitle" id="rsiStatus">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">KD æŒ‡æ¨™</span>
                            <span class="card-icon">ğŸ“‰</span>
                        </div>
                        <div class="card-value" id="kdValue">-</div>
                        <div class="card-subtitle" id="kdStatus">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">æˆäº¤é‡æ¯”</span>
                            <span class="card-icon">ğŸ“¶</span>
                        </div>
                        <div class="card-value" id="volumeRatio">-</div>
                        <div class="card-subtitle" id="volumeStatus">-</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“ˆ åƒ¹æ ¼èµ°å‹¢èˆ‡å‡ç·š <span id="priceChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>æ”¶ç›¤åƒ¹</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>MA5</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8b5cf6;"></div>
                            <span>MA10</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>MA20</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">ğŸ“ é—œéµåƒ¹ä½</h4>
                        <div class="key-levels">
                            <div class="level-item">
                                <div class="level-label">å£“åŠ›ä½ (20æ—¥é«˜)</div>
                                <div class="level-value level-resistance" id="resistanceLevel">-</div>
                            </div>
                            <div class="level-item">
                                <div class="level-label">æ”¯æ’ä½ (20æ—¥ä½)</div>
                                <div class="level-value level-support" id="supportLevel">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">ğŸ“Š å‡ç·šç‹€æ…‹</h4>
                        <div class="key-levels">
                            <div class="level-item">
                                <div class="level-label">MA5</div>
                                <div class="level-value" id="ma5Value">-</div>
                            </div>
                            <div class="level-item">
                                <div class="level-label">MA20</div>
                                <div class="level-value" id="ma20Value">-</div>
                            </div>
                        </div>
                        <p id="maStatus" style="text-align: center; margin-top: 15px; color: var(--text-secondary);"></p>
                    </div>
                </div>
            </div>

            <!-- Tab: Technical Analysis -->
            <div class="tab-content" id="tab-technical">
                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“Š æŠ€è¡“æŒ‡æ¨™æ•¸æ“šè¡¨</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="technicalTable">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ”¶ç›¤</th>
                                    <th>æ¼²è·Œ</th>
                                    <th>æˆäº¤é‡</th>
                                    <th>MA5</th>
                                    <th>MA10</th>
                                    <th>MA20</th>
                                    <th>RSI</th>
                                    <th>K</th>
                                    <th>D</th>
                                </tr>
                            </thead>
                            <tbody id="technicalBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: KD Chart -->
            <div class="tab-content" id="tab-kd-chart">
                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“‰ KD éš¨æ©ŸæŒ‡æ¨™ <span id="kdChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="kdChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>K å€¼</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>D å€¼</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(16, 185, 129, 0.3);"></div>
                            <span>è¶…è²·å€ (80)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(239, 68, 68, 0.3);"></div>
                            <span>è¶…è³£å€ (20)</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">ç•¶å‰ K å€¼</span>
                            <span class="card-icon">ğŸ“Š</span>
                        </div>
                        <div class="card-value" id="currentK">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">ç•¶å‰ D å€¼</span>
                            <span class="card-icon">ğŸ“Š</span>
                        </div>
                        <div class="card-value" id="currentD">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">KD ç‹€æ…‹</span>
                            <span class="card-icon">ğŸ¯</span>
                        </div>
                        <div class="card-value" id="kdSignal" style="font-size: 1.5rem;">-</div>
                    </div>
                </div>
            </div>

            <!-- Tab: MACD Chart -->
            <div class="tab-content" id="tab-macd-chart">
                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“Š MACD æŒ‡æ¨™ <span id="macdChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="macdChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>DIF</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>MACD (Signal)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>æŸ±ç‹€é«” (æ­£)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>æŸ±ç‹€é«” (è² )</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">DIF å€¼</span>
                            <span class="card-icon">ğŸ“ˆ</span>
                        </div>
                        <div class="card-value" id="currentDIF">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">MACD å€¼</span>
                            <span class="card-icon">ğŸ“‰</span>
                        </div>
                        <div class="card-value" id="currentMACD">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">æŸ±ç‹€é«”</span>
                            <span class="card-icon">ğŸ“Š</span>
                        </div>
                        <div class="card-value" id="currentOSC">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">MACD ç‹€æ…‹</span>
                            <span class="card-icon">ğŸ¯</span>
                        </div>
                        <div class="card-value" id="macdSignal" style="font-size: 1.5rem;">-</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Alerts -->
            <div class="tab-content" id="tab-alerts">
                <div class="alerts-section">
                    <div class="alerts-header">
                        <h3 class="chart-title">ğŸš¨ æ™ºèƒ½è­¦ç¤ºå ±å‘Š</h3>
                        <div class="alert-summary">
                            <div class="alert-count bullish">
                                <span>ğŸŸ¢</span>
                                <span id="bullishCount">0</span> çœ‹æ¼²
                            </div>
                            <div class="alert-count bearish">
                                <span>ğŸ”´</span>
                                <span id="bearishCount">0</span> çœ‹è·Œ
                            </div>
                            <div class="alert-count warning">
                                <span>ğŸŸ¡</span>
                                <span id="warningCount">0</span> è­¦å‘Š
                            </div>
                        </div>
                    </div>

                    <div class="score-display">
                        <div class="score-label">ç¶œåˆè©•åˆ†</div>
                        <div class="score-value" id="alertScore">0</div>
                        <div class="score-range">è©•åˆ†ç¯„åœï¼š-100 è‡³ +100</div>
                    </div>

                    <div id="alertsList">
                        <!-- Alerts will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Tab: AI Report -->
            <div class="tab-content" id="tab-ai-report">
                <div class="ai-analysis">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="chart-title" style="margin-bottom: 0;">ğŸ¤– AI å°ˆæ¥­åˆ†æå ±å‘Š</h3>
                        <button class="copy-btn" onclick="copyReport()">ğŸ“‹ è¤‡è£½å ±å‘Š</button>
                    </div>
                    <div id="aiReportContent">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                            AI åˆ†æå ±å‘Šå°‡åœ¨æ•¸æ“šè¼‰å…¥å¾Œè‡ªå‹•ç”Ÿæˆ...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let stockData = [];
        let stockName = '';
        let currentStockCode = '';
        let currentMarket = 'twse'; // 'twse' for ä¸Šå¸‚, 'tpex' for ä¸Šæ«ƒ
        let technicalIndicators = {};
        let charts = {};
        let institutionalData = null;
        let watchlist = []; // è‡ªé¸è‚¡æ¸…å–®

        // Market selection
        function selectMarket(market) {
            currentMarket = market;
            document.querySelectorAll('.market-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.market-btn[data-market="${market}"]`).classList.add('active');
            
            // Update placeholder
            const placeholder = market === 'twse' ? 'è¼¸å…¥ä¸Šå¸‚è‚¡ç¥¨ä»£è™Ÿ' : 'è¼¸å…¥ä¸Šæ«ƒè‚¡ç¥¨ä»£è™Ÿ';
            document.getElementById('stockCode').placeholder = placeholder;
        }

        // ===== è‡ªé¸è‚¡åŠŸèƒ½ =====
        
        // è¼‰å…¥è‡ªé¸è‚¡
        function loadWatchlist() {
            try {
                const saved = localStorage.getItem('twstock_watchlist');
                if (saved) {
                    watchlist = JSON.parse(saved);
                }
            } catch (e) {
                watchlist = [];
            }
            renderWatchlistTags();
        }

        // å„²å­˜è‡ªé¸è‚¡
        function saveWatchlist() {
            localStorage.setItem('twstock_watchlist', JSON.stringify(watchlist));
        }

        // æ¸²æŸ“è‡ªé¸è‚¡æ¨™ç±¤
        function renderWatchlistTags() {
            const container = document.getElementById('watchlistTags');
            
            if (watchlist.length === 0) {
                container.innerHTML = '<div class="watchlist-empty">å°šæœªæ·»åŠ è‡ªé¸è‚¡ï¼Œè«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿå¾Œé»æ“Šã€ŒåŠ å…¥è‡ªé¸ã€</div>';
                return;
            }
            
            container.innerHTML = watchlist.map((item, index) => `
                <div class="watchlist-tag" onclick="analyzeFromWatchlist('${item.code}', '${item.market}')">
                    <span class="tag-name">${item.name || ''}</span>
                    <span class="tag-code">${item.code}</span>
                    <span class="tag-market ${item.market === 'tpex' ? 'tpex' : ''}">${item.market === 'twse' ? 'ä¸Šå¸‚' : 'ä¸Šæ«ƒ'}</span>
                    <span class="tag-remove" onclick="event.stopPropagation(); removeFromWatchlist(${index})">âœ•</span>
                </div>
            `).join('');
        }

        // å¾ä¸»åˆ†æå€åŠ å…¥è‡ªé¸è‚¡
        function addToWatchlist() {
            const code = document.getElementById('stockCode').value.trim();
            if (!code) {
                alert('è«‹å…ˆè¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }
            
            addStockToWatchlist(code, currentMarket);
        }

        // å¿«é€ŸåŠ å…¥è‡ªé¸è‚¡
        function quickAddWatchlist() {
            const code = document.getElementById('watchlistCode').value.trim();
            const market = document.getElementById('watchlistMarket').value;
            
            if (!code) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }
            
            addStockToWatchlist(code, market);
            document.getElementById('watchlistCode').value = '';
        }

        // æ·»åŠ è‚¡ç¥¨åˆ°è‡ªé¸è‚¡
        function addStockToWatchlist(code, market) {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = watchlist.some(item => item.code === code && item.market === market);
            if (exists) {
                alert(`${code} å·²åœ¨è‡ªé¸è‚¡ä¸­`);
                return;
            }
            
            watchlist.push({ code, market, name: '' });
            saveWatchlist();
            renderWatchlistTags();
            
            // é¡¯ç¤ºæç¤º
            showToast(`âœ… ${code} å·²åŠ å…¥è‡ªé¸è‚¡`);
        }

        // å¾è‡ªé¸è‚¡ç§»é™¤
        function removeFromWatchlist(index) {
            const removed = watchlist[index];
            watchlist.splice(index, 1);
            saveWatchlist();
            renderWatchlistTags();
            showToast(`ğŸ—‘ï¸ ${removed.code} å·²ç§»é™¤`);
            
            // å¦‚æœè¡¨æ ¼æœ‰é¡¯ç¤ºï¼Œé‡æ–°æ•´ç†
            if (document.getElementById('watchlistTableContainer').style.display !== 'none') {
                fetchAllWatchlist();
            }
        }

        // æ¸…ç©ºè‡ªé¸è‚¡
        function clearWatchlist() {
            if (watchlist.length === 0) return;
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è‡ªé¸è‚¡å—ï¼Ÿ')) {
                watchlist = [];
                saveWatchlist();
                renderWatchlistTags();
                document.getElementById('watchlistTableContainer').style.display = 'none';
                showToast('ğŸ—‘ï¸ å·²æ¸…ç©ºè‡ªé¸è‚¡');
            }
        }

        // å¾è‡ªé¸è‚¡é€²è¡Œåˆ†æ
        function analyzeFromWatchlist(code, market) {
            document.getElementById('stockCode').value = code;
            selectMarket(market);
            startAnalysis();
        }

        // æ‰¹é‡æ›´æ–°è‡ªé¸è‚¡å ±åƒ¹
        async function fetchAllWatchlist() {
            if (watchlist.length === 0) {
                alert('è«‹å…ˆæ·»åŠ è‡ªé¸è‚¡');
                return;
            }
            
            document.getElementById('watchlistLoading').style.display = 'flex';
            document.getElementById('watchlistTableContainer').style.display = 'none';
            
            const results = [];
            
            for (const item of watchlist) {
                try {
                    const data = await fetchLatestQuote(item.code, item.market);
                    if (data) {
                        results.push({
                            ...item,
                            ...data
                        });
                    } else {
                        results.push({
                            ...item,
                            name: item.name || item.code,
                            price: '--',
                            change: '--',
                            changePercent: '--',
                            volume: '--',
                            error: true
                        });
                    }
                } catch (e) {
                    results.push({
                        ...item,
                        name: item.name || item.code,
                        price: '--',
                        change: '--',
                        changePercent: '--',
                        volume: '--',
                        error: true
                    });
                }
                
                // çŸ­æš«å»¶é²
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            renderWatchlistTable(results);
            renderWatchlistTags(); // é‡æ–°æ¸²æŸ“æ¨™ç±¤ä»¥æ›´æ–°åç¨±
            document.getElementById('watchlistLoading').style.display = 'none';
            document.getElementById('watchlistTableContainer').style.display = 'block';
        }

        // ç²å–å–®ä¸€è‚¡ç¥¨æœ€æ–°å ±åƒ¹ - ä½¿ç”¨å®˜æ–¹å³æ™‚å ±åƒ¹ API
        async function fetchLatestQuote(code, market) {
            try {
                // ä½¿ç”¨è­‰äº¤æ‰€å³æ™‚å ±åƒ¹ API
                // ä¸Šå¸‚: tse_ä»£è™Ÿ.tw, ä¸Šæ«ƒ: otc_ä»£è™Ÿ.tw
                const exch = market === 'tpex' ? 'otc' : 'tse';
                const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${exch}_${code}.tw&json=1&delay=0`;
                
                const data = await fetchWithProxy(url);
                
                if (data && data.msgArray && data.msgArray.length > 0) {
                    const stock = data.msgArray[0];
                    
                    // è§£ææ•¸æ“š
                    // z: æˆäº¤åƒ¹ï¼ˆå¯èƒ½æ˜¯ "-" è¡¨ç¤ºç„¡æˆäº¤ï¼‰
                    // y: æ˜¨æ”¶, n: è‚¡ç¥¨åç¨±, c: è‚¡ç¥¨ä»£è™Ÿ
                    // v: æˆäº¤é‡(å¼µ), o: é–‹ç›¤, h: æœ€é«˜, l: æœ€ä½
                    // pz: è©¦æ’®åƒ¹
                    
                    const name = stock.n || code;
                    const prevClose = parseFloat(stock.y) || 0;
                    
                    // æˆäº¤åƒ¹ï¼šå„ªå…ˆç”¨ zï¼Œè‹¥ç„¡å‰‡ç”¨è©¦æ’®åƒ¹ pzï¼Œå†ç„¡å‰‡ç”¨æ˜¨æ”¶
                    let currentPrice = 0;
                    if (stock.z && stock.z !== '-') {
                        currentPrice = parseFloat(stock.z);
                    } else if (stock.pz && stock.pz !== '-') {
                        currentPrice = parseFloat(stock.pz);
                    } else {
                        currentPrice = prevClose; // ç„¡æˆäº¤æ™‚é¡¯ç¤ºæ˜¨æ”¶
                    }
                    
                    // æˆäº¤é‡ï¼ˆå¼µï¼‰
                    const volumeInLots = parseInt(stock.v) || 0;
                    
                    if (prevClose > 0) {
                        const change = currentPrice - prevClose;
                        const changePercent = (change / prevClose) * 100;
                        
                        // æ›´æ–° watchlist ä¸­çš„åç¨±
                        const idx = watchlist.findIndex(w => w.code === code && w.market === market);
                        if (idx !== -1) {
                            watchlist[idx].name = name;
                            saveWatchlist();
                        }
                        
                        return {
                            name: name,
                            price: currentPrice,
                            change: change,
                            changePercent: changePercent,
                            volume: volumeInLots, // ä¿æŒã€Œå¼µã€ç‚ºå–®ä½
                            prevClose: prevClose,
                            hasTraded: stock.z && stock.z !== '-'
                        };
                    }
                }
                
                // å¦‚æœå®˜æ–¹ API å¤±æ•—ï¼Œå˜—è©¦ Yahoo Finance ä½œç‚ºå‚™ç”¨
                return await fetchLatestQuoteYahoo(code, market);
                
            } catch (e) {
                console.log(`Error fetching quote for ${code}:`, e);
                // å˜—è©¦å‚™ç”¨ä¾†æº
                return await fetchLatestQuoteYahoo(code, market);
            }
        }
        
        // Yahoo Finance å‚™ç”¨å ±åƒ¹
        async function fetchLatestQuoteYahoo(code, market) {
            try {
                const symbol = market === 'tpex' ? `${code}.TWO` : `${code}.TW`;
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=5d`;
                
                const data = await fetchWithProxy(url);
                
                if (data && data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    const quotes = result.indicators.quote[0];
                    const len = quotes.close.length;
                    
                    let lastIndex = len - 1;
                    while (lastIndex >= 0 && (quotes.close[lastIndex] === null || isNaN(quotes.close[lastIndex]))) {
                        lastIndex--;
                    }
                    
                    if (lastIndex < 0) return null;
                    
                    const currentPrice = quotes.close[lastIndex];
                    const prevClose = meta.chartPreviousClose || meta.previousClose || currentPrice;
                    const change = currentPrice - prevClose;
                    const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;
                    const volume = Math.round((quotes.volume[lastIndex] || 0) / 1000); // è½‰æˆå¼µ
                    
                    return {
                        name: code, // Yahoo ç„¡æ³•å–å¾—ä¸­æ–‡å
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        volume: volume,
                        prevClose: prevClose,
                        hasTraded: true
                    };
                }
            } catch (e) {
                console.log(`Yahoo Finance fallback failed for ${code}:`, e);
            }
            return null;
        }

        // æ¸²æŸ“è‡ªé¸è‚¡è¡¨æ ¼
        function renderWatchlistTable(results) {
            const tbody = document.getElementById('watchlistBody');
            
            tbody.innerHTML = results.map(item => {
                const isUp = item.change > 0;
                const isDown = item.change < 0;
                const priceClass = item.error ? '' : (isUp ? 'price-up' : (isDown ? 'price-down' : 'price-flat'));
                const changeSymbol = isUp ? '+' : '';
                
                const priceDisplay = item.error ? '--' : parseFloat(item.price).toFixed(2);
                const prevCloseDisplay = item.error || !item.prevClose ? '--' : parseFloat(item.prevClose).toFixed(2);
                const changeDisplay = item.error ? '--' : `${changeSymbol}${parseFloat(item.change).toFixed(2)}`;
                const percentDisplay = item.error ? '--' : `${changeSymbol}${parseFloat(item.changePercent).toFixed(2)}%`;
                const volumeDisplay = item.error ? '--' : formatVolume(item.volume);
                
                return `
                    <tr>
                        <td>
                            <div class="stock-name">${item.name || item.code}</div>
                            <div class="stock-code">${item.code}</div>
                        </td>
                        <td>
                            <span class="tag-market ${item.market === 'tpex' ? 'tpex' : ''}">${item.market === 'twse' ? 'ä¸Šå¸‚' : 'ä¸Šæ«ƒ'}</span>
                        </td>
                        <td class="${priceClass}">${priceDisplay}</td>
                        <td class="price-flat">${prevCloseDisplay}</td>
                        <td class="${priceClass}">${changeDisplay}</td>
                        <td class="${priceClass}">${percentDisplay}</td>
                        <td>${volumeDisplay}</td>
                        <td>
                            <a class="analyze-link" onclick="analyzeFromWatchlist('${item.code}', '${item.market}')">ğŸ“Š åˆ†æ</a>
                            <button class="remove-btn" onclick="removeFromWatchlistByCode('${item.code}', '${item.market}')">âœ•</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ ¹æ“šä»£è™Ÿç§»é™¤è‡ªé¸è‚¡
        function removeFromWatchlistByCode(code, market) {
            const index = watchlist.findIndex(w => w.code === code && w.market === market);
            if (index !== -1) {
                removeFromWatchlist(index);
            }
        }

        // æ ¼å¼åŒ–æˆäº¤é‡ï¼ˆä»¥å¼µç‚ºå–®ä½ï¼‰
        function formatVolume(volume) {
            if (volume >= 10000) {
                return (volume / 10000).toFixed(2) + 'è¬å¼µ';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'åƒå¼µ';
            }
            return volume.toLocaleString() + 'å¼µ';
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message) {
            // å‰µå»º toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-card);
                color: var(--text-primary);
                padding: 12px 24px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: toastIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Proxy URL for CORS - with fallback options
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?'
        ];
        let currentProxyIndex = 0;

        async function fetchWithTimeout(url, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, { 
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                    }
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        async function fetchWithProxy(url) {
            // å˜—è©¦å„å€‹ä»£ç†
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxyIndex = (currentProxyIndex + i) % CORS_PROXIES.length;
                const proxy = CORS_PROXIES[proxyIndex];
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    const response = await fetchWithTimeout(proxyUrl, 8000);
                    if (response.ok) {
                        const text = await response.text();
                        if (text && text.trim()) {
                            try {
                                const data = JSON.parse(text);
                                currentProxyIndex = proxyIndex;
                                return data;
                            } catch {
                                return { raw: text };
                            }
                        }
                    }
                } catch (e) {
                    console.log(`Proxy ${proxyIndex} failed:`, e.message);
                }
            }
            
            return { stat: 'ERROR', data: null };
        }

        // Initialize dates and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            loadWatchlist(); // è¼‰å…¥è‡ªé¸è‚¡
            
            document.getElementById('stockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startAnalysis();
            });
            
            document.getElementById('watchlistCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') quickAddWatchlist();
            });
            
            document.getElementById('startDate').addEventListener('change', updateDateInfo);
            document.getElementById('endDate').addEventListener('change', updateDateInfo);
        });

        function initializeDates() {
            const today = new Date();
            const sixtyDaysAgo = new Date(today);
            sixtyDaysAgo.setDate(today.getDate() - 60);
            
            // Format dates for input
            document.getElementById('endDate').value = formatDateForInput(today);
            document.getElementById('startDate').value = formatDateForInput(sixtyDaysAgo);
            
            // Set max date to today
            document.getElementById('endDate').max = formatDateForInput(today);
            document.getElementById('startDate').max = formatDateForInput(today);
            
            updateDateInfo();
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateDateInfo() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                document.getElementById('dateInfo').innerHTML = 
                    `ğŸ“… åˆ†ææœŸé–“ï¼š<span>${document.getElementById('startDate').value}</span> è‡³ <span>${document.getElementById('endDate').value}</span>ï¼ˆç´„ <span>${diffDays}</span> å¤©ï¼‰`;
            }
        }

        function setDateRange(days) {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - days);
            
            document.getElementById('endDate').value = formatDateForInput(today);
            document.getElementById('startDate').value = formatDateForInput(startDate);
            
            // Update active button
            document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateDateInfo();
        }

        async function startAnalysis() {
            const stockCode = document.getElementById('stockCode').value.trim();
            if (!stockCode) {
                showError('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }

            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            
            if (!startDateStr || !endDateStr) {
                showError('è«‹é¸æ“‡èµ·è¨–æ—¥æœŸ');
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            if (startDate >= endDate) {
                showError('èµ·å§‹æ—¥å¿…é ˆæ—©æ–¼çµ‚æ­¢æ—¥');
                return;
            }

            if (endDate > today) {
                showError('çµ‚æ­¢æ—¥ä¸èƒ½è¶…éä»Šå¤©');
                return;
            }

            currentStockCode = stockCode;
            
            // Reset UI
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;

            try {
                // Fetch stock data
                const marketName = currentMarket === 'twse' ? 'ä¸Šå¸‚' : 'ä¸Šæ«ƒ';
                updateLoadingText(`æ­£åœ¨ç²å–${marketName}è‚¡ç¥¨äº¤æ˜“æ•¸æ“š...`);
                await fetchStockData(stockCode);

                if (stockData.length === 0) {
                    throw new Error('ç„¡æ³•ç²å–è‚¡ç¥¨æ•¸æ“šï¼Œè«‹ç¢ºèªè‚¡ç¥¨ä»£è™ŸåŠå¸‚å ´é¡å‹æ˜¯å¦æ­£ç¢º');
                }

                // Fetch institutional data
                updateLoadingText(`æ­£åœ¨ç²å–${marketName}ä¸‰å¤§æ³•äººæ•¸æ“š...`);
                await fetchInstitutionalData(stockCode);

                // Calculate technical indicators
                updateLoadingText('æ­£åœ¨è¨ˆç®—æŠ€è¡“æŒ‡æ¨™...');
                calculateAllIndicators();

                // Update UI
                updateLoadingText('æ­£åœ¨ç”Ÿæˆåˆ†æå ±å‘Š...');
                updateUI();

                // Show results
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.add('active');

            } catch (error) {
                console.error('Analysis error:', error);
                showError(error.message || 'åˆ†æéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showError(message) {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        async function fetchStockData(stockCode) {
            stockData = [];
            
            if (currentMarket === 'twse') {
                await fetchTWSEData(stockCode);
                // å¦‚æœ TWSE æ²’è³‡æ–™ï¼Œå˜—è©¦ Yahoo Finance
                if (stockData.length === 0) {
                    console.log('TWSE API failed, trying Yahoo Finance...');
                    await fetchYahooFinanceData(stockCode, 'TW');
                    processStockData(stockCode, stockData.length > 0 ? 1 : 0, 'ä¸Šå¸‚');
                }
            } else {
                await fetchTPExData(stockCode);
            }
        }

        // ä¸Šå¸‚è‚¡ç¥¨è³‡æ–™ (TWSE)
        async function fetchTWSEData(stockCode) {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // Calculate all months to fetch (including buffer for MA calculations)
            const monthsToFetch = [];
            
            // Start from 2 months before the start date (for MA20 calculations)
            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth() - 2, 1);
            const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
            
            while (currentMonth <= endMonth) {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth() + 1;
                const dateStr = `${year}${String(month).padStart(2, '0')}01`;
                monthsToFetch.push(dateStr);
                
                // Move to next month
                currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            }
            
            console.log('TWSE Months to fetch:', monthsToFetch);
            
            let fetchedCount = 0;
            for (const dateStr of monthsToFetch) {
                try {
                    updateLoadingText(`æ­£åœ¨ç²å–ä¸Šå¸‚ ${dateStr.substring(0, 4)}/${dateStr.substring(4, 6)} æœˆä»½è³‡æ–™...`);
                    
                    const url = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${stockCode}`;
                    const data = await fetchWithProxy(url);
                    
                    if (data.stat === 'OK' && data.data && data.data.length > 0) {
                        stockName = data.title ? data.title.split(' ')[2] || stockCode : stockCode;
                        fetchedCount++;
                        
                        data.data.forEach(row => {
                            const rocDate = row[0];
                            const [rocYear, month, day] = rocDate.split('/');
                            const year = parseInt(rocYear) + 1911;
                            const dateString = `${year}/${month}/${day}`;
                            const rowDate = new Date(year, parseInt(month) - 1, parseInt(day));
                            
                            stockData.push({
                                date: dateString,
                                dateObj: rowDate,
                                volume: parseInt(row[1].replace(/,/g, '')),
                                turnover: parseInt(row[2].replace(/,/g, '')),
                                open: parseFloat(row[3].replace(/,/g, '')),
                                high: parseFloat(row[4].replace(/,/g, '')),
                                low: parseFloat(row[5].replace(/,/g, '')),
                                close: parseFloat(row[6].replace(/,/g, '')),
                                change: row[7],
                                transactions: parseInt(row[8].replace(/,/g, ''))
                            });
                        });
                    } else {
                        console.log(`No TWSE data for ${dateStr}:`, data.stat);
                    }
                } catch (e) {
                    console.log(`Error fetching TWSE data for ${dateStr}:`, e);
                }
                
                await new Promise(resolve => setTimeout(resolve, 350));
            }

            processStockData(stockCode, fetchedCount, 'ä¸Šå¸‚');
        }

        // ä¸Šæ«ƒè‚¡ç¥¨è³‡æ–™ (TPEx) - å„ªå…ˆä½¿ç”¨ Yahoo Finance
        async function fetchTPExData(stockCode) {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // ç›´æ¥ä½¿ç”¨ Yahoo Finance ç²å–ä¸Šæ«ƒè³‡æ–™ï¼ˆæ›´ç©©å®šï¼‰
            updateLoadingText('æ­£åœ¨ç²å–ä¸Šæ«ƒè‚¡ç¥¨è³‡æ–™...');
            await fetchYahooFinanceData(stockCode, 'TWO');
            
            // å¦‚æœ Yahoo Finance å¤±æ•—ï¼Œå˜—è©¦ TPEx å®˜æ–¹ API
            if (stockData.length === 0) {
                console.log('Yahoo Finance failed, trying TPEx API...');
                await fetchTPExOfficialData(stockCode, startDate, endDate);
            }

            processStockData(stockCode, stockData.length > 0 ? 1 : 0, 'ä¸Šæ«ƒ');
        }
        
        // TPEx å®˜æ–¹ API æŠ“å–
        async function fetchTPExOfficialData(stockCode, startDate, endDate) {
            const monthsToFetch = [];
            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth() - 2, 1);
            const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
            
            while (currentMonth <= endMonth) {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth() + 1;
                const rocYear = year - 1911;
                monthsToFetch.push({ rocYear, year, month });
                currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            }
            
            for (const { rocYear, year, month } of monthsToFetch) {
                try {
                    updateLoadingText(`æ­£åœ¨ç²å–ä¸Šæ«ƒ ${year}/${String(month).padStart(2, '0')} è³‡æ–™...`);
                    
                    const dateStr = `${rocYear}/${String(month).padStart(2, '0')}`;
                    const url = `https://www.tpex.org.tw/web/stock/aftertrading/daily_trading_info/st43_result.php?l=zh-tw&d=${dateStr}&stkno=${stockCode}`;
                    
                    const data = await fetchWithProxy(url);
                    
                    if (data && data.aaData && data.aaData.length > 0) {
                        if (!stockName || stockName === stockCode) {
                            stockName = data.stkName || stockCode;
                        }
                        
                        data.aaData.forEach(row => {
                            try {
                                const rocDate = row[0];
                                if (!rocDate || !rocDate.includes('/')) return;
                                
                                const [y, m, d] = rocDate.split('/');
                                const fullYear = parseInt(y) + 1911;
                                const dateString = `${fullYear}/${m}/${d}`;
                                const rowDate = new Date(fullYear, parseInt(m) - 1, parseInt(d));
                                
                                const parseNum = (val) => {
                                    if (!val || val === '--' || val === '-') return NaN;
                                    return parseFloat(String(val).replace(/,/g, ''));
                                };
                                
                                const volume = parseNum(row[1]) * 1000;
                                const open = parseNum(row[2]);
                                const high = parseNum(row[3]);
                                const low = parseNum(row[4]);
                                const close = parseNum(row[5]);
                                
                                if (!isNaN(close) && close > 0) {
                                    stockData.push({
                                        date: dateString,
                                        dateObj: rowDate,
                                        volume: isNaN(volume) ? 0 : volume,
                                        turnover: 0,
                                        open: isNaN(open) ? close : open,
                                        high: isNaN(high) ? close : high,
                                        low: isNaN(low) ? close : low,
                                        close: close,
                                        change: row[6] || '-',
                                        transactions: parseNum(row[7]) || 0
                                    });
                                }
                            } catch (e) {
                                // Skip invalid row
                            }
                        });
                    }
                } catch (e) {
                    console.log(`TPEx fetch error for ${year}/${month}:`, e.message);
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }
        
        // ä½¿ç”¨ Yahoo Finance ç²å–è³‡æ–™ï¼ˆæ”¯æ´ä¸Šå¸‚å’Œä¸Šæ«ƒï¼‰
        async function fetchYahooFinanceData(stockCode, market) {
            try {
                const symbol = market === 'TWO' ? `${stockCode}.TWO` : `${stockCode}.TW`;
                const endTimestamp = Math.floor(new Date(document.getElementById('endDate').value).getTime() / 1000) + 86400;
                const startTimestamp = Math.floor(new Date(document.getElementById('startDate').value).getTime() / 1000) - (86400 * 45);
                
                // ä½¿ç”¨ Yahoo Finance API
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${startTimestamp}&period2=${endTimestamp}&interval=1d&includePrePost=false`;
                
                console.log('Fetching Yahoo Finance:', symbol);
                
                const data = await fetchWithProxy(url);
                
                if (data && data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const quotes = result.indicators.quote[0];
                    const meta = result.meta;
                    
                    if (!stockName || stockName === stockCode) {
                        stockName = meta.shortName || meta.longName || stockCode;
                        // æ¸…ç†è‚¡ç¥¨åç¨±
                        if (stockName.includes(stockCode)) {
                            stockName = stockName.replace(stockCode, '').trim();
                        }
                    }
                    
                    if (timestamps && quotes && timestamps.length > 0) {
                        for (let i = 0; i < timestamps.length; i++) {
                            const date = new Date(timestamps[i] * 1000);
                            const dateString = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                            
                            const close = quotes.close[i];
                            const open = quotes.open[i];
                            const high = quotes.high[i];
                            const low = quotes.low[i];
                            const volume = quotes.volume[i];
                            
                            if (close && !isNaN(close) && close > 0) {
                                stockData.push({
                                    date: dateString,
                                    dateObj: date,
                                    volume: volume || 0,
                                    turnover: 0,
                                    open: open || close,
                                    high: high || close,
                                    low: low || close,
                                    close: close,
                                    change: '-',
                                    transactions: 0
                                });
                            }
                        }
                        console.log(`Yahoo Finance: fetched ${stockData.length} records for ${symbol}`);
                    }
                } else if (data && data.chart && data.chart.error) {
                    console.log('Yahoo Finance error:', data.chart.error.description);
                }
            } catch (e) {
                console.log('Yahoo Finance fetch failed:', e.message);
            }
        }

        // è™•ç†è‚¡ç¥¨è³‡æ–™
        function processStockData(stockCode, fetchedCount, marketType) {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            // Sort by date
            stockData.sort((a, b) => a.dateObj - b.dateObj);
            
            // Remove duplicates based on date
            stockData = stockData.filter((item, index, self) =>
                index === self.findIndex((t) => t.date === item.date)
            );
            
            // Filter to only include data within the selected range (keep buffer data for calculation)
            const bufferStartDate = new Date(startDate);
            bufferStartDate.setDate(bufferStartDate.getDate() - 35); // Buffer for MA20 + KD9
            
            stockData = stockData.filter(item => 
                item.dateObj >= bufferStartDate && item.dateObj <= endDate
            );
            
            console.log(`Fetched ${fetchedCount} months, ${stockData.length} trading days`);
            
            if (stockData.length === 0) {
                const startDateDisplay = document.getElementById('startDate').value;
                const endDateDisplay = document.getElementById('endDate').value;
                throw new Error(`ç„¡æ³•ç²å–${marketType}è‚¡ç¥¨ ${stockCode} åœ¨ ${startDateDisplay} è‡³ ${endDateDisplay} æœŸé–“çš„äº¤æ˜“è³‡æ–™ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. è‚¡ç¥¨ä»£è™Ÿä¸æ­£ç¢º\n2. è‚¡ç¥¨å¸‚å ´é¸æ“‡éŒ¯èª¤ï¼ˆè«‹ç¢ºèªæ˜¯ä¸Šå¸‚æˆ–ä¸Šæ«ƒï¼‰\n3. é¸æ“‡çš„æ—¥æœŸç¯„åœå…§ç„¡äº¤æ˜“æ—¥\n4. è³‡æ–™å°šæœªæ›´æ–°ï¼ˆç´„ 18:00 å¾Œæ›´æ–°ï¼‰`);
            }
            
            if (stockData.length < 20) {
                console.warn('Warning: Less than 20 trading days, some indicators may not be accurate');
            }
        }

        async function fetchInstitutionalData(stockCode) {
            institutionalData = {
                foreign: 0,
                investment: 0,
                dealer: 0
            };

            try {
                const today = new Date();
                
                if (currentMarket === 'twse') {
                    // ä¸Šå¸‚è‚¡ç¥¨ä¸‰å¤§æ³•äºº
                    const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                    const url = `https://www.twse.com.tw/rwd/zh/fund/T86?date=${dateStr}&selectType=ALLBUT0999&response=json`;
                    const data = await fetchWithProxy(url);
                    
                    if (data.stat === 'OK' && data.data) {
                        const stockRow = data.data.find(row => row[0].trim() === stockCode);
                        if (stockRow) {
                            institutionalData.foreign = parseInt(stockRow[4].replace(/,/g, '')) || 0;
                            institutionalData.investment = parseInt(stockRow[10].replace(/,/g, '')) || 0;
                            institutionalData.dealer = parseInt(stockRow[11].replace(/,/g, '')) || 0;
                        }
                    }
                } else {
                    // ä¸Šæ«ƒè‚¡ç¥¨ä¸‰å¤§æ³•äºº
                    const rocYear = today.getFullYear() - 1911;
                    const dateStr = `${rocYear}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
                    const url = `https://www.tpex.org.tw/web/stock/3insti/daily_trade/3itrade_hedge_result.php?l=zh-tw&d=${dateStr}&se=EW&t=D`;
                    const data = await fetchWithProxy(url);
                    
                    if (data && data.aaData) {
                        const stockRow = data.aaData.find(row => row[0].trim() === stockCode);
                        if (stockRow) {
                            // TPEx format: [ä»£è™Ÿ, åç¨±, å¤–è³‡è²·, å¤–è³‡è³£, å¤–è³‡æ·¨, æŠ•ä¿¡è²·, æŠ•ä¿¡è³£, æŠ•ä¿¡æ·¨, è‡ªç‡Ÿè²·, è‡ªç‡Ÿè³£, è‡ªç‡Ÿæ·¨, ä¸‰å¤§æ³•äººæ·¨]
                            institutionalData.foreign = parseInt(stockRow[4].replace(/,/g, '')) || 0;
                            institutionalData.investment = parseInt(stockRow[7].replace(/,/g, '')) || 0;
                            institutionalData.dealer = parseInt(stockRow[10].replace(/,/g, '')) || 0;
                        }
                    }
                }
            } catch (e) {
                console.log('Error fetching institutional data:', e);
            }
        }

        function calculateAllIndicators() {
            const closes = stockData.map(d => d.close);
            const highs = stockData.map(d => d.high);
            const lows = stockData.map(d => d.low);
            const volumes = stockData.map(d => d.volume);

            // Calculate Moving Averages
            technicalIndicators.ma5 = calculateMA(closes, 5);
            technicalIndicators.ma10 = calculateMA(closes, 10);
            technicalIndicators.ma20 = calculateMA(closes, 20);

            // Calculate RSI
            technicalIndicators.rsi = calculateRSI(closes, 14);

            // Calculate KD
            const kd = calculateKD(highs, lows, closes, 9);
            technicalIndicators.k = kd.k;
            technicalIndicators.d = kd.d;

            // Calculate MACD
            const macd = calculateMACD(closes);
            technicalIndicators.dif = macd.dif;
            technicalIndicators.macd = macd.macd;
            technicalIndicators.osc = macd.osc;

            // Calculate Bollinger Bands
            technicalIndicators.bollinger = calculateBollinger(closes, 20);

            // Now filter stockData to only show selected date range (remove buffer data)
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            // Find the index range for the selected dates
            let startIdx = 0;
            let endIdx = stockData.length - 1;
            
            for (let i = 0; i < stockData.length; i++) {
                if (stockData[i].dateObj >= startDate) {
                    startIdx = i;
                    break;
                }
            }
            
            for (let i = stockData.length - 1; i >= 0; i--) {
                if (stockData[i].dateObj <= endDate) {
                    endIdx = i;
                    break;
                }
            }
            
            // Slice all data to selected range
            stockData = stockData.slice(startIdx, endIdx + 1);
            technicalIndicators.ma5 = technicalIndicators.ma5.slice(startIdx, endIdx + 1);
            technicalIndicators.ma10 = technicalIndicators.ma10.slice(startIdx, endIdx + 1);
            technicalIndicators.ma20 = technicalIndicators.ma20.slice(startIdx, endIdx + 1);
            technicalIndicators.rsi = technicalIndicators.rsi.slice(startIdx, endIdx + 1);
            technicalIndicators.k = technicalIndicators.k.slice(startIdx, endIdx + 1);
            technicalIndicators.d = technicalIndicators.d.slice(startIdx, endIdx + 1);
            technicalIndicators.dif = technicalIndicators.dif.slice(startIdx, endIdx + 1);
            technicalIndicators.macd = technicalIndicators.macd.slice(startIdx, endIdx + 1);
            technicalIndicators.osc = technicalIndicators.osc.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.upper = technicalIndicators.bollinger.upper.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.middle = technicalIndicators.bollinger.middle.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.lower = technicalIndicators.bollinger.lower.slice(startIdx, endIdx + 1);

            // Recalculate volume analysis with filtered data
            const filteredVolumes = stockData.map(d => d.volume);
            const last20Volumes = filteredVolumes.slice(-Math.min(20, filteredVolumes.length));
            technicalIndicators.avgVolume = last20Volumes.reduce((a, b) => a + b, 0) / last20Volumes.length;
            technicalIndicators.volumeRatio = filteredVolumes[filteredVolumes.length - 1] / technicalIndicators.avgVolume;

            // Support and Resistance (last 20 days of filtered data)
            const recentHighs = highs.slice(startIdx, endIdx + 1).slice(-20);
            const recentLows = lows.slice(startIdx, endIdx + 1).slice(-20);
            technicalIndicators.resistance = Math.max(...recentHighs);
            technicalIndicators.support = Math.min(...recentLows);

            // Generate alerts
            technicalIndicators.alerts = generateAlerts();
        }

        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / period);
                }
            }
            return result;
        }

        function calculateRSI(data, period) {
            const result = [];
            let gains = [];
            let losses = [];

            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    result.push(null);
                    continue;
                }

                const change = data[i] - data[i - 1];
                const gain = change > 0 ? change : 0;
                const loss = change < 0 ? -change : 0;

                gains.push(gain);
                losses.push(loss);

                if (i < period) {
                    result.push(null);
                } else {
                    const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
                    const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
                    
                    if (avgLoss === 0) {
                        result.push(100);
                    } else {
                        const rs = avgGain / avgLoss;
                        result.push(100 - (100 / (1 + rs)));
                    }
                }
            }
            return result;
        }

        function calculateKD(highs, lows, closes, period) {
            const k = [];
            const d = [];
            let prevK = 50;
            let prevD = 50;

            for (let i = 0; i < closes.length; i++) {
                if (i < period - 1) {
                    k.push(null);
                    d.push(null);
                    continue;
                }

                const highN = Math.max(...highs.slice(i - period + 1, i + 1));
                const lowN = Math.min(...lows.slice(i - period + 1, i + 1));
                
                const rsv = highN === lowN ? 50 : ((closes[i] - lowN) / (highN - lowN)) * 100;
                
                const currentK = (2/3) * prevK + (1/3) * rsv;
                const currentD = (2/3) * prevD + (1/3) * currentK;
                
                k.push(currentK);
                d.push(currentD);
                
                prevK = currentK;
                prevD = currentD;
            }

            return { k, d };
        }

        function calculateMACD(data) {
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            
            const dif = [];
            for (let i = 0; i < data.length; i++) {
                if (ema12[i] === null || ema26[i] === null) {
                    dif.push(null);
                } else {
                    dif.push(ema12[i] - ema26[i]);
                }
            }

            const macd = calculateEMA(dif.filter(d => d !== null), 9);
            const paddedMacd = Array(data.length - macd.length).fill(null).concat(macd);

            const osc = [];
            for (let i = 0; i < data.length; i++) {
                if (dif[i] === null || paddedMacd[i] === null) {
                    osc.push(null);
                } else {
                    osc.push((dif[i] - paddedMacd[i]) * 2);
                }
            }

            return { dif, macd: paddedMacd, osc };
        }

        function calculateEMA(data, period) {
            const result = [];
            const multiplier = 2 / (period + 1);
            
            const validData = data.filter(d => d !== null);
            if (validData.length < period) {
                return data.map(() => null);
            }

            let ema = validData.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            let validIndex = 0;
            for (let i = 0; i < data.length; i++) {
                if (data[i] === null) {
                    result.push(null);
                    continue;
                }
                
                if (validIndex < period - 1) {
                    result.push(null);
                } else if (validIndex === period - 1) {
                    result.push(ema);
                } else {
                    ema = (data[i] - ema) * multiplier + ema;
                    result.push(ema);
                }
                validIndex++;
            }
            
            return result;
        }

        function calculateBollinger(data, period) {
            const middle = calculateMA(data, period);
            const upper = [];
            const lower = [];

            for (let i = 0; i < data.length; i++) {
                if (middle[i] === null) {
                    upper.push(null);
                    lower.push(null);
                } else {
                    const slice = data.slice(i - period + 1, i + 1);
                    const std = Math.sqrt(slice.reduce((sum, val) => sum + Math.pow(val - middle[i], 2), 0) / period);
                    upper.push(middle[i] + 2 * std);
                    lower.push(middle[i] - 2 * std);
                }
            }

            return { upper, middle, lower };
        }

        function generateAlerts() {
            const alerts = [];
            const n = stockData.length - 1;
            const closes = stockData.map(d => d.close);
            
            // 1. MA Cross Analysis
            const ma5 = technicalIndicators.ma5;
            const ma10 = technicalIndicators.ma10;
            const ma20 = technicalIndicators.ma20;
            
            if (ma5[n] && ma20[n] && ma5[n-1] && ma20[n-1]) {
                // Golden Cross
                if (ma5[n] > ma20[n] && ma5[n-1] <= ma20[n-1]) {
                    alerts.push({
                        type: 'bullish',
                        priority: 1,
                        title: 'å‡ç·šé»ƒé‡‘äº¤å‰',
                        description: 'MA5 å¾ä¸‹æ–¹ç©¿è¶Š MA20ï¼Œä¸­æœŸè¶¨å‹¢å¯èƒ½è½‰å¤š'
                    });
                }
                // Death Cross
                if (ma5[n] < ma20[n] && ma5[n-1] >= ma20[n-1]) {
                    alerts.push({
                        type: 'bearish',
                        priority: 1,
                        title: 'å‡ç·šæ­»äº¡äº¤å‰',
                        description: 'MA5 å¾ä¸Šæ–¹è·Œç ´ MA20ï¼Œä¸­æœŸè¶¨å‹¢å¯èƒ½è½‰ç©º'
                    });
                }
            }

            // MA Arrangement
            if (ma5[n] && ma10[n] && ma20[n]) {
                if (ma5[n] > ma10[n] && ma10[n] > ma20[n]) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: 'å¤šé ­æ’åˆ—',
                        description: 'MA5 > MA10 > MA20ï¼Œå‡ç·šå‘ˆç¾å¤šé ­æ’åˆ—'
                    });
                } else if (ma5[n] < ma10[n] && ma10[n] < ma20[n]) {
                    alerts.push({
                        type: 'bearish',
                        priority: 2,
                        title: 'ç©ºé ­æ’åˆ—',
                        description: 'MA5 < MA10 < MA20ï¼Œå‡ç·šå‘ˆç¾ç©ºé ­æ’åˆ—'
                    });
                }
            }

            // 2. Support/Resistance Analysis
            const currentClose = closes[n];
            const resistance = technicalIndicators.resistance;
            const support = technicalIndicators.support;

            if (currentClose > resistance * 0.995 && closes[n-1] <= resistance * 0.995) {
                alerts.push({
                    type: 'bullish',
                    priority: 1,
                    title: 'çªç ´å£“åŠ›ä½',
                    description: `è‚¡åƒ¹çªç ´20æ—¥é«˜é» ${resistance.toFixed(2)} å…ƒ`
                });
            }
            if (currentClose < support * 1.005 && closes[n-1] >= support * 1.005) {
                alerts.push({
                    type: 'bearish',
                    priority: 1,
                    title: 'è·Œç ´æ”¯æ’ä½',
                    description: `è‚¡åƒ¹è·Œç ´20æ—¥ä½é» ${support.toFixed(2)} å…ƒ`
                });
            }
            if (currentClose >= resistance * 0.97 && currentClose < resistance) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: 'æ¥è¿‘å£“åŠ›ä½',
                    description: `è‚¡åƒ¹æ¥è¿‘20æ—¥é«˜é» ${resistance.toFixed(2)} å…ƒï¼Œç•™æ„çªç ´æˆ–å›æª”`
                });
            }
            if (currentClose <= support * 1.03 && currentClose > support) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: 'æ¥è¿‘æ”¯æ’ä½',
                    description: `è‚¡åƒ¹æ¥è¿‘20æ—¥ä½é» ${support.toFixed(2)} å…ƒï¼Œç•™æ„è·Œç ´æˆ–åå½ˆ`
                });
            }

            // 3. Volume Analysis
            const volumeRatio = technicalIndicators.volumeRatio;
            const change = currentClose - closes[n-1];

            if (volumeRatio >= 2) {
                if (change > 0) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: 'é‡å¢åƒ¹æ¼²',
                        description: `æˆäº¤é‡ç‚ºå¹³å‡é‡çš„ ${volumeRatio.toFixed(1)} å€ï¼Œé…åˆåƒ¹æ ¼ä¸Šæ¼²ï¼Œå¤šæ–¹å¼·å‹¢`
                    });
                } else {
                    alerts.push({
                        type: 'warning',
                        priority: 2,
                        title: 'é‡å¢åƒ¹è·Œ',
                        description: `æˆäº¤é‡ç‚ºå¹³å‡é‡çš„ ${volumeRatio.toFixed(1)} å€ï¼Œé…åˆåƒ¹æ ¼ä¸‹è·Œï¼Œç•™æ„è³£å£“`
                    });
                }
            } else if (volumeRatio < 0.5) {
                alerts.push({
                    type: 'neutral',
                    priority: 3,
                    title: 'æˆäº¤é‡èç¸®',
                    description: 'æˆäº¤é‡ä½æ–¼å¹³å‡é‡50%ï¼Œå¸‚å ´è§€æœ›æ°£æ°›æ¿ƒåš'
                });
            }

            // 4. KD Analysis
            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            const prevK = technicalIndicators.k[n-1];
            const prevD = technicalIndicators.d[n-1];

            if (k > 80 && d > 80) {
                alerts.push({
                    type: 'warning',
                    priority: 2,
                    title: 'KD è¶…è²·',
                    description: `K=${k.toFixed(1)}, D=${d.toFixed(1)}ï¼Œè‚¡åƒ¹å¯èƒ½é¢è‡¨å›æª”å£“åŠ›`
                });
            }
            if (k < 20 && d < 20) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'KD è¶…è³£',
                    description: `K=${k.toFixed(1)}, D=${d.toFixed(1)}ï¼Œè‚¡åƒ¹å¯èƒ½å‡ºç¾åå½ˆ`
                });
            }
            if (k > d && prevK <= prevD) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'KD é»ƒé‡‘äº¤å‰',
                    description: 'K å€¼å¾ä¸‹æ–¹ç©¿è¶Š D å€¼ï¼ŒçŸ­ç·šè²·é€²è¨Šè™Ÿ'
                });
            }
            if (k < d && prevK >= prevD) {
                alerts.push({
                    type: 'bearish',
                    priority: 2,
                    title: 'KD æ­»äº¡äº¤å‰',
                    description: 'K å€¼å¾ä¸Šæ–¹è·Œç ´ D å€¼ï¼ŒçŸ­ç·šè³£å‡ºè¨Šè™Ÿ'
                });
            }

            // 5. RSI Analysis
            const rsi = technicalIndicators.rsi[n];
            if (rsi > 80) {
                alerts.push({
                    type: 'warning',
                    priority: 2,
                    title: 'RSI è¶…è²·',
                    description: `RSI=${rsi.toFixed(1)}ï¼Œè‚¡åƒ¹å¯èƒ½éç†±`
                });
            }
            if (rsi < 20) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'RSI è¶…è³£',
                    description: `RSI=${rsi.toFixed(1)}ï¼Œè‚¡åƒ¹å¯èƒ½è¶…è·Œ`
                });
            }

            // 6. MACD Analysis
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            const prevDif = technicalIndicators.dif[n-1];
            const prevMacd = technicalIndicators.macd[n-1];
            const prevOsc = technicalIndicators.osc[n-1];

            if (dif && macd && prevDif && prevMacd) {
                if (dif > macd && prevDif <= prevMacd) {
                    alerts.push({
                        type: 'bullish',
                        priority: 1,
                        title: 'MACD é»ƒé‡‘äº¤å‰',
                        description: 'DIF å¾ä¸‹æ–¹ç©¿è¶Š MACDï¼Œä¸­æœŸè¶¨å‹¢å¯èƒ½è½‰å¤š'
                    });
                }
                if (dif < macd && prevDif >= prevMacd) {
                    alerts.push({
                        type: 'bearish',
                        priority: 1,
                        title: 'MACD æ­»äº¡äº¤å‰',
                        description: 'DIF å¾ä¸Šæ–¹è·Œç ´ MACDï¼Œä¸­æœŸè¶¨å‹¢å¯èƒ½è½‰ç©º'
                    });
                }
            }
            if (osc && prevOsc) {
                if (osc > 0 && prevOsc <= 0) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: 'æŸ±ç‹€é«”ç¿»æ­£',
                        description: 'MACD æŸ±ç‹€é«”ç”±è² è½‰æ­£ï¼Œå‹•èƒ½è½‰å¼·'
                    });
                }
                if (osc < 0 && prevOsc >= 0) {
                    alerts.push({
                        type: 'bearish',
                        priority: 2,
                        title: 'æŸ±ç‹€é«”ç¿»è² ',
                        description: 'MACD æŸ±ç‹€é«”ç”±æ­£è½‰è² ï¼Œå‹•èƒ½è½‰å¼±'
                    });
                }
            }

            // 7. Bollinger Bands
            const upper = technicalIndicators.bollinger.upper[n];
            const lower = technicalIndicators.bollinger.lower[n];

            if (currentClose >= upper) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: 'è§¸åŠå¸ƒæ—ä¸Šè»Œ',
                    description: 'è‚¡åƒ¹è§¸åŠå¸ƒæ—é€šé“ä¸Šè»Œï¼ŒçŸ­ç·šå¯èƒ½éç†±'
                });
            }
            if (currentClose <= lower) {
                alerts.push({
                    type: 'bullish',
                    priority: 3,
                    title: 'è§¸åŠå¸ƒæ—ä¸‹è»Œ',
                    description: 'è‚¡åƒ¹è§¸åŠå¸ƒæ—é€šé“ä¸‹è»Œï¼ŒçŸ­ç·šå¯èƒ½è¶…è·Œ'
                });
            }

            return alerts;
        }

        function updateUI() {
            const n = stockData.length - 1;
            const latestData = stockData[n];
            const prevData = stockData[n - 1];

            // Update stock header
            document.getElementById('stockName').textContent = stockName;
            document.getElementById('displayCode').textContent = currentStockCode;
            
            // Update market tag
            const marketTag = document.getElementById('marketTag');
            if (currentMarket === 'twse') {
                marketTag.textContent = 'ä¸Šå¸‚';
                marketTag.className = 'market-tag twse';
            } else {
                marketTag.textContent = 'ä¸Šæ«ƒ';
                marketTag.className = 'market-tag tpex';
            }
            
            const startDateDisplay = document.getElementById('startDate').value;
            const endDateDisplay = document.getElementById('endDate').value;
            document.getElementById('stockDate').textContent = `åˆ†ææœŸé–“ï¼š${startDateDisplay} è‡³ ${endDateDisplay}ï¼ˆå…± ${stockData.length} ç­†äº¤æ˜“æ—¥ï¼‰`;
            
            const priceElement = document.getElementById('currentPrice');
            const changeElement = document.getElementById('priceChange');
            
            priceElement.textContent = latestData.close.toFixed(2);
            
            const change = latestData.close - prevData.close;
            const changePercent = (change / prevData.close * 100);
            
            if (change >= 0) {
                priceElement.className = 'current-price price-up';
                changeElement.innerHTML = `<span style="color: var(--accent-up);">â–² ${change.toFixed(2)} (+${changePercent.toFixed(2)}%)</span>`;
            } else {
                priceElement.className = 'current-price price-down';
                changeElement.innerHTML = `<span style="color: var(--accent-down);">â–¼ ${Math.abs(change).toFixed(2)} (${changePercent.toFixed(2)}%)</span>`;
            }

            // Update overview cards
            const techScore = calculateTechScore();
            document.getElementById('techScore').textContent = techScore + '/100';
            document.getElementById('techProgress').style.width = techScore + '%';
            
            if (techScore >= 70) {
                document.getElementById('techProgress').style.background = 'var(--accent-up)';
            } else if (techScore >= 50) {
                document.getElementById('techProgress').style.background = 'var(--accent-yellow)';
            } else {
                document.getElementById('techProgress').style.background = 'var(--accent-down)';
            }

            const rsi = technicalIndicators.rsi[n];
            document.getElementById('rsiValue').textContent = rsi ? rsi.toFixed(1) : '-';
            document.getElementById('rsiStatus').textContent = rsi > 70 ? 'è¶…è²·å€' : rsi < 30 ? 'è¶…è³£å€' : 'ä¸­æ€§å€';

            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            document.getElementById('kdValue').textContent = k && d ? `${k.toFixed(1)}/${d.toFixed(1)}` : '-';
            document.getElementById('kdStatus').textContent = k > 80 ? 'è¶…è²·å€' : k < 20 ? 'è¶…è³£å€' : 'ä¸­æ€§å€';

            document.getElementById('volumeRatio').textContent = technicalIndicators.volumeRatio.toFixed(2) + 'x';
            document.getElementById('volumeStatus').textContent = technicalIndicators.volumeRatio >= 2 ? 'æ”¾é‡' : 
                technicalIndicators.volumeRatio < 0.5 ? 'èç¸®' : 'æ­£å¸¸';

            // Key levels
            document.getElementById('resistanceLevel').textContent = technicalIndicators.resistance.toFixed(2);
            document.getElementById('supportLevel').textContent = technicalIndicators.support.toFixed(2);
            document.getElementById('ma5Value').textContent = technicalIndicators.ma5[n] ? technicalIndicators.ma5[n].toFixed(2) : '-';
            document.getElementById('ma20Value').textContent = technicalIndicators.ma20[n] ? technicalIndicators.ma20[n].toFixed(2) : '-';

            const ma5 = technicalIndicators.ma5[n];
            const ma10 = technicalIndicators.ma10[n];
            const ma20 = technicalIndicators.ma20[n];
            if (ma5 > ma10 && ma10 > ma20) {
                document.getElementById('maStatus').textContent = 'ğŸ“ˆ å¤šé ­æ’åˆ—';
                document.getElementById('maStatus').style.color = 'var(--accent-up)';
            } else if (ma5 < ma10 && ma10 < ma20) {
                document.getElementById('maStatus').textContent = 'ğŸ“‰ ç©ºé ­æ’åˆ—';
                document.getElementById('maStatus').style.color = 'var(--accent-down)';
            } else {
                document.getElementById('maStatus').textContent = 'â¡ï¸ ç³¾çµæ•´ç†';
                document.getElementById('maStatus').style.color = 'var(--accent-yellow)';
            }

            // Update chart day counts
            const dayCount = stockData.length;
            document.getElementById('priceChartDays').textContent = `(${dayCount}æ—¥)`;
            document.getElementById('kdChartDays').textContent = `(${dayCount}æ—¥)`;
            document.getElementById('macdChartDays').textContent = `(${dayCount}æ—¥)`;

            // Update KD card values
            document.getElementById('currentK').textContent = k ? k.toFixed(2) : '-';
            document.getElementById('currentD').textContent = d ? d.toFixed(2) : '-';
            updateKDSignal();

            // Update MACD card values
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            document.getElementById('currentDIF').textContent = dif ? dif.toFixed(3) : '-';
            document.getElementById('currentMACD').textContent = macd ? macd.toFixed(3) : '-';
            document.getElementById('currentOSC').textContent = osc ? osc.toFixed(3) : '-';
            if (osc) {
                document.getElementById('currentOSC').style.color = osc >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
            }
            updateMACDSignal();

            // Draw charts
            drawPriceChart();
            drawKDChart();
            drawMACDChart();

            // Update technical table
            updateTechnicalTable();

            // Update alerts
            updateAlerts();

            // Generate AI report
            generateAIReport();
        }

        function calculateTechScore() {
            let score = 50; // Base score
            const n = stockData.length - 1;
            const alerts = technicalIndicators.alerts;

            // Adjust based on alerts
            alerts.forEach(alert => {
                const weight = alert.priority === 1 ? 8 : alert.priority === 2 ? 5 : 3;
                if (alert.type === 'bullish') {
                    score += weight;
                } else if (alert.type === 'bearish') {
                    score -= weight;
                }
            });

            // Adjust based on MA position
            const close = stockData[n].close;
            const ma20 = technicalIndicators.ma20[n];
            if (ma20 && close > ma20) score += 5;
            if (ma20 && close < ma20) score -= 5;

            return Math.max(0, Math.min(100, Math.round(score)));
        }

        function updateKDSignal() {
            const n = stockData.length - 1;
            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            const signalElement = document.getElementById('kdSignal');
            
            if (k > 80 && d > 80) {
                signalElement.textContent = 'âš ï¸ è¶…è²·';
                signalElement.style.color = 'var(--accent-down)';
            } else if (k < 20 && d < 20) {
                signalElement.textContent = 'ğŸ’¡ è¶…è³£';
                signalElement.style.color = 'var(--accent-up)';
            } else if (k > d) {
                signalElement.textContent = 'ğŸ“ˆ åå¤š';
                signalElement.style.color = 'var(--accent-up)';
            } else {
                signalElement.textContent = 'ğŸ“‰ åç©º';
                signalElement.style.color = 'var(--accent-down)';
            }
        }

        function updateMACDSignal() {
            const n = stockData.length - 1;
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            const signalElement = document.getElementById('macdSignal');
            
            if (dif > macd && osc > 0) {
                signalElement.textContent = 'ğŸ“ˆ å¤šæ–¹å¼·å‹¢';
                signalElement.style.color = 'var(--accent-up)';
            } else if (dif < macd && osc < 0) {
                signalElement.textContent = 'ğŸ“‰ ç©ºæ–¹å¼·å‹¢';
                signalElement.style.color = 'var(--accent-down)';
            } else if (dif > macd) {
                signalElement.textContent = 'â†—ï¸ åå¤š';
                signalElement.style.color = 'var(--accent-up)';
            } else {
                signalElement.textContent = 'â†˜ï¸ åç©º';
                signalElement.style.color = 'var(--accent-down)';
            }
        }

        function drawPriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (charts.priceChart) {
                charts.priceChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));
            
            charts.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ”¶ç›¤åƒ¹',
                            data: stockData.map(d => d.close),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'MA5',
                            data: technicalIndicators.ma5,
                            borderColor: '#f59e0b',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA10',
                            data: technicalIndicators.ma10,
                            borderColor: '#8b5cf6',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA20',
                            data: technicalIndicators.ma20,
                            borderColor: '#10b981',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        function drawKDChart() {
            const ctx = document.getElementById('kdChart').getContext('2d');
            
            if (charts.kdChart) {
                charts.kdChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));

            charts.kdChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'K',
                            data: technicalIndicators.k,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'D',
                            data: technicalIndicators.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        },
                        annotation: {
                            annotations: {
                                overbought: {
                                    type: 'box',
                                    yMin: 80,
                                    yMax: 100,
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 0
                                },
                                oversold: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: 20,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 0
                                },
                                line80: {
                                    type: 'line',
                                    yMin: 80,
                                    yMax: 80,
                                    borderColor: 'rgba(16, 185, 129, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5]
                                },
                                line20: {
                                    type: 'line',
                                    yMin: 20,
                                    yMax: 20,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                stepSize: 20
                            }
                        }
                    }
                }
            });
        }

        function drawMACDChart() {
            const ctx = document.getElementById('macdChart').getContext('2d');
            
            if (charts.macdChart) {
                charts.macdChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));
            const osc = technicalIndicators.osc;
            
            // Prepare bar colors - å°ç£è‚¡å¸‚ï¼šæ¼²ç´…è·Œç¶ 
            const barColors = osc.map(v => v >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)');

            charts.macdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'æŸ±ç‹€é«”',
                            data: osc,
                            backgroundColor: barColors,
                            borderWidth: 0
                        },
                        {
                            type: 'line',
                            label: 'DIF',
                            data: technicalIndicators.dif,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'MACD',
                            data: technicalIndicators.macd,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        },
                        annotation: {
                            annotations: {
                                zeroLine: {
                                    type: 'line',
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: 'rgba(148, 163, 184, 0.5)',
                                    borderWidth: 1
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        function updateTechnicalTable() {
            const tbody = document.getElementById('technicalBody');
            tbody.innerHTML = '';

            // Show last 20 days
            const recentData = stockData.slice(-20).reverse();
            
            recentData.forEach((data, index) => {
                const realIndex = stockData.length - 1 - index;
                const prevClose = realIndex > 0 ? stockData[realIndex - 1].close : data.close;
                const change = data.close - prevClose;
                const changeClass = change >= 0 ? 'price-up' : 'price-down';
                const changeSymbol = change >= 0 ? '+' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.date}</td>
                    <td>${data.close.toFixed(2)}</td>
                    <td class="${changeClass}">${changeSymbol}${change.toFixed(2)}</td>
                    <td>${(data.volume / 1000).toFixed(0)}K</td>
                    <td>${technicalIndicators.ma5[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.ma10[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.ma20[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.rsi[realIndex]?.toFixed(1) || '-'}</td>
                    <td>${technicalIndicators.k[realIndex]?.toFixed(1) || '-'}</td>
                    <td>${technicalIndicators.d[realIndex]?.toFixed(1) || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAlerts() {
            const alerts = technicalIndicators.alerts;
            const container = document.getElementById('alertsList');
            container.innerHTML = '';

            let bullishCount = 0, bearishCount = 0, warningCount = 0;
            let alertScore = 0;

            // Sort alerts by priority
            alerts.sort((a, b) => a.priority - b.priority);

            alerts.forEach(alert => {
                // Count types
                if (alert.type === 'bullish') {
                    bullishCount++;
                    alertScore += alert.priority === 1 ? 20 : alert.priority === 2 ? 10 : 5;
                } else if (alert.type === 'bearish') {
                    bearishCount++;
                    alertScore -= alert.priority === 1 ? 20 : alert.priority === 2 ? 10 : 5;
                } else if (alert.type === 'warning') {
                    warningCount++;
                }

                // Get icon and tag
                let icon, tagClass, tagText;
                switch (alert.type) {
                    case 'bullish':
                        icon = 'ğŸŸ¢';
                        tagClass = 'tag-bullish';
                        tagText = 'çœ‹æ¼²';
                        break;
                    case 'bearish':
                        icon = 'ğŸ”´';
                        tagClass = 'tag-bearish';
                        tagText = 'çœ‹è·Œ';
                        break;
                    case 'warning':
                        icon = 'ğŸŸ¡';
                        tagClass = 'tag-warning';
                        tagText = 'è­¦å‘Š';
                        break;
                    default:
                        icon = 'âšª';
                        tagClass = 'tag-neutral';
                        tagText = 'ä¸­æ€§';
                }

                const alertHtml = `
                    <div class="alert-item priority-${alert.priority}">
                        <span class="alert-icon">${icon}</span>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-desc">${alert.description}</div>
                        </div>
                        <span class="alert-tag ${tagClass}">${tagText}</span>
                    </div>
                `;
                container.innerHTML += alertHtml;
            });

            // Update counts
            document.getElementById('bullishCount').textContent = bullishCount;
            document.getElementById('bearishCount').textContent = bearishCount;
            document.getElementById('warningCount').textContent = warningCount;

            // Update score
            alertScore = Math.max(-100, Math.min(100, alertScore));
            const scoreElement = document.getElementById('alertScore');
            scoreElement.textContent = (alertScore >= 0 ? '+' : '') + alertScore;
            
            if (alertScore >= 30) {
                scoreElement.style.color = 'var(--accent-up)';
            } else if (alertScore <= -30) {
                scoreElement.style.color = 'var(--accent-down)';
            } else {
                scoreElement.style.color = 'var(--accent-yellow)';
            }
        }

        function generateAIReport() {
            const n = stockData.length - 1;
            const latestData = stockData[n];
            const techScore = calculateTechScore();
            const alerts = technicalIndicators.alerts;

            // Calculate sentiment
            let stance = 'ä¸­æ€§';
            if (techScore >= 70) stance = 'åå¤š';
            else if (techScore >= 90) stance = 'æ¥µåº¦çœ‹å¤š';
            else if (techScore <= 30) stance = 'åç©º';
            else if (techScore <= 10) stance = 'æ¥µåº¦çœ‹ç©º';

            // Generate report content
            let report = `
<div class="analysis-section">
    <h4>ğŸ“Š ç±Œç¢¼é¢è©•åˆ†ï¼š${institutionalData ? '65' : 'N/A'}/100</h4>
    <p>ç±Œç¢¼åˆ†æï¼š${institutionalData ? `å¤–è³‡ä»Šæ—¥${institutionalData.foreign >= 0 ? 'è²·è¶…' : 'è³£è¶…'} ${Math.abs(institutionalData.foreign).toLocaleString()} å¼µï¼ŒæŠ•ä¿¡${institutionalData.investment >= 0 ? 'è²·è¶…' : 'è³£è¶…'} ${Math.abs(institutionalData.investment).toLocaleString()} å¼µï¼Œè‡ªç‡Ÿå•†${institutionalData.dealer >= 0 ? 'è²·è¶…' : 'è³£è¶…'} ${Math.abs(institutionalData.dealer).toLocaleString()} å¼µã€‚` : 'ç±Œç¢¼æ•¸æ“šæš«ç„¡æ³•å–å¾—ï¼Œè«‹åƒè€ƒæŠ€è¡“é¢åˆ†æã€‚'}</p>
</div>

<div class="analysis-section">
    <h4>ğŸ“° æ¶ˆæ¯é¢è©•åˆ†ï¼šå¾…æœå°‹/100</h4>
    <p>å»ºè­°æœå°‹æœ€æ–°å…¬å¸ç‡Ÿé‹ã€ç”¢æ¥­å‹•æ…‹ã€æ³•èªªæœƒã€è²¡å ±ç­‰è³‡è¨Šï¼Œä»¥ç²å¾—å®Œæ•´æ¶ˆæ¯é¢åˆ†æã€‚</p>
</div>

<hr style="border-color: var(--border-color); margin: 20px 0;">

<div class="analysis-section">
    <h4>ğŸ¯ ç¶œåˆç ”åˆ¤</h4>
    
    <p><strong>ğŸ“ å¤šç©ºç«‹å ´ï¼š${stance}</strong></p>
    
    <p><strong>ğŸ“ˆ çŸ­ç·šé æ¸¬ï¼š</strong>${generatePrediction()}</p>
    
    <p><strong>ğŸ¯ é—œéµåƒ¹ä½ï¼š</strong></p>
    <ul style="list-style: none; padding-left: 20px;">
        <li>â€¢ å£“åŠ›ï¼š${technicalIndicators.resistance.toFixed(2)} å…ƒ</li>
        <li>â€¢ æ”¯æ’ï¼š${technicalIndicators.support.toFixed(2)} å…ƒ</li>
    </ul>
</div>

<div class="analysis-section">
    <h4>ğŸ’¡ æ“ä½œå»ºè­°</h4>
    ${generateSuggestion()}
</div>

<div class="analysis-section">
    <h4>âš ï¸ é¢¨éšªæé†’</h4>
    <ul style="list-style: none; padding-left: 0;">
        ${generateRisks()}
    </ul>
</div>
`;

            document.getElementById('aiReportContent').innerHTML = report;
        }

        function generatePrediction() {
            const n = stockData.length - 1;
            const ma5 = technicalIndicators.ma5[n];
            const ma20 = technicalIndicators.ma20[n];
            const close = stockData[n].close;
            const k = technicalIndicators.k[n];
            
            if (ma5 > ma20 && close > ma20) {
                return 'æŠ€è¡“é¢ç«™ç©©å‡ç·šä¹‹ä¸Šï¼Œé…åˆå‡ç·šå¤šé ­æ’åˆ—ï¼Œé æœŸç¶­æŒå¤šæ–¹èµ°å‹¢ã€‚';
            } else if (ma5 < ma20 && close < ma20) {
                return 'æŠ€è¡“é¢è·Œç ´å‡ç·šï¼Œé…åˆå‡ç·šç©ºé ­æ’åˆ—ï¼ŒçŸ­ç·šåå¼±æ•´ç†ã€‚';
            } else if (k < 20) {
                return 'KD é€²å…¥è¶…è³£å€ï¼Œæœ‰æ©Ÿæœƒå‡ºç¾æŠ€è¡“æ€§åå½ˆã€‚';
            } else if (k > 80) {
                return 'KD é€²å…¥è¶…è²·å€ï¼ŒçŸ­ç·šç•™æ„å›æª”å£“åŠ›ã€‚';
            }
            return 'ç›®å‰è™•æ–¼å‡ç·šç³¾çµæ•´ç†éšæ®µï¼Œå»ºè­°ç­‰å¾…æ–¹å‘æ˜ç¢ºå¾Œå†è¡Œå¸ƒå±€ã€‚';
        }

        function generateSuggestion() {
            const n = stockData.length - 1;
            const close = stockData[n].close;
            const support = technicalIndicators.support;
            const resistance = technicalIndicators.resistance;
            const techScore = calculateTechScore();
            
            const stopLoss = (support * 0.97).toFixed(2);
            const target = (resistance * 1.03).toFixed(2);
            
            if (techScore >= 70) {
                return `
                    <ul style="list-style: none; padding-left: 0;">
                        <li>â€¢ ç­–ç•¥ï¼šé †å‹¢åå¤šæ“ä½œ</li>
                        <li>â€¢ é€²å ´ï¼š${support.toFixed(2)} å…ƒé™„è¿‘åˆ†æ‰¹å¸ƒå±€</li>
                        <li>â€¢ åœæï¼š${stopLoss} å…ƒï¼ˆç´„ -3%ï¼‰</li>
                        <li>â€¢ åœåˆ©ï¼š${target} å…ƒï¼ˆç´„ +${((target/close - 1) * 100).toFixed(1)}%ï¼‰</li>
                    </ul>
                `;
            } else if (techScore <= 30) {
                return `
                    <ul style="list-style: none; padding-left: 0;">
                        <li>â€¢ ç­–ç•¥ï¼šä¿å®ˆè§€æœ›æˆ–æ¸›ç¢¼</li>
                        <li>â€¢ è‹¥æŒæœ‰ï¼šå¯æ–¼åå½ˆæ™‚æ¸›ç¢¼</li>
                        <li>â€¢ ç©ºæ‰‹è€…ï¼šå»ºè­°ç­‰å¾…æ­¢ç©©è¨Šè™Ÿ</li>
                        <li>â€¢ é—œæ³¨ï¼š${support.toFixed(2)} å…ƒæ˜¯å¦æœ‰æ•ˆæ”¯æ’</li>
                    </ul>
                `;
            }
            return `
                <ul style="list-style: none; padding-left: 0;">
                    <li>â€¢ ç­–ç•¥ï¼šå€é–“æ“ä½œæˆ–è§€æœ›</li>
                    <li>â€¢ ä¸Šæª”å£“åŠ›ï¼š${resistance.toFixed(2)} å…ƒ</li>
                    <li>â€¢ ä¸‹æª”æ”¯æ’ï¼š${support.toFixed(2)} å…ƒ</li>
                    <li>â€¢ å»ºè­°ï¼šç­‰å¾…çªç ´æ–¹å‘æ˜ç¢ºå¾Œå†è¡Œå¸ƒå±€</li>
                </ul>
            `;
        }

        function generateRisks() {
            const risks = [];
            const n = stockData.length - 1;
            const k = technicalIndicators.k[n];
            const volumeRatio = technicalIndicators.volumeRatio;
            
            risks.push('<li>â€¢ å¤§ç›¤ç³»çµ±æ€§é¢¨éšªéœ€æŒçºŒé—œæ³¨</li>');
            
            if (k > 80) {
                risks.push('<li>â€¢ KD æŒ‡æ¨™è¶…è²·ï¼Œç•™æ„çŸ­ç·šå›æª”é¢¨éšª</li>');
            }
            if (volumeRatio < 0.5) {
                risks.push('<li>â€¢ æˆäº¤é‡èç¸®ï¼Œæµå‹•æ€§é¢¨éšªè¼ƒé«˜</li>');
            }
            if (volumeRatio > 2) {
                risks.push('<li>â€¢ æˆäº¤é‡ç•°å¸¸æ”¾å¤§ï¼Œç•™æ„ä¸»åŠ›å‹•å‘</li>');
            }
            risks.push('<li>â€¢ å»ºè­°æœå°‹æœ€æ–°æ¶ˆæ¯é¢è³‡è¨Šä»¥å®Œå–„åˆ†æ</li>');
            
            return risks.join('');
        }

        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');

            // Redraw charts if needed
            if (tabId === 'kd-chart' && charts.kdChart) {
                charts.kdChart.update();
            }
            if (tabId === 'macd-chart' && charts.macdChart) {
                charts.macdChart.update();
            }
        }

        function copyReport() {
            const reportContent = document.getElementById('aiReportContent').innerText;
            navigator.clipboard.writeText(reportContent).then(() => {
                alert('å ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }
    </script>
</body>
</html>
