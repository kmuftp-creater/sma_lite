<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âè∞ËÇ°Â∞àÊ•≠ÂàÜÊûêÁ≥ªÁµ± | Professional Stock Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --bg-hover: #243044;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-up: #ef4444;          /* Êº≤ - Á¥ÖËâ≤ */
            --accent-up-glow: rgba(239, 68, 68, 0.3);
            --accent-down: #10b981;        /* Ë∑å - Á∂†Ëâ≤ */
            --accent-down-glow: rgba(16, 185, 129, 0.3);
            --accent-yellow: #f59e0b;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --border-color: #2d3a4f;
            --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Input Section */
        .input-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stock-input {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 25px;
            font-size: 1.2rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            width: 200px;
            transition: all 0.3s ease;
        }

        .stock-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .analyze-btn {
            background: var(--gradient-blue);
            border: none;
            border-radius: 12px;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Market Selector */
        .market-selector {
            display: flex;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .market-btn {
            background: transparent;
            border: none;
            padding: 15px 20px;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .market-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .market-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        .market-btn:first-child {
            border-right: 1px solid var(--border-color);
        }

        /* Date Inputs */
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 20px;
        }

        .date-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .date-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .date-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.95rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-separator {
            color: var(--text-muted);
            font-size: 1.2rem;
            margin-top: 15px;
        }

        .date-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .date-info span {
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Quick Date Buttons */
        .quick-date-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 18px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .quick-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Watchlist Add Button */
        .watchlist-add-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 12px;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .watchlist-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }

        /* Watchlist Section */
        .watchlist-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .watchlist-header h3 {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin: 0;
        }

        .watchlist-actions {
            display: flex;
            gap: 10px;
        }

        .watchlist-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .watchlist-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .watchlist-btn.danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .watchlist-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .watchlist-market-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .watchlist-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.95rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .watchlist-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .watchlist-quick-add {
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1.2rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-quick-add:hover {
            background: #2563eb;
        }

        .watchlist-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .watchlist-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-tag:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }

        .watchlist-tag .tag-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .watchlist-tag .tag-code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }

        .watchlist-tag .tag-market {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .watchlist-tag .tag-market.tpex {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .watchlist-tag .tag-remove {
            color: var(--text-muted);
            font-size: 1.1rem;
            line-height: 1;
        }

        .watchlist-tag .tag-remove:hover {
            color: #ef4444;
        }

        /* Watchlist Table */
        .watchlist-table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
        }

        .watchlist-table th,
        .watchlist-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .watchlist-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .watchlist-table td {
            font-family: 'JetBrains Mono', monospace;
        }

        .watchlist-table tr:hover {
            background: var(--bg-hover);
        }

        .watchlist-table .stock-name {
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-primary);
        }

        .watchlist-table .stock-code {
            color: var(--accent-cyan);
            font-size: 0.85rem;
        }

        .watchlist-table .price-up {
            color: var(--accent-up);
        }

        .watchlist-table .price-down {
            color: var(--accent-down);
        }

        .watchlist-table .price-flat {
            color: var(--text-secondary);
        }

        .watchlist-table .analyze-link {
            color: var(--accent-blue);
            cursor: pointer;
            text-decoration: none;
        }

        .watchlist-table .analyze-link:hover {
            text-decoration: underline;
        }

        .watchlist-table .remove-btn {
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }

        .watchlist-table .remove-btn:hover {
            color: #ef4444;
        }

        .watchlist-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            color: var(--text-secondary);
        }

        .spinner-small {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .watchlist-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        /* Toast Animation */
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes toastOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
        }

        /* Responsive for Watchlist */
        @media (max-width: 768px) {
            .watchlist-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .watchlist-input-row {
                flex-direction: column;
            }

            .watchlist-market-select {
                width: 100%;
            }

            .watchlist-table th,
            .watchlist-table td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            .watchlist-add-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Container */
        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        /* Stock Header Card */
        .stock-header {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .stock-info h2 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stock-code {
            color: var(--accent-blue);
            font-family: 'JetBrains Mono', monospace;
        }

        .market-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
            margin-left: 10px;
            vertical-align: middle;
        }

        .market-tag.twse {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .market-tag.tpex {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .stock-price {
            text-align: right;
        }

        .current-price {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .price-up {
            color: var(--accent-up);
        }

        .price-down {
            color: var(--accent-down);
        }

        .price-change {
            font-size: 1.2rem;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-3px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .card-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        /* Alert Section */
        .alerts-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .alert-summary {
            display: flex;
            gap: 20px;
        }

        .alert-count {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-count.bullish {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-up);
        }

        .alert-count.bearish {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-down);
        }

        .alert-count.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-yellow);
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: var(--bg-secondary);
            border-left: 4px solid;
        }

        .alert-item.priority-1 {
            border-left-color: #ef4444;
        }

        .alert-item.priority-2 {
            border-left-color: var(--accent-yellow);
        }

        .alert-item.priority-3 {
            border-left-color: var(--accent-cyan);
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .alert-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .alert-tag {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tag-bullish {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-up);
        }

        .tag-bearish {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-down);
        }

        .tag-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        .tag-neutral {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        /* Score Display */
        .score-display {
            text-align: center;
            padding: 30px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 4rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .score-range {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 10px;
        }

        /* AI Analysis Section */
        .ai-analysis {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .ai-analysis h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-content {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1rem;
        }

        .analysis-section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .analysis-section h4 {
            color: var(--accent-blue);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        /* Technical Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-family: 'JetBrains Mono', monospace;
        }

        .data-table tr:hover {
            background: var(--bg-hover);
        }

        /* Legend */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .input-section {
                flex-direction: column;
            }

            .market-selector {
                width: 100%;
            }

            .market-btn {
                flex: 1;
            }

            .date-inputs {
                width: 100%;
                justify-content: center;
            }

            .stock-input {
                width: 100%;
            }

            .analyze-btn {
                width: 100%;
                justify-content: center;
            }

            .stock-header {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .stock-price {
                text-align: center;
            }

            .current-price {
                font-size: 2.5rem;
            }

            .chart-wrapper {
                height: 300px;
            }

            .tabs {
                justify-content: center;
            }

            .market-tag {
                display: block;
                margin: 10px auto 0;
                width: fit-content;
            }
        }

        @media (max-width: 480px) {
            .date-inputs {
                flex-direction: column;
                gap: 15px;
            }

            .date-separator {
                display: none;
            }

            .date-group {
                width: 100%;
            }

            .date-input {
                width: 100%;
            }
        }

        /* Copy Button for AI Analysis */
        .copy-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Key Levels */
        .key-levels {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .level-item {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            text-align: center;
        }

        .level-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .level-value {
            font-size: 1.3rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .level-resistance {
            color: var(--accent-down);
        }

        .level-support {
            color: var(--accent-up);
        }

        /* Error Display */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: var(--accent-red);
            margin: 20px 0;
            white-space: pre-line;
            line-height: 1.8;
        }

        /* Ranking Section */
        .ranking-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .ranking-section.collapsed .ranking-content {
            display: none;
        }
        
        .ranking-section.collapsed .ranking-header {
            margin-bottom: 0;
        }
        
        .ranking-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px 10px;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .ranking-toggle-btn:hover {
            color: var(--text-primary);
        }
        
        .ranking-section.collapsed .ranking-toggle-btn {
            transform: rotate(-90deg);
        }
        
        .ranking-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .ranking-header h3 {
            font-size: 1.3rem;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .ranking-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .ranking-tab-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ranking-tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .ranking-tab-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .ranking-refresh-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ranking-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .ranking-update-time {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .ranking-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 40px;
            color: var(--text-secondary);
        }

        .ranking-table-container {
            overflow-x: auto;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th,
        .ranking-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .ranking-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            position: sticky;
            top: 0;
        }

        .ranking-table td {
            font-family: 'JetBrains Mono', monospace;
        }

        .ranking-table tr:hover {
            background: var(--bg-hover);
        }

        .ranking-rank {
            display: inline-flex;
            width: 28px;
            height: 28px;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .ranking-rank.top3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #000;
        }

        .ranking-rank.normal {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        /* Elliott Wave Section */
        .elliott-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .elliott-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .elliott-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .elliott-card.main-wave {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .elliott-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .elliott-icon {
            font-size: 1.2rem;
        }

        .elliott-wave-position {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        .elliott-wave-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .elliott-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .elliott-chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .elliott-chart-container h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .elliott-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .elliott-theory-box,
        .elliott-analysis-box,
        .fibonacci-box,
        .wave-prediction-box {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .elliott-theory-box h4,
        .elliott-analysis-box h4,
        .fibonacci-box h4,
        .wave-prediction-box h4 {
            color: var(--accent-yellow);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .wave-rules {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .wave-rule {
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .wave-label {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .wave-label.impulse {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-up);
        }

        .wave-label.corrective {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-down);
        }

        .wave-rule p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .fibonacci-levels {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fib-level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .fib-level.important {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .fib-level.extension {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .fib-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .fib-price {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        #elliottAnalysis, #wavePrediction {
            line-height: 1.8;
            color: var(--text-secondary);
        }

        #elliottAnalysis strong, #wavePrediction strong {
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .elliott-card.main-wave {
                grid-column: span 1;
            }
            
            .ranking-controls {
                width: 100%;
                justify-content: center;
            }
            
            .ranking-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Âè∞ËÇ°Â∞àÊ•≠ÂàÜÊûêÁ≥ªÁµ±</h1>
            <p>Êï¥ÂêàÊäÄË°ìÂàÜÊûê„ÄÅÁ±åÁ¢ºÈù¢„ÄÅÊ∂àÊÅØÈù¢ | ÊîØÊè¥‰∏äÂ∏Ç (TWSE) Âèä‰∏äÊ´É (TPEx) ËÇ°Á•®</p>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">üìå Ë≠â‰∫§ÊâÄ/Ê´ÉË≤∑‰∏≠ÂøÉË≥áÊñôÁ¥ÑÊñºÊØèÊó• 18:00 ÂæåÊõ¥Êñ∞ÔºåÁï∂Êó•Ë≥áÊñôË´ãÊñºÁõ§ÂæåÊü•Ë©¢</p>
        </header>

        <div class="input-section">
            <div class="market-selector">
                <button class="market-btn active" data-market="twse" onclick="selectMarket('twse')">‰∏äÂ∏Ç TWSE</button>
                <button class="market-btn" data-market="tpex" onclick="selectMarket('tpex')">‰∏äÊ´É TPEx</button>
            </div>
            <input type="text" class="stock-input" id="stockCode" placeholder="Ëº∏ÂÖ•ËÇ°Á•®‰ª£Ëôü" maxlength="6">
            <div class="date-inputs">
                <div class="date-group">
                    <label for="startDate">Ëµ∑ÂßãÊó•</label>
                    <input type="date" class="date-input" id="startDate">
                </div>
                <span class="date-separator">ÔΩû</span>
                <div class="date-group">
                    <label for="endDate">ÁµÇÊ≠¢Êó•</label>
                    <input type="date" class="date-input" id="endDate">
                </div>
            </div>
            <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysis()">
                <span>üîç</span>
                <span>ÈñãÂßãÂàÜÊûê</span>
            </button>
            <button class="watchlist-add-btn" onclick="addToWatchlist()">
                <span>‚≠ê</span>
                <span>Âä†ÂÖ•Ëá™ÈÅ∏</span>
            </button>
        </div>

        <!-- Ëá™ÈÅ∏ËÇ°ÂçÄÂ°ä -->
        <div class="watchlist-section" id="watchlistSection">
            <div class="watchlist-header">
                <h3>‚≠ê ÊàëÁöÑËá™ÈÅ∏ËÇ°</h3>
                <div class="watchlist-actions">
                    <button class="watchlist-btn" onclick="fetchAllWatchlist()">üìä Êõ¥Êñ∞Â†±ÂÉπ</button>
                    <button class="watchlist-btn danger" onclick="clearWatchlist()">üóëÔ∏è Ê∏ÖÁ©∫</button>
                </div>
            </div>
            <div class="watchlist-input-row">
                <select id="watchlistMarket" class="watchlist-market-select">
                    <option value="twse">‰∏äÂ∏Ç</option>
                    <option value="tpex">‰∏äÊ´É</option>
                </select>
                <input type="text" class="watchlist-input" id="watchlistCode" placeholder="Ëº∏ÂÖ•‰ª£ËôüÂø´ÈÄüÂä†ÂÖ•" maxlength="6">
                <button class="watchlist-quick-add" onclick="quickAddWatchlist()">+</button>
            </div>
            <div class="watchlist-tags" id="watchlistTags">
                <!-- Ëá™ÈÅ∏ËÇ°Ê®ôÁ±§ÊúÉÂãïÊÖãÁîüÊàê -->
            </div>
            <div class="watchlist-table-container" id="watchlistTableContainer" style="display: none;">
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>ËÇ°Á•®</th>
                            <th>Â∏ÇÂ†¥</th>
                            <th>Êàê‰∫§ÂÉπ</th>
                            <th>Êò®Êî∂</th>
                            <th>Êº≤Ë∑å</th>
                            <th>Êº≤Ë∑åÂπÖ</th>
                            <th>Êàê‰∫§Èáè</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistBody">
                    </tbody>
                </table>
            </div>
            <div class="watchlist-loading" id="watchlistLoading" style="display: none;">
                <div class="spinner-small"></div>
                <span>Ê≠£Âú®Êõ¥Êñ∞Â†±ÂÉπ...</span>
            </div>
        </div>
        <div class="date-info" id="dateInfo"></div>
        
        <div class="quick-date-btns">
            <button class="quick-btn" onclick="setDateRange(30)">Ëøë30Êó•</button>
            <button class="quick-btn active" onclick="setDateRange(60)">Ëøë60Êó•</button>
            <button class="quick-btn" onclick="setDateRange(90)">Ëøë90Êó•</button>
            <button class="quick-btn" onclick="setDateRange(180)">ËøëÂçäÂπ¥</button>
            <button class="quick-btn" onclick="setDateRange(365)">Ëøë‰∏ÄÂπ¥</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Ê≠£Âú®Áç≤ÂèñËÇ°Á•®Êï∏Êìö...</p>
        </div>

        <div class="error-message" id="errorMessage" style="display: none;"></div>

        <div class="results" id="results">
            <!-- Stock Header -->
            <div class="stock-header" id="stockHeader">
                <div class="stock-info">
                    <h2><span id="stockName">-</span> <span class="stock-code" id="displayCode">-</span> <span class="market-tag" id="marketTag">‰∏äÂ∏Ç</span></h2>
                    <p id="stockDate">ÊúÄÂæåÊõ¥Êñ∞Ôºö-</p>
                </div>
                <div class="stock-price">
                    <div class="current-price" id="currentPrice">-</div>
                    <div class="price-change" id="priceChange">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('overview')">üìà Á∏ΩË¶Ω</button>
                <button class="tab-btn" onclick="showTab('technical')">üìä ÊäÄË°ìÂàÜÊûê</button>
                <button class="tab-btn" onclick="showTab('kd-chart')">üìâ KD Á∑öÂúñ</button>
                <button class="tab-btn" onclick="showTab('macd-chart')">üìä MACD ÂúñË°®</button>
                <button class="tab-btn" onclick="showTab('elliott-wave')">üåä Ê≥¢Êµ™ÁêÜË´ñ</button>
                <button class="tab-btn" onclick="showTab('alerts')">üö® Êô∫ËÉΩË≠¶Á§∫</button>
                <button class="tab-btn" onclick="showTab('institutional')">üìä Á±åÁ¢ºÈù¢</button>
                <button class="tab-btn" onclick="showTab('ai-report')">ü§ñ AI ÂàÜÊûêÂ†±Âëä</button>
            </div>

            <!-- ÊéíË°åÊ¶úÂçÄÂ°äÔºàÁç®Á´ãÊñºÂÄãËÇ°ÂàÜÊûêÔºâ -->
            <div class="ranking-section" id="rankingSection">
                <div class="ranking-header">
                    <div class="ranking-header-left">
                        <button class="ranking-toggle-btn" onclick="toggleRankingSection()" title="Â±ïÈñã/Êî∂Âêà">‚ñº</button>
                        <h3>üèÜ Âè∞ËÇ°ÊéíË°åÊ¶ú</h3>
                    </div>
                    <div class="ranking-controls">
                        <select id="rankingMarket" class="ranking-select">
                            <option value="tse">‰∏äÂ∏Ç</option>
                            <option value="otc">‰∏äÊ´É</option>
                        </select>
                        <button class="ranking-tab-btn active" data-type="gainers" onclick="switchRankingType('gainers')">üìà Êº≤ÂπÖ</button>
                        <button class="ranking-tab-btn" data-type="losers" onclick="switchRankingType('losers')">üìâ Ë∑åÂπÖ</button>
                        <button class="ranking-tab-btn" data-type="volume" onclick="switchRankingType('volume')">üìä Êàê‰∫§Èáè</button>
                        <button class="ranking-tab-btn" data-type="value" onclick="switchRankingType('value')">üí∞ Êàê‰∫§ÂÄº</button>
                        <button class="ranking-refresh-btn" onclick="fetchRankingData()">üîÑ Êõ¥Êñ∞</button>
                    </div>
                </div>
                <div class="ranking-content">
                    <div class="ranking-update-time" id="rankingUpdateTime">ÈªûÊìä„ÄåÊõ¥Êñ∞„ÄçÁç≤ÂèñÊúÄÊñ∞ÊéíË°åÊ¶ú</div>
                    <div class="ranking-loading" id="rankingLoading" style="display: none;">
                        <div class="spinner-small"></div>
                        <span>Ê≠£Âú®ËºâÂÖ•ÊéíË°åÊ¶ú...</span>
                    </div>
                    <div class="ranking-table-container" id="rankingTableContainer" style="display: none;">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>ÊéíÂêç</th>
                                    <th>‰ª£Ëôü</th>
                                    <th>ÂêçÁ®±</th>
                                    <th>Êàê‰∫§ÂÉπ</th>
                                    <th>Êº≤Ë∑å</th>
                                    <th>Êº≤Ë∑åÂπÖ</th>
                                    <th id="rankingValueHeader">Êàê‰∫§Èáè(Âºµ)</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="rankingBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: Overview -->
            <div class="tab-content active" id="tab-overview">
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">ÊäÄË°ìË©ïÂàÜ</span>
                            <span class="card-icon">üìà</span>
                        </div>
                        <div class="card-value" id="techScore">-</div>
                        <div class="card-subtitle">Á∂úÂêàÊäÄË°ìÈù¢ÊåáÊ®ô</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="techProgress" style="width: 0%; background: var(--accent-blue);"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">RSI (14)</span>
                            <span class="card-icon">üìä</span>
                        </div>
                        <div class="card-value" id="rsiValue">-</div>
                        <div class="card-subtitle" id="rsiStatus">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">KD ÊåáÊ®ô</span>
                            <span class="card-icon">üìâ</span>
                        </div>
                        <div class="card-value" id="kdValue">-</div>
                        <div class="card-subtitle" id="kdStatus">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Êàê‰∫§ÈáèÊØî</span>
                            <span class="card-icon">üì∂</span>
                        </div>
                        <div class="card-value" id="volumeRatio">-</div>
                        <div class="card-subtitle" id="volumeStatus">-</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">üìà ÂÉπÊ†ºËµ∞Âã¢ËàáÂùáÁ∑ö <span id="priceChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>Êî∂Áõ§ÂÉπ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>MA5</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8b5cf6;"></div>
                            <span>MA10</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>MA20</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">üìç ÈóúÈçµÂÉπ‰Ωç</h4>
                        <div class="key-levels">
                            <div class="level-item">
                                <div class="level-label">Â£ìÂäõ‰Ωç (20Êó•È´ò)</div>
                                <div class="level-value level-resistance" id="resistanceLevel">-</div>
                            </div>
                            <div class="level-item">
                                <div class="level-label">ÊîØÊíê‰Ωç (20Êó•‰Ωé)</div>
                                <div class="level-value level-support" id="supportLevel">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">üìä ÂùáÁ∑öÁãÄÊÖã</h4>
                        <div class="key-levels">
                            <div class="level-item">
                                <div class="level-label">MA5</div>
                                <div class="level-value" id="ma5Value">-</div>
                            </div>
                            <div class="level-item">
                                <div class="level-label">MA20</div>
                                <div class="level-value" id="ma20Value">-</div>
                            </div>
                        </div>
                        <p id="maStatus" style="text-align: center; margin-top: 15px; color: var(--text-secondary);"></p>
                    </div>
                </div>
            </div>

            <!-- Tab: Technical Analysis -->
            <div class="tab-content" id="tab-technical">
                <div class="chart-container">
                    <h3 class="chart-title">üìä ÊäÄË°ìÊåáÊ®ôÊï∏ÊìöË°®</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="technicalTable">
                            <thead>
                                <tr>
                                    <th>Êó•Êúü</th>
                                    <th>Êî∂Áõ§</th>
                                    <th>Êº≤Ë∑å</th>
                                    <th>Êàê‰∫§Èáè</th>
                                    <th>MA5</th>
                                    <th>MA10</th>
                                    <th>MA20</th>
                                    <th>RSI</th>
                                    <th>K</th>
                                    <th>D</th>
                                </tr>
                            </thead>
                            <tbody id="technicalBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: KD Chart -->
            <div class="tab-content" id="tab-kd-chart">
                <div class="chart-container">
                    <h3 class="chart-title">üìâ KD Èö®Ê©üÊåáÊ®ô <span id="kdChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="kdChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>K ÂÄº</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>D ÂÄº</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(16, 185, 129, 0.3);"></div>
                            <span>Ë∂ÖË≤∑ÂçÄ (80)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(239, 68, 68, 0.3);"></div>
                            <span>Ë∂ÖË≥£ÂçÄ (20)</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Áï∂Ââç K ÂÄº</span>
                            <span class="card-icon">üìä</span>
                        </div>
                        <div class="card-value" id="currentK">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Áï∂Ââç D ÂÄº</span>
                            <span class="card-icon">üìä</span>
                        </div>
                        <div class="card-value" id="currentD">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">KD ÁãÄÊÖã</span>
                            <span class="card-icon">üéØ</span>
                        </div>
                        <div class="card-value" id="kdSignal" style="font-size: 1.5rem;">-</div>
                    </div>
                </div>
            </div>

            <!-- Tab: MACD Chart -->
            <div class="tab-content" id="tab-macd-chart">
                <div class="chart-container">
                    <h3 class="chart-title">üìä MACD ÊåáÊ®ô <span id="macdChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="macdChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>DIF</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>MACD (Signal)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>Êü±ÁãÄÈ´î (Ê≠£)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>Êü±ÁãÄÈ´î (Ë≤†)</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">DIF ÂÄº</span>
                            <span class="card-icon">üìà</span>
                        </div>
                        <div class="card-value" id="currentDIF">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">MACD ÂÄº</span>
                            <span class="card-icon">üìâ</span>
                        </div>
                        <div class="card-value" id="currentMACD">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Êü±ÁãÄÈ´î</span>
                            <span class="card-icon">üìä</span>
                        </div>
                        <div class="card-value" id="currentOSC">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">MACD ÁãÄÊÖã</span>
                            <span class="card-icon">üéØ</span>
                        </div>
                        <div class="card-value" id="macdSignal" style="font-size: 1.5rem;">-</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Alerts -->
            <div class="tab-content" id="tab-alerts">
                <div class="alerts-section">
                    <div class="alerts-header">
                        <h3 class="chart-title">üö® Êô∫ËÉΩË≠¶Á§∫Â†±Âëä</h3>
                        <div class="alert-summary">
                            <div class="alert-count bullish">
                                <span>üü¢</span>
                                <span id="bullishCount">0</span> ÁúãÊº≤
                            </div>
                            <div class="alert-count bearish">
                                <span>üî¥</span>
                                <span id="bearishCount">0</span> ÁúãË∑å
                            </div>
                            <div class="alert-count warning">
                                <span>üü°</span>
                                <span id="warningCount">0</span> Ë≠¶Âëä
                            </div>
                        </div>
                    </div>

                    <div class="score-display">
                        <div class="score-label">Á∂úÂêàË©ïÂàÜ</div>
                        <div class="score-value" id="alertScore">0</div>
                        <div class="score-range">Ë©ïÂàÜÁØÑÂúçÔºö-100 Ëá≥ +100</div>
                    </div>

                    <div id="alertsList">
                        <!-- Alerts will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Institutional (Á±åÁ¢ºÈù¢) -->
            <div class="tab-content" id="tab-institutional">
                <div class="institutional-section">
                    <h3 class="chart-title">üìä Á±åÁ¢ºÈù¢Á∂úÂêàË©ï‰º∞</h3>
                    
                    <!-- Á±åÁ¢ºÊ¶ÇË¶ΩÂç°Áâá -->
                    <div class="cards-grid" style="margin-bottom: 20px;">
                        <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.05));">
                            <div class="card-header">
                                <span class="card-title">Â§ñË≥áË≤∑Ë≥£Ë∂Ö</span>
                                <span class="card-icon">üè¶</span>
                            </div>
                            <div class="card-value" id="foreignNet" style="font-size: 1.8rem;">+0 Âºµ</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.05));">
                            <div class="card-header">
                                <span class="card-title">Êäï‰ø°Ë≤∑Ë≥£Ë∂Ö</span>
                                <span class="card-icon">üìà</span>
                            </div>
                            <div class="card-value" id="investmentNet" style="font-size: 1.8rem;">+0 Âºµ</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.05));">
                            <div class="card-header">
                                <span class="card-title">Ëá™ÁáüÂïÜË≤∑Ë≥£Ë∂Ö</span>
                                <span class="card-icon">üè¢</span>
                            </div>
                            <div class="card-value" id="dealerNet" style="font-size: 1.8rem;">+0 Âºµ</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.05));">
                            <div class="card-header">
                                <span class="card-title">‰∏âÂ§ßÊ≥ï‰∫∫ÂêàË®à</span>
                                <span class="card-icon">üìä</span>
                            </div>
                            <div class="card-value" id="totalInstitutional" style="font-size: 1.8rem;">+0 Âºµ</div>
                        </div>
                    </div>
                    
                    <!-- ‰∏âÂ§ßÊ≥ï‰∫∫ÈÄ≤Âá∫Ëµ∞Âã¢Âúñ -->
                    <div class="chart-container">
                        <h3 class="chart-title">üèõÔ∏è ‰∏âÂ§ßÊ≥ï‰∫∫ÈÄ≤Âá∫Ëµ∞Âã¢</h3>
                        <div class="chart-wrapper">
                            <canvas id="institutionalChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #3b82f6;"></div>
                                <span>Â§ñË≥á</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ef4444;"></div>
                                <span>Êäï‰ø°</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #a855f7;"></div>
                                <span>Ëá™ÁáüÂïÜ</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f59e0b;"></div>
                                <span>ËÇ°ÂÉπ</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Á±åÁ¢ºÂàÜÊûêË™™Êòé -->
                    <div class="analysis-card" style="margin-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--text-primary);">üìù Á±åÁ¢ºÂàÜÊûêË™™Êòé</h4>
                        <div id="institutionalAnalysis" style="line-height: 1.8; color: var(--text-secondary);">
                            <p>ËºâÂÖ•ËÇ°Á•®Êï∏ÊìöÂæåÈ°ØÁ§∫Á±åÁ¢ºÂàÜÊûê...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: AI Report -->
            <div class="tab-content" id="tab-ai-report">
                <div class="ai-analysis">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="chart-title" style="margin-bottom: 0;">ü§ñ AI Â∞àÊ•≠ÂàÜÊûêÂ†±Âëä</h3>
                        <button class="copy-btn" onclick="copyReport()">üìã Ë§áË£ΩÂ†±Âëä</button>
                    </div>
                    <div id="aiReportContent">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                            AI ÂàÜÊûêÂ†±ÂëäÂ∞áÂú®Êï∏ÊìöËºâÂÖ•ÂæåËá™ÂãïÁîüÊàê...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tab: Elliott Wave Theory -->
            <div class="tab-content" id="tab-elliott-wave">
                <div class="elliott-section">
                    <h3 class="chart-title">üåä ËâæÁï•ÁâπÊ≥¢Êµ™ÁêÜË´ñÂàÜÊûê</h3>
                    
                    <div class="elliott-overview">
                        <div class="elliott-card main-wave">
                            <div class="elliott-card-header">
                                <span class="elliott-icon">üåä</span>
                                <span>Áï∂ÂâçÊ≥¢Êµ™‰ΩçÁΩÆ</span>
                            </div>
                            <div class="elliott-wave-position" id="currentWavePosition">-</div>
                            <div class="elliott-wave-desc" id="currentWaveDesc">ËºâÂÖ•ËÇ°Á•®Êï∏ÊìöÂæåÈ°ØÁ§∫</div>
                        </div>
                        <div class="elliott-card">
                            <div class="elliott-card-header">
                                <span class="elliott-icon">üìà</span>
                                <span>Ë∂®Âã¢ÊñπÂêë</span>
                            </div>
                            <div class="elliott-value" id="elliottTrend">-</div>
                        </div>
                        <div class="elliott-card">
                            <div class="elliott-card-header">
                                <span class="elliott-icon">üéØ</span>
                                <span>Ê≥¢Êµ™Âº∑Â∫¶</span>
                            </div>
                            <div class="elliott-value" id="elliottStrength">-</div>
                        </div>
                        <div class="elliott-card">
                            <div class="elliott-card-header">
                                <span class="elliott-icon">üìä</span>
                                <span>Ë≤ªÊ≥¢Á¥çÂ•ë‰ΩçÁΩÆ</span>
                            </div>
                            <div class="elliott-value" id="fibonacciLevel">-</div>
                        </div>
                    </div>

                    <div class="elliott-chart-container">
                        <h4>üìâ Ê≥¢Êµ™ÁµêÊßãÂúñ</h4>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="elliottChart"></canvas>
                        </div>
                    </div>

                    <div class="elliott-details">
                        <div class="elliott-theory-box">
                            <h4>üìö Ê≥¢Êµ™ÁêÜË´ñË™™Êòé</h4>
                            <div class="wave-rules">
                                <div class="wave-rule">
                                    <span class="wave-label impulse">Êé®ÂãïÊµ™ (1-2-3-4-5)</span>
                                    <p>È†ÜÊáâ‰∏ªË∂®Âã¢ÊñπÂêëÔºåÁî±5ÂÄãÂ≠êÊµ™ÁµÑÊàê„ÄÇÁ¨¨3Êµ™ÈÄöÂ∏∏ÊúÄÈï∑‰∏îÊúÄÂº∑ÂãÅ„ÄÇ</p>
                                </div>
                                <div class="wave-rule">
                                    <span class="wave-label corrective">‰øÆÊ≠£Êµ™ (A-B-C)</span>
                                    <p>ÈÄÜ‰∏ªË∂®Âã¢ÊñπÂêëÔºåÁî±3ÂÄãÂ≠êÊµ™ÁµÑÊàê„ÄÇÁî®Êñº‰øÆÊ≠£Ââç‰∏ÄÂÄãÊé®ÂãïÊµ™„ÄÇ</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="elliott-analysis-box">
                            <h4>üîç Áï∂ÂâçÂàÜÊûê</h4>
                            <div id="elliottAnalysis">
                                <p style="color: var(--text-secondary);">Ë´ãÂÖàËºâÂÖ•ËÇ°Á•®Êï∏Êìö...</p>
                            </div>
                        </div>

                        <div class="fibonacci-box">
                            <h4>üìê Ë≤ªÊ≥¢Á¥çÂ•ëÂõûÊí§/Âª∂‰º∏Ê∞¥Âπ≥</h4>
                            <div class="fibonacci-levels" id="fibonacciLevels">
                                <div class="fib-level">
                                    <span class="fib-label">0%</span>
                                    <span class="fib-price" id="fib0">-</span>
                                </div>
                                <div class="fib-level">
                                    <span class="fib-label">23.6%</span>
                                    <span class="fib-price" id="fib236">-</span>
                                </div>
                                <div class="fib-level">
                                    <span class="fib-label">38.2%</span>
                                    <span class="fib-price" id="fib382">-</span>
                                </div>
                                <div class="fib-level important">
                                    <span class="fib-label">50%</span>
                                    <span class="fib-price" id="fib50">-</span>
                                </div>
                                <div class="fib-level important">
                                    <span class="fib-label">61.8%</span>
                                    <span class="fib-price" id="fib618">-</span>
                                </div>
                                <div class="fib-level">
                                    <span class="fib-label">78.6%</span>
                                    <span class="fib-price" id="fib786">-</span>
                                </div>
                                <div class="fib-level">
                                    <span class="fib-label">100%</span>
                                    <span class="fib-price" id="fib100">-</span>
                                </div>
                                <div class="fib-level extension">
                                    <span class="fib-label">161.8%</span>
                                    <span class="fib-price" id="fib1618">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="wave-prediction-box">
                            <h4>üîÆ Ê≥¢Êµ™È†êÊ∏¨</h4>
                            <div id="wavePrediction">
                                <p style="color: var(--text-secondary);">Ë´ãÂÖàËºâÂÖ•ËÇ°Á•®Êï∏Êìö...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let stockData = [];
        let stockName = '';
        let currentStockCode = '';
        let currentMarket = 'twse'; // 'twse' for ‰∏äÂ∏Ç, 'tpex' for ‰∏äÊ´É
        let technicalIndicators = {};
        let charts = {};
        let institutionalData = null;
        let institutionalHistory = [];
        let watchlist = []; // Ëá™ÈÅ∏ËÇ°Ê∏ÖÂñÆ

        // Market selection
        function selectMarket(market) {
            currentMarket = market;
            document.querySelectorAll('.market-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.market-btn[data-market="${market}"]`).classList.add('active');
            
            // Update placeholder
            const placeholder = market === 'twse' ? 'Ëº∏ÂÖ•‰∏äÂ∏ÇËÇ°Á•®‰ª£Ëôü' : 'Ëº∏ÂÖ•‰∏äÊ´ÉËÇ°Á•®‰ª£Ëôü';
            document.getElementById('stockCode').placeholder = placeholder;
        }

        // ===== Ëá™ÈÅ∏ËÇ°ÂäüËÉΩ =====
        
        // ËºâÂÖ•Ëá™ÈÅ∏ËÇ°
        function loadWatchlist() {
            try {
                const saved = localStorage.getItem('twstock_watchlist');
                if (saved) {
                    watchlist = JSON.parse(saved);
                }
            } catch (e) {
                watchlist = [];
            }
            renderWatchlistTags();
        }

        // ÂÑ≤Â≠òËá™ÈÅ∏ËÇ°
        function saveWatchlist() {
            localStorage.setItem('twstock_watchlist', JSON.stringify(watchlist));
        }

        // Ê∏≤ÊüìËá™ÈÅ∏ËÇ°Ê®ôÁ±§
        function renderWatchlistTags() {
            const container = document.getElementById('watchlistTags');
            
            if (watchlist.length === 0) {
                container.innerHTML = '<div class="watchlist-empty">Â∞öÊú™Ê∑ªÂä†Ëá™ÈÅ∏ËÇ°ÔºåË´ãËº∏ÂÖ•ËÇ°Á•®‰ª£ËôüÂæåÈªûÊìä„ÄåÂä†ÂÖ•Ëá™ÈÅ∏„Äç</div>';
                return;
            }
            
            container.innerHTML = watchlist.map((item, index) => `
                <div class="watchlist-tag" onclick="analyzeFromWatchlist('${item.code}', '${item.market}')">
                    <span class="tag-name">${item.name || ''}</span>
                    <span class="tag-code">${item.code}</span>
                    <span class="tag-market ${item.market === 'tpex' ? 'tpex' : ''}">${item.market === 'twse' ? '‰∏äÂ∏Ç' : '‰∏äÊ´É'}</span>
                    <span class="tag-remove" onclick="event.stopPropagation(); removeFromWatchlist(${index})">‚úï</span>
                </div>
            `).join('');
        }

        // Âæû‰∏ªÂàÜÊûêÂçÄÂä†ÂÖ•Ëá™ÈÅ∏ËÇ°
        function addToWatchlist() {
            const code = document.getElementById('stockCode').value.trim();
            if (!code) {
                alert('Ë´ãÂÖàËº∏ÂÖ•ËÇ°Á•®‰ª£Ëôü');
                return;
            }
            
            addStockToWatchlist(code, currentMarket);
        }

        // Âø´ÈÄüÂä†ÂÖ•Ëá™ÈÅ∏ËÇ°
        function quickAddWatchlist() {
            const code = document.getElementById('watchlistCode').value.trim();
            const market = document.getElementById('watchlistMarket').value;
            
            if (!code) {
                alert('Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Ëôü');
                return;
            }
            
            addStockToWatchlist(code, market);
            document.getElementById('watchlistCode').value = '';
        }

        // Ê∑ªÂä†ËÇ°Á•®Âà∞Ëá™ÈÅ∏ËÇ°
        function addStockToWatchlist(code, market) {
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®
            const exists = watchlist.some(item => item.code === code && item.market === market);
            if (exists) {
                alert(`${code} Â∑≤Âú®Ëá™ÈÅ∏ËÇ°‰∏≠`);
                return;
            }
            
            watchlist.push({ code, market, name: '' });
            saveWatchlist();
            renderWatchlistTags();
            
            // È°ØÁ§∫ÊèêÁ§∫
            showToast(`‚úÖ ${code} Â∑≤Âä†ÂÖ•Ëá™ÈÅ∏ËÇ°`);
        }

        // ÂæûËá™ÈÅ∏ËÇ°ÁßªÈô§
        function removeFromWatchlist(index) {
            const removed = watchlist[index];
            watchlist.splice(index, 1);
            saveWatchlist();
            renderWatchlistTags();
            showToast(`üóëÔ∏è ${removed.code} Â∑≤ÁßªÈô§`);
            
            // Â¶ÇÊûúË°®Ê†ºÊúâÈ°ØÁ§∫ÔºåÈáçÊñ∞Êï¥ÁêÜ
            if (document.getElementById('watchlistTableContainer').style.display !== 'none') {
                fetchAllWatchlist();
            }
        }

        // Ê∏ÖÁ©∫Ëá™ÈÅ∏ËÇ°
        function clearWatchlist() {
            if (watchlist.length === 0) return;
            
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËá™ÈÅ∏ËÇ°ÂóéÔºü')) {
                watchlist = [];
                saveWatchlist();
                renderWatchlistTags();
                document.getElementById('watchlistTableContainer').style.display = 'none';
                showToast('üóëÔ∏è Â∑≤Ê∏ÖÁ©∫Ëá™ÈÅ∏ËÇ°');
            }
        }

        // ÂæûËá™ÈÅ∏ËÇ°ÈÄ≤Ë°åÂàÜÊûê
        function analyzeFromWatchlist(code, market) {
            document.getElementById('stockCode').value = code;
            selectMarket(market);
            startAnalysis();
        }

        // ÊâπÈáèÊõ¥Êñ∞Ëá™ÈÅ∏ËÇ°Â†±ÂÉπ
        async function fetchAllWatchlist() {
            if (watchlist.length === 0) {
                alert('Ë´ãÂÖàÊ∑ªÂä†Ëá™ÈÅ∏ËÇ°');
                return;
            }
            
            document.getElementById('watchlistLoading').style.display = 'flex';
            document.getElementById('watchlistTableContainer').style.display = 'none';
            
            const results = [];
            
            for (const item of watchlist) {
                try {
                    const data = await fetchLatestQuote(item.code, item.market);
                    if (data) {
                        results.push({
                            ...item,
                            ...data
                        });
                    } else {
                        results.push({
                            ...item,
                            name: item.name || item.code,
                            price: '--',
                            change: '--',
                            changePercent: '--',
                            volume: '--',
                            error: true
                        });
                    }
                } catch (e) {
                    results.push({
                        ...item,
                        name: item.name || item.code,
                        price: '--',
                        change: '--',
                        changePercent: '--',
                        volume: '--',
                        error: true
                    });
                }
                
                // Áü≠Êö´Âª∂ÈÅ≤
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            renderWatchlistTable(results);
            renderWatchlistTags(); // ÈáçÊñ∞Ê∏≤ÊüìÊ®ôÁ±§‰ª•Êõ¥Êñ∞ÂêçÁ®±
            document.getElementById('watchlistLoading').style.display = 'none';
            document.getElementById('watchlistTableContainer').style.display = 'block';
        }

        // Áç≤ÂèñÂñÆ‰∏ÄËÇ°Á•®ÊúÄÊñ∞Â†±ÂÉπ - ‰ΩøÁî®ÂÆòÊñπÂç≥ÊôÇÂ†±ÂÉπ API
        async function fetchLatestQuote(code, market) {
            try {
                // ‰ΩøÁî®Ë≠â‰∫§ÊâÄÂç≥ÊôÇÂ†±ÂÉπ APIÔºàÁõ§‰∏≠Âç≥ÊôÇÔºâ
                // ‰∏äÂ∏Ç: tse_‰ª£Ëôü.tw, ‰∏äÊ´É: otc_‰ª£Ëôü.tw
                const exch = market === 'tpex' ? 'otc' : 'tse';
                const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${exch}_${code}.tw&json=1&delay=0&_=${Date.now()}`;
                
                // ÂÖàÂòóË©¶Áõ¥Êé•Ë´ãÊ±ÇÔºàmis.twse.com.tw ÊîØÊè¥ CORSÔºâ
                let data = null;
                try {
                    const response = await fetchWithTimeout(url, 5000);
                    data = await response.json();
                } catch (directError) {
                    console.log('Direct request failed, trying proxy...', directError);
                    // Ëã•Áõ¥Êé•Ë´ãÊ±ÇÂ§±ÊïóÔºåÂòóË©¶‰ΩøÁî® proxy
                    data = await fetchWithProxy(url);
                }
                
                if (data && data.msgArray && data.msgArray.length > 0) {
                    const stock = data.msgArray[0];
                    
                    // Ëß£ÊûêÊï∏Êìö
                    // z: Êàê‰∫§ÂÉπÔºàÂèØËÉΩÊòØ "-" Ë°®Á§∫ÁÑ°Êàê‰∫§Ôºâ
                    // y: Êò®Êî∂, n: ËÇ°Á•®ÂêçÁ®±, c: ËÇ°Á•®‰ª£Ëôü
                    // v: Êàê‰∫§Èáè(Âºµ), o: ÈñãÁõ§, h: ÊúÄÈ´ò, l: ÊúÄ‰Ωé
                    // pz: Ë©¶ÊíÆÂÉπ, tv: Áï∂Áõ§Êàê‰∫§Èáè, d: Êó•Êúü, t: ÊôÇÈñì
                    
                    const name = stock.n || code;
                    const prevClose = parseFloat(stock.y) || 0;
                    const tradeDate = stock.d || ''; // ‰∫§ÊòìÊó•Êúü yyyymmdd
                    const tradeTime = stock.t || ''; // ‰∫§ÊòìÊôÇÈñì hh:mm:ss
                    
                    // Êàê‰∫§ÂÉπÔºöÂÑ™ÂÖàÁî® zÔºåËã•ÁÑ°ÂâáÁî®Ë©¶ÊíÆÂÉπ pzÔºåÂÜçÁÑ°ÂâáÁî®Êò®Êî∂
                    let currentPrice = 0;
                    if (stock.z && stock.z !== '-') {
                        currentPrice = parseFloat(stock.z);
                    } else if (stock.pz && stock.pz !== '-') {
                        currentPrice = parseFloat(stock.pz);
                    } else {
                        currentPrice = prevClose; // ÁÑ°Êàê‰∫§ÊôÇÈ°ØÁ§∫Êò®Êî∂
                    }
                    
                    // Êàê‰∫§ÈáèÔºàÂºµÔºâ- Á¥ØÁ©çÊàê‰∫§Èáè
                    const volumeInLots = parseInt(stock.v) || 0;
                    
                    if (prevClose > 0) {
                        const change = currentPrice - prevClose;
                        const changePercent = (change / prevClose) * 100;
                        
                        // Êõ¥Êñ∞ watchlist ‰∏≠ÁöÑÂêçÁ®±
                        const idx = watchlist.findIndex(w => w.code === code && w.market === market);
                        if (idx !== -1) {
                            watchlist[idx].name = name;
                            saveWatchlist();
                        }
                        
                        return {
                            name: name,
                            price: currentPrice,
                            change: change,
                            changePercent: changePercent,
                            volume: volumeInLots, // ‰øùÊåÅ„ÄåÂºµ„ÄçÁÇ∫ÂñÆ‰Ωç
                            prevClose: prevClose,
                            hasTraded: stock.z && stock.z !== '-',
                            tradeDate: tradeDate,
                            tradeTime: tradeTime
                        };
                    }
                }
                
                // Â¶ÇÊûúÂÆòÊñπÂç≥ÊôÇ API Â§±ÊïóÔºåÂòóË©¶ Yahoo Finance ‰ΩúÁÇ∫ÂÇôÁî®
                console.log(`Official API returned no data for ${code}, trying Yahoo...`);
                return await fetchLatestQuoteYahoo(code, market);
                
            } catch (e) {
                console.log(`Error fetching quote for ${code}:`, e);
                // ÂòóË©¶ÂÇôÁî®‰æÜÊ∫ê
                return await fetchLatestQuoteYahoo(code, market);
            }
        }
        
        // Yahoo Finance ÂÇôÁî®Â†±ÂÉπÔºàÊèê‰æõÁï∂Êó•Âç≥ÊôÇÊï∏ÊìöÔºâ
        async function fetchLatestQuoteYahoo(code, market) {
            try {
                const symbol = market === 'tpex' ? `${code}.TWO` : `${code}.TW`;
                // ‰ΩøÁî®ËºÉÁü≠ÁöÑ range Âíå interval ÂèñÂæóÊõ¥Âç≥ÊôÇÁöÑÊï∏Êìö
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1m&range=1d&_=${Date.now()}`;
                
                const data = await fetchWithProxy(url);
                
                if (data && data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    const quotes = result.indicators.quote[0];
                    const len = quotes.close ? quotes.close.length : 0;
                    
                    // ÂèñÊúÄÂæå‰∏ÄÁ≠ÜÊúâÊïàÊï∏Êìö
                    let lastIndex = len - 1;
                    while (lastIndex >= 0 && (quotes.close[lastIndex] === null || isNaN(quotes.close[lastIndex]))) {
                        lastIndex--;
                    }
                    
                    if (lastIndex < 0) {
                        // Â¶ÇÊûúÁï∂Êó•ÁÑ°Êï∏ÊìöÔºåÁî® meta ‰∏≠ÁöÑË≥áË®ä
                        const currentPrice = meta.regularMarketPrice || 0;
                        const prevClose = meta.chartPreviousClose || meta.previousClose || currentPrice;
                        
                        if (currentPrice > 0) {
                            return {
                                name: code,
                                price: currentPrice,
                                change: currentPrice - prevClose,
                                changePercent: prevClose > 0 ? ((currentPrice - prevClose) / prevClose) * 100 : 0,
                                volume: Math.round((meta.regularMarketVolume || 0) / 1000),
                                prevClose: prevClose,
                                hasTraded: true
                            };
                        }
                        return null;
                    }
                    
                    const currentPrice = quotes.close[lastIndex];
                    const prevClose = meta.chartPreviousClose || meta.previousClose || currentPrice;
                    const change = currentPrice - prevClose;
                    const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;
                    
                    // Ë®àÁÆóÁï∂Êó•Á∏ΩÊàê‰∫§Èáè
                    let totalVolume = 0;
                    for (let i = 0; i <= lastIndex; i++) {
                        totalVolume += (quotes.volume[i] || 0);
                    }
                    const volumeInLots = Math.round(totalVolume / 1000); // ËΩâÊàêÂºµ
                    
                    return {
                        name: code, // Yahoo ÁÑ°Ê≥ïÂèñÂæó‰∏≠ÊñáÂêç
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        volume: volumeInLots,
                        prevClose: prevClose,
                        hasTraded: true
                    };
                }
            } catch (e) {
                console.log(`Yahoo Finance fallback failed for ${code}:`, e);
            }
            return null;
        }

        // Ê∏≤ÊüìËá™ÈÅ∏ËÇ°Ë°®Ê†º
        function renderWatchlistTable(results) {
            const tbody = document.getElementById('watchlistBody');
            
            tbody.innerHTML = results.map(item => {
                const isUp = item.change > 0;
                const isDown = item.change < 0;
                const priceClass = item.error ? '' : (isUp ? 'price-up' : (isDown ? 'price-down' : 'price-flat'));
                const changeSymbol = isUp ? '+' : '';
                
                const priceDisplay = item.error ? '--' : parseFloat(item.price).toFixed(2);
                const prevCloseDisplay = item.error || !item.prevClose ? '--' : parseFloat(item.prevClose).toFixed(2);
                const changeDisplay = item.error ? '--' : `${changeSymbol}${parseFloat(item.change).toFixed(2)}`;
                const percentDisplay = item.error ? '--' : `${changeSymbol}${parseFloat(item.changePercent).toFixed(2)}%`;
                const volumeDisplay = item.error ? '--' : formatVolume(item.volume);
                
                // È°ØÁ§∫‰∫§ÊòìÁãÄÊÖã
                let statusIndicator = '';
                if (!item.error && item.hasTraded === false) {
                    statusIndicator = ' <span style="color: var(--text-muted); font-size: 0.75rem;">(Ë©¶ÊíÆ)</span>';
                }
                
                return `
                    <tr>
                        <td>
                            <div class="stock-name">${item.name || item.code}</div>
                            <div class="stock-code">${item.code}</div>
                        </td>
                        <td>
                            <span class="tag-market ${item.market === 'tpex' ? 'tpex' : ''}">${item.market === 'twse' ? '‰∏äÂ∏Ç' : '‰∏äÊ´É'}</span>
                        </td>
                        <td class="${priceClass}">${priceDisplay}${statusIndicator}</td>
                        <td class="price-flat">${prevCloseDisplay}</td>
                        <td class="${priceClass}">${changeDisplay}</td>
                        <td class="${priceClass}">${percentDisplay}</td>
                        <td>${volumeDisplay}</td>
                        <td>
                            <a class="analyze-link" onclick="analyzeFromWatchlist('${item.code}', '${item.market}')">üìä ÂàÜÊûê</a>
                            <button class="remove-btn" onclick="removeFromWatchlistByCode('${item.code}', '${item.market}')">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ê†πÊìö‰ª£ËôüÁßªÈô§Ëá™ÈÅ∏ËÇ°
        function removeFromWatchlistByCode(code, market) {
            const index = watchlist.findIndex(w => w.code === code && w.market === market);
            if (index !== -1) {
                removeFromWatchlist(index);
            }
        }

        // Ê†ºÂºèÂåñÊàê‰∫§ÈáèÔºà‰ª•ÂºµÁÇ∫ÂñÆ‰ΩçÔºâ
        function formatVolume(volume) {
            if (volume >= 10000) {
                return (volume / 10000).toFixed(2) + 'Ëê¨Âºµ';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'ÂçÉÂºµ';
            }
            return volume.toLocaleString() + 'Âºµ';
        }

        // È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
        function showToast(message) {
            // ÂâµÂª∫ toast ÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-card);
                color: var(--text-primary);
                padding: 12px 24px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: toastIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Proxy URL for CORS - with fallback options
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?'
        ];
        let currentProxyIndex = 0;

        async function fetchWithTimeout(url, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, { 
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                    }
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        async function fetchWithProxy(url) {
            // ÂòóË©¶ÂêÑÂÄã‰ª£ÁêÜ
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxyIndex = (currentProxyIndex + i) % CORS_PROXIES.length;
                const proxy = CORS_PROXIES[proxyIndex];
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    const response = await fetchWithTimeout(proxyUrl, 8000);
                    if (response.ok) {
                        const text = await response.text();
                        if (text && text.trim()) {
                            try {
                                const data = JSON.parse(text);
                                currentProxyIndex = proxyIndex;
                                return data;
                            } catch {
                                return { raw: text };
                            }
                        }
                    }
                } catch (e) {
                    console.log(`Proxy ${proxyIndex} failed:`, e.message);
                }
            }
            
            return { stat: 'ERROR', data: null };
        }

        // Initialize dates and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            loadWatchlist(); // ËºâÂÖ•Ëá™ÈÅ∏ËÇ°
            initRankingState(); // ÂàùÂßãÂåñÊéíË°åÊ¶úÊë∫ÁñäÁãÄÊÖã
            
            document.getElementById('stockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startAnalysis();
            });
            
            document.getElementById('watchlistCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') quickAddWatchlist();
            });
            
            document.getElementById('startDate').addEventListener('change', updateDateInfo);
            document.getElementById('endDate').addEventListener('change', updateDateInfo);
        });

        function initializeDates() {
            const today = new Date();
            const sixtyDaysAgo = new Date(today);
            sixtyDaysAgo.setDate(today.getDate() - 60);
            
            // Format dates for input
            document.getElementById('endDate').value = formatDateForInput(today);
            document.getElementById('startDate').value = formatDateForInput(sixtyDaysAgo);
            
            // Set max date to today
            document.getElementById('endDate').max = formatDateForInput(today);
            document.getElementById('startDate').max = formatDateForInput(today);
            
            updateDateInfo();
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateDateInfo() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                document.getElementById('dateInfo').innerHTML = 
                    `üìÖ ÂàÜÊûêÊúüÈñìÔºö<span>${document.getElementById('startDate').value}</span> Ëá≥ <span>${document.getElementById('endDate').value}</span>ÔºàÁ¥Ñ <span>${diffDays}</span> Â§©Ôºâ`;
            }
        }

        function setDateRange(days) {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - days);
            
            document.getElementById('endDate').value = formatDateForInput(today);
            document.getElementById('startDate').value = formatDateForInput(startDate);
            
            // Update active button
            document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateDateInfo();
        }

        async function startAnalysis() {
            const stockCode = document.getElementById('stockCode').value.trim();
            if (!stockCode) {
                showError('Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Ëôü');
                return;
            }

            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            
            if (!startDateStr || !endDateStr) {
                showError('Ë´ãÈÅ∏ÊìáËµ∑Ë®ñÊó•Êúü');
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            if (startDate >= endDate) {
                showError('Ëµ∑ÂßãÊó•ÂøÖÈ†àÊó©ÊñºÁµÇÊ≠¢Êó•');
                return;
            }

            if (endDate > today) {
                showError('ÁµÇÊ≠¢Êó•‰∏çËÉΩË∂ÖÈÅé‰ªäÂ§©');
                return;
            }

            currentStockCode = stockCode;
            
            // Reset UI
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;

            try {
                // Fetch stock data
                const marketName = currentMarket === 'twse' ? '‰∏äÂ∏Ç' : '‰∏äÊ´É';
                updateLoadingText(`Ê≠£Âú®Áç≤Âèñ${marketName}ËÇ°Á•®‰∫§ÊòìÊï∏Êìö...`);
                await fetchStockData(stockCode);

                if (stockData.length === 0) {
                    throw new Error('ÁÑ°Ê≥ïÁç≤ÂèñËÇ°Á•®Êï∏ÊìöÔºåË´ãÁ¢∫Ë™çËÇ°Á•®‰ª£ËôüÂèäÂ∏ÇÂ†¥È°ûÂûãÊòØÂê¶Ê≠£Á¢∫');
                }

                // Fetch institutional data
                updateLoadingText(`Ê≠£Âú®Áç≤Âèñ${marketName}‰∏âÂ§ßÊ≥ï‰∫∫Êï∏Êìö...`);
                await fetchInstitutionalData(stockCode);

                // Calculate technical indicators
                updateLoadingText('Ê≠£Âú®Ë®àÁÆóÊäÄË°ìÊåáÊ®ô...');
                calculateAllIndicators();

                // Update UI
                updateLoadingText('Ê≠£Âú®ÁîüÊàêÂàÜÊûêÂ†±Âëä...');
                updateUI();

                // Show results
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.add('active');

            } catch (error) {
                console.error('Analysis error:', error);
                showError(error.message || 'ÂàÜÊûêÈÅéÁ®ãÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showError(message) {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        async function fetchStockData(stockCode) {
            stockData = [];
            
            if (currentMarket === 'twse') {
                await fetchTWSEData(stockCode);
                // Â¶ÇÊûú TWSE Ê≤íË≥áÊñôÔºåÂòóË©¶ Yahoo Finance
                if (stockData.length === 0) {
                    console.log('TWSE API failed, trying Yahoo Finance...');
                    await fetchYahooFinanceData(stockCode, 'TW');
                    processStockData(stockCode, stockData.length > 0 ? 1 : 0, '‰∏äÂ∏Ç');
                }
            } else {
                await fetchTPExData(stockCode);
            }
        }

        // ‰∏äÂ∏ÇËÇ°Á•®Ë≥áÊñô (TWSE)
        async function fetchTWSEData(stockCode) {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // Calculate all months to fetch (including buffer for MA calculations)
            const monthsToFetch = [];
            
            // Start from 2 months before the start date (for MA20 calculations)
            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth() - 2, 1);
            const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
            
            while (currentMonth <= endMonth) {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth() + 1;
                const dateStr = `${year}${String(month).padStart(2, '0')}01`;
                monthsToFetch.push(dateStr);
                
                // Move to next month
                currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            }
            
            console.log('TWSE Months to fetch:', monthsToFetch);
            
            let fetchedCount = 0;
            for (const dateStr of monthsToFetch) {
                try {
                    updateLoadingText(`Ê≠£Âú®Áç≤Âèñ‰∏äÂ∏Ç ${dateStr.substring(0, 4)}/${dateStr.substring(4, 6)} Êúà‰ªΩË≥áÊñô...`);
                    
                    const url = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${stockCode}`;
                    const data = await fetchWithProxy(url);
                    
                    if (data.stat === 'OK' && data.data && data.data.length > 0) {
                        stockName = data.title ? data.title.split(' ')[2] || stockCode : stockCode;
                        fetchedCount++;
                        
                        data.data.forEach(row => {
                            const rocDate = row[0];
                            const [rocYear, month, day] = rocDate.split('/');
                            const year = parseInt(rocYear) + 1911;
                            const dateString = `${year}/${month}/${day}`;
                            const rowDate = new Date(year, parseInt(month) - 1, parseInt(day));
                            
                            stockData.push({
                                date: dateString,
                                dateObj: rowDate,
                                volume: parseInt(row[1].replace(/,/g, '')),
                                turnover: parseInt(row[2].replace(/,/g, '')),
                                open: parseFloat(row[3].replace(/,/g, '')),
                                high: parseFloat(row[4].replace(/,/g, '')),
                                low: parseFloat(row[5].replace(/,/g, '')),
                                close: parseFloat(row[6].replace(/,/g, '')),
                                change: row[7],
                                transactions: parseInt(row[8].replace(/,/g, ''))
                            });
                        });
                    } else {
                        console.log(`No TWSE data for ${dateStr}:`, data.stat);
                    }
                } catch (e) {
                    console.log(`Error fetching TWSE data for ${dateStr}:`, e);
                }
                
                await new Promise(resolve => setTimeout(resolve, 350));
            }

            processStockData(stockCode, fetchedCount, '‰∏äÂ∏Ç');
        }

        // ‰∏äÊ´ÉËÇ°Á•®Ë≥áÊñô (TPEx) - ÂÑ™ÂÖà‰ΩøÁî® Yahoo Finance
        async function fetchTPExData(stockCode) {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // Áõ¥Êé•‰ΩøÁî® Yahoo Finance Áç≤Âèñ‰∏äÊ´ÉË≥áÊñôÔºàÊõ¥Á©©ÂÆöÔºâ
            updateLoadingText('Ê≠£Âú®Áç≤Âèñ‰∏äÊ´ÉËÇ°Á•®Ë≥áÊñô...');
            await fetchYahooFinanceData(stockCode, 'TWO');
            
            // Â¶ÇÊûú Yahoo Finance Â§±ÊïóÔºåÂòóË©¶ TPEx ÂÆòÊñπ API
            if (stockData.length === 0) {
                console.log('Yahoo Finance failed, trying TPEx API...');
                await fetchTPExOfficialData(stockCode, startDate, endDate);
            }

            processStockData(stockCode, stockData.length > 0 ? 1 : 0, '‰∏äÊ´É');
        }
        
        // TPEx ÂÆòÊñπ API ÊäìÂèñ
        async function fetchTPExOfficialData(stockCode, startDate, endDate) {
            const monthsToFetch = [];
            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth() - 2, 1);
            const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
            
            while (currentMonth <= endMonth) {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth() + 1;
                const rocYear = year - 1911;
                monthsToFetch.push({ rocYear, year, month });
                currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            }
            
            for (const { rocYear, year, month } of monthsToFetch) {
                try {
                    updateLoadingText(`Ê≠£Âú®Áç≤Âèñ‰∏äÊ´É ${year}/${String(month).padStart(2, '0')} Ë≥áÊñô...`);
                    
                    const dateStr = `${rocYear}/${String(month).padStart(2, '0')}`;
                    const url = `https://www.tpex.org.tw/web/stock/aftertrading/daily_trading_info/st43_result.php?l=zh-tw&d=${dateStr}&stkno=${stockCode}`;
                    
                    const data = await fetchWithProxy(url);
                    
                    if (data && data.aaData && data.aaData.length > 0) {
                        if (!stockName || stockName === stockCode) {
                            stockName = data.stkName || stockCode;
                        }
                        
                        data.aaData.forEach(row => {
                            try {
                                const rocDate = row[0];
                                if (!rocDate || !rocDate.includes('/')) return;
                                
                                const [y, m, d] = rocDate.split('/');
                                const fullYear = parseInt(y) + 1911;
                                const dateString = `${fullYear}/${m}/${d}`;
                                const rowDate = new Date(fullYear, parseInt(m) - 1, parseInt(d));
                                
                                const parseNum = (val) => {
                                    if (!val || val === '--' || val === '-') return NaN;
                                    return parseFloat(String(val).replace(/,/g, ''));
                                };
                                
                                const volume = parseNum(row[1]) * 1000;
                                const open = parseNum(row[2]);
                                const high = parseNum(row[3]);
                                const low = parseNum(row[4]);
                                const close = parseNum(row[5]);
                                
                                if (!isNaN(close) && close > 0) {
                                    stockData.push({
                                        date: dateString,
                                        dateObj: rowDate,
                                        volume: isNaN(volume) ? 0 : volume,
                                        turnover: 0,
                                        open: isNaN(open) ? close : open,
                                        high: isNaN(high) ? close : high,
                                        low: isNaN(low) ? close : low,
                                        close: close,
                                        change: row[6] || '-',
                                        transactions: parseNum(row[7]) || 0
                                    });
                                }
                            } catch (e) {
                                // Skip invalid row
                            }
                        });
                    }
                } catch (e) {
                    console.log(`TPEx fetch error for ${year}/${month}:`, e.message);
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }
        
        // ‰ΩøÁî® Yahoo Finance Áç≤ÂèñË≥áÊñôÔºàÊîØÊè¥‰∏äÂ∏ÇÂíå‰∏äÊ´ÉÔºâ
        async function fetchYahooFinanceData(stockCode, market) {
            try {
                const symbol = market === 'TWO' ? `${stockCode}.TWO` : `${stockCode}.TW`;
                const endTimestamp = Math.floor(new Date(document.getElementById('endDate').value).getTime() / 1000) + 86400;
                const startTimestamp = Math.floor(new Date(document.getElementById('startDate').value).getTime() / 1000) - (86400 * 45);
                
                // ‰ΩøÁî® Yahoo Finance API
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${startTimestamp}&period2=${endTimestamp}&interval=1d&includePrePost=false`;
                
                console.log('Fetching Yahoo Finance:', symbol);
                
                const data = await fetchWithProxy(url);
                
                if (data && data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const quotes = result.indicators.quote[0];
                    const meta = result.meta;
                    
                    if (!stockName || stockName === stockCode) {
                        stockName = meta.shortName || meta.longName || stockCode;
                        // Ê∏ÖÁêÜËÇ°Á•®ÂêçÁ®±
                        if (stockName.includes(stockCode)) {
                            stockName = stockName.replace(stockCode, '').trim();
                        }
                    }
                    
                    if (timestamps && quotes && timestamps.length > 0) {
                        for (let i = 0; i < timestamps.length; i++) {
                            const date = new Date(timestamps[i] * 1000);
                            const dateString = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                            
                            const close = quotes.close[i];
                            const open = quotes.open[i];
                            const high = quotes.high[i];
                            const low = quotes.low[i];
                            const volume = quotes.volume[i];
                            
                            if (close && !isNaN(close) && close > 0) {
                                stockData.push({
                                    date: dateString,
                                    dateObj: date,
                                    volume: volume || 0,
                                    turnover: 0,
                                    open: open || close,
                                    high: high || close,
                                    low: low || close,
                                    close: close,
                                    change: '-',
                                    transactions: 0
                                });
                            }
                        }
                        console.log(`Yahoo Finance: fetched ${stockData.length} records for ${symbol}`);
                    }
                } else if (data && data.chart && data.chart.error) {
                    console.log('Yahoo Finance error:', data.chart.error.description);
                }
            } catch (e) {
                console.log('Yahoo Finance fetch failed:', e.message);
            }
        }

        // ËôïÁêÜËÇ°Á•®Ë≥áÊñô
        function processStockData(stockCode, fetchedCount, marketType) {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            // Sort by date
            stockData.sort((a, b) => a.dateObj - b.dateObj);
            
            // Remove duplicates based on date
            stockData = stockData.filter((item, index, self) =>
                index === self.findIndex((t) => t.date === item.date)
            );
            
            // Filter to only include data within the selected range (keep buffer data for calculation)
            const bufferStartDate = new Date(startDate);
            bufferStartDate.setDate(bufferStartDate.getDate() - 35); // Buffer for MA20 + KD9
            
            stockData = stockData.filter(item => 
                item.dateObj >= bufferStartDate && item.dateObj <= endDate
            );
            
            console.log(`Fetched ${fetchedCount} months, ${stockData.length} trading days`);
            
            if (stockData.length === 0) {
                const startDateDisplay = document.getElementById('startDate').value;
                const endDateDisplay = document.getElementById('endDate').value;
                throw new Error(`ÁÑ°Ê≥ïÁç≤Âèñ${marketType}ËÇ°Á•® ${stockCode} Âú® ${startDateDisplay} Ëá≥ ${endDateDisplay} ÊúüÈñìÁöÑ‰∫§ÊòìË≥áÊñô„ÄÇ\n\nÂèØËÉΩÂéüÂõ†Ôºö\n1. ËÇ°Á•®‰ª£Ëôü‰∏çÊ≠£Á¢∫\n2. ËÇ°Á•®Â∏ÇÂ†¥ÈÅ∏ÊìáÈåØË™§ÔºàË´ãÁ¢∫Ë™çÊòØ‰∏äÂ∏ÇÊàñ‰∏äÊ´ÉÔºâ\n3. ÈÅ∏ÊìáÁöÑÊó•ÊúüÁØÑÂúçÂÖßÁÑ°‰∫§ÊòìÊó•\n4. Ë≥áÊñôÂ∞öÊú™Êõ¥Êñ∞ÔºàÁ¥Ñ 18:00 ÂæåÊõ¥Êñ∞Ôºâ`);
            }
            
            if (stockData.length < 20) {
                console.warn('Warning: Less than 20 trading days, some indicators may not be accurate');
            }
        }

        async function fetchInstitutionalData(stockCode) {
            institutionalData = {
                foreign: 0,
                investment: 0,
                dealer: 0
            };
            institutionalHistory = [];

            try {
                // Áç≤ÂèñÂ§öÂ§©ÁöÑ‰∏âÂ§ßÊ≥ï‰∫∫Êï∏Êìö
                const dates = getRecentTradingDates(20); // Áç≤ÂèñÊúÄËøë20ÂÄã‰∫§ÊòìÊó•
                
                for (const dateStr of dates) {
                    let dayData = null;
                    
                    if (currentMarket === 'twse') {
                        dayData = await fetchTWSEInstitutional(stockCode, dateStr);
                    } else {
                        dayData = await fetchTPExInstitutional(stockCode, dateStr);
                    }
                    
                    if (dayData) {
                        // ÊâæÂà∞Â∞çÊáâÁöÑËÇ°ÂÉπ
                        const priceData = stockData.find(d => d.date === dayData.date);
                        const price = priceData ? priceData.close : 0;
                        
                        institutionalHistory.push({
                            date: dayData.date,
                            price: price,
                            foreign: dayData.foreignNet,
                            investment: dayData.trustNet,
                            dealer: dayData.dealerNet
                        });
                    }
                    
                    // Âä†ÂÖ•Âª∂ÈÅ≤ÈÅøÂÖçË´ãÊ±ÇÈÅéÂø´
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // ÊéíÂ∫èÔºàÂæûËàäÂà∞Êñ∞Ôºâ
                institutionalHistory.sort((a, b) => a.date.localeCompare(b.date));
                
                // Ë®≠ÂÆöÊúÄÊñ∞‰∏ÄÂ§©ÁöÑÊï∏Êìö
                if (institutionalHistory.length > 0) {
                    const latest = institutionalHistory[institutionalHistory.length - 1];
                    institutionalData.foreign = latest.foreign;
                    institutionalData.investment = latest.investment;
                    institutionalData.dealer = latest.dealer;
                }
                
                console.log('Institutional history loaded:', institutionalHistory.length, 'days');
                
            } catch (e) {
                console.log('Error fetching institutional data:', e);
            }
        }
        
        function getRecentTradingDates(days) {
            // Âæû stockData Áç≤ÂèñÂØ¶Èöõ‰∫§ÊòìÊó•
            if (stockData.length > 0) {
                return stockData.slice(-days).map(d => d.date);
            }
            return [];
        }
        
        // Áç≤Âèñ‰∏äÂ∏ÇËÇ°Á•®‰∏âÂ§ßÊ≥ï‰∫∫Ë≥áÊñô
        // TWSE T86 API Ê¨Ñ‰ΩçÈ†ÜÂ∫è (2024Âπ¥ÂæåÊõ¥Êñ∞Áâà):
        // 0:Ë≠âÂà∏‰ª£Ëôü, 1:Ë≠âÂà∏ÂêçÁ®±
        // 2:Â§ñÈô∏Ë≥áË≤∑ÈÄ≤ËÇ°Êï∏(‰∏çÂê´Â§ñË≥áËá™ÁáüÂïÜ), 3:Â§ñÈô∏Ë≥áË≥£Âá∫ËÇ°Êï∏, 4:Â§ñÈô∏Ë≥áË≤∑Ë≥£Ë∂ÖËÇ°Êï∏
        // 5:Â§ñË≥áËá™ÁáüÂïÜË≤∑ÈÄ≤ËÇ°Êï∏, 6:Â§ñË≥áËá™ÁáüÂïÜË≥£Âá∫ËÇ°Êï∏, 7:Â§ñË≥áËá™ÁáüÂïÜË≤∑Ë≥£Ë∂ÖËÇ°Êï∏
        // 8:Â§ñË≥áÂèäÈô∏Ë≥áË≤∑ÈÄ≤ËÇ°Êï∏, 9:Â§ñË≥áÂèäÈô∏Ë≥áË≥£Âá∫ËÇ°Êï∏, 10:Â§ñË≥áÂèäÈô∏Ë≥áË≤∑Ë≥£Ë∂ÖËÇ°Êï∏ (Êñ∞Â¢ûÂêàË®àÊ¨Ñ‰Ωç)
        // 11:Êäï‰ø°Ë≤∑ÈÄ≤ËÇ°Êï∏, 12:Êäï‰ø°Ë≥£Âá∫ËÇ°Êï∏, 13:Êäï‰ø°Ë≤∑Ë≥£Ë∂ÖËÇ°Êï∏
        // 14:Ëá™ÁáüÂïÜË≤∑ÈÄ≤(Ëá™Ë°åË≤∑Ë≥£), 15:Ëá™ÁáüÂïÜË≥£Âá∫(Ëá™Ë°åË≤∑Ë≥£), 16:Ëá™ÁáüÂïÜË≤∑Ë≥£Ë∂Ö(Ëá™Ë°åË≤∑Ë≥£)
        // 17:Ëá™ÁáüÂïÜË≤∑ÈÄ≤(ÈÅøÈö™), 18:Ëá™ÁáüÂïÜË≥£Âá∫(ÈÅøÈö™), 19:Ëá™ÁáüÂïÜË≤∑Ë≥£Ë∂Ö(ÈÅøÈö™)
        // 20:Ëá™ÁáüÂïÜË≤∑Ë≥£Ë∂ÖËÇ°Êï∏(ÂêàË®à)
        // 21:‰∏âÂ§ßÊ≥ï‰∫∫Ë≤∑Ë≥£Ë∂ÖËÇ°Êï∏
        async function fetchTWSEInstitutional(stockCode, date) {
            try {
                // Â∞áÊó•ÊúüËΩâÊèõÁÇ∫ API Ê†ºÂºè (YYYYMMDD)
                const dateStr = date.replace(/\//g, '').replace(/-/g, '');
                const url = `https://www.twse.com.tw/rwd/zh/fund/T86?date=${dateStr}&selectType=ALLBUT0999&response=json`;
                const data = await fetchWithProxy(url);
                
                if (data && data.stat === 'OK' && data.data) {
                    const stockRow = data.data.find(row => row[0].trim() === stockCode);
                    if (stockRow) {
                        // Ëß£ÊûêÊï∏ÂÄºÔºåËôïÁêÜÁâπÊÆäÊ∏õËôüÂíåÈÄóËôü
                        const parseNum = (str) => {
                            if (!str) return 0;
                            let cleaned = String(str).replace(/,/g, '').replace(/‚àí/g, '-');
                            return parseInt(cleaned) || 0;
                        };
                        
                        // Ê™¢Ê∏¨ API ÁâàÊú¨
                        const isNewFormat = stockRow.length >= 22;
                        
                        // Â§ñË≥á = Â§ñÈô∏Ë≥á(‰∏çÂê´Â§ñË≥áËá™ÁáüÂïÜ) + Â§ñË≥áËá™ÁáüÂïÜ
                        const foreignNet = parseNum(stockRow[4]) + parseNum(stockRow[7]);
                        
                        let trustNet, dealerNet;
                        if (isNewFormat) {
                            // Êñ∞Áâà API (22Ê¨Ñ‰Ωç)
                            trustNet = parseNum(stockRow[13]);  // Êäï‰ø°Ë≤∑Ë≥£Ë∂Ö
                            dealerNet = parseNum(stockRow[20]); // Ëá™ÁáüÂïÜÂêàË®àË≤∑Ë≥£Ë∂Ö
                        } else {
                            // ËàäÁâà API
                            trustNet = parseNum(stockRow[10]);
                            dealerNet = parseNum(stockRow[11]);
                        }
                        
                        // ËΩâÊèõÁÇ∫ÂºµÊï∏ÔºàËÇ°Êï∏ / 1000Ôºâ
                        return {
                            date: date,
                            foreignNet: Math.round(foreignNet / 1000),
                            trustNet: Math.round(trustNet / 1000),
                            dealerNet: Math.round(dealerNet / 1000)
                        };
                    }
                }
                return null;
            } catch (e) {
                console.log('TWSE institutional fetch error:', e);
                return null;
            }
        }
        
        // Áç≤Âèñ‰∏äÊ´ÉËÇ°Á•®‰∏âÂ§ßÊ≥ï‰∫∫Ë≥áÊñô
        // TPEX 3itrade_hedge_result API Ê¨Ñ‰ΩçÈ†ÜÂ∫è:
        // 0:ËÇ°Á•®‰ª£Ëôü, 1:ËÇ°Á•®ÂêçÁ®±
        // 2:Â§ñË≥áÂèäÈô∏Ë≥á(‰∏çÂê´Â§ñË≥áËá™ÁáüÂïÜ)-Ë≤∑ÈÄ≤, 3:Ë≥£Âá∫, 4:Ë≤∑Ë≥£Ë∂Ö
        // 5:Â§ñË≥áËá™ÁáüÂïÜ-Ë≤∑ÈÄ≤, 6:Ë≥£Âá∫, 7:Ë≤∑Ë≥£Ë∂Ö
        // 8:Êäï‰ø°-Ë≤∑ÈÄ≤, 9:Ë≥£Âá∫, 10:Ë≤∑Ë≥£Ë∂Ö
        // 11:Ëá™ÁáüÂïÜ(Ëá™Ë°åË≤∑Ë≥£)-Ë≤∑ÈÄ≤, 12:Ë≥£Âá∫, 13:Ë≤∑Ë≥£Ë∂Ö
        // 14:Ëá™ÁáüÂïÜ(ÈÅøÈö™)-Ë≤∑ÈÄ≤, 15:Ë≥£Âá∫, 16:Ë≤∑Ë≥£Ë∂Ö
        // 17:Ëá™ÁáüÂïÜÂêàË®àË≤∑Ë≥£Ë∂Ö, 18:‰∏âÂ§ßÊ≥ï‰∫∫Ë≤∑Ë≥£Ë∂ÖÂêàË®à
        async function fetchTPExInstitutional(stockCode, date) {
            try {
                // ËΩâÊèõÁÇ∫Ê∞ëÂúãÂπ¥Ê†ºÂºè
                const dateParts = date.split(/[\/\-]/);
                let year, month, day;
                
                if (dateParts[0].length === 4) {
                    // Ë•øÂÖÉÂπ¥Ê†ºÂºè 2024/01/23 Êàñ 2024-01-23
                    year = parseInt(dateParts[0]) - 1911;
                    month = dateParts[1];
                    day = dateParts[2];
                } else {
                    // ÂèØËÉΩÂ∑≤Á∂ìÊòØÊ∞ëÂúãÂπ¥
                    year = parseInt(dateParts[0]);
                    month = dateParts[1];
                    day = dateParts[2];
                }
                
                const dateStr = `${year}/${month.padStart(2, '0')}/${day.padStart(2, '0')}`;
                const url = `https://www.tpex.org.tw/web/stock/3insti/daily_trade/3itrade_hedge_result.php?l=zh-tw&o=json&se=EW&t=D&d=${dateStr}&s=0,asc`;
                const data = await fetchWithProxy(url);
                
                if (data && data.aaData) {
                    const stockRow = data.aaData.find(row => row[0].trim() === stockCode);
                    if (stockRow) {
                        const parseNum = (val) => {
                            if (val === null || val === undefined) return 0;
                            let cleaned = String(val).replace(/,/g, '').replace(/‚àí/g, '-');
                            return parseInt(cleaned) || 0;
                        };
                        
                        // Â§ñË≥á = Â§ñÈô∏Ë≥á(‰∏çÂê´Â§ñË≥áËá™ÁáüÂïÜ) + Â§ñË≥áËá™ÁáüÂïÜ
                        const foreignNet = parseNum(stockRow[4]) + parseNum(stockRow[7]);
                        const trustNet = parseNum(stockRow[10]);  // Êäï‰ø°Ë≤∑Ë≥£Ë∂Ö
                        const dealerNet = parseNum(stockRow[17]); // Ëá™ÁáüÂïÜÂêàË®àË≤∑Ë≥£Ë∂Ö
                        
                        // ËΩâÊèõÁÇ∫ÂºµÊï∏ÔºàËÇ°Êï∏ / 1000Ôºâ
                        return {
                            date: date,
                            foreignNet: Math.round(foreignNet / 1000),
                            trustNet: Math.round(trustNet / 1000),
                            dealerNet: Math.round(dealerNet / 1000)
                        };
                    }
                }
                return null;
            } catch (e) {
                console.log('TPEx institutional fetch error:', e);
                return null;
            }
        }

        function calculateAllIndicators() {
            const closes = stockData.map(d => d.close);
            const highs = stockData.map(d => d.high);
            const lows = stockData.map(d => d.low);
            const volumes = stockData.map(d => d.volume);

            // Calculate Moving Averages
            technicalIndicators.ma5 = calculateMA(closes, 5);
            technicalIndicators.ma10 = calculateMA(closes, 10);
            technicalIndicators.ma20 = calculateMA(closes, 20);

            // Calculate RSI
            technicalIndicators.rsi = calculateRSI(closes, 14);

            // Calculate KD
            const kd = calculateKD(highs, lows, closes, 9);
            technicalIndicators.k = kd.k;
            technicalIndicators.d = kd.d;

            // Calculate MACD
            const macd = calculateMACD(closes);
            technicalIndicators.dif = macd.dif;
            technicalIndicators.macd = macd.macd;
            technicalIndicators.osc = macd.osc;

            // Calculate Bollinger Bands
            technicalIndicators.bollinger = calculateBollinger(closes, 20);

            // Now filter stockData to only show selected date range (remove buffer data)
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            // Find the index range for the selected dates
            let startIdx = 0;
            let endIdx = stockData.length - 1;
            
            for (let i = 0; i < stockData.length; i++) {
                if (stockData[i].dateObj >= startDate) {
                    startIdx = i;
                    break;
                }
            }
            
            for (let i = stockData.length - 1; i >= 0; i--) {
                if (stockData[i].dateObj <= endDate) {
                    endIdx = i;
                    break;
                }
            }
            
            // Slice all data to selected range
            stockData = stockData.slice(startIdx, endIdx + 1);
            technicalIndicators.ma5 = technicalIndicators.ma5.slice(startIdx, endIdx + 1);
            technicalIndicators.ma10 = technicalIndicators.ma10.slice(startIdx, endIdx + 1);
            technicalIndicators.ma20 = technicalIndicators.ma20.slice(startIdx, endIdx + 1);
            technicalIndicators.rsi = technicalIndicators.rsi.slice(startIdx, endIdx + 1);
            technicalIndicators.k = technicalIndicators.k.slice(startIdx, endIdx + 1);
            technicalIndicators.d = technicalIndicators.d.slice(startIdx, endIdx + 1);
            technicalIndicators.dif = technicalIndicators.dif.slice(startIdx, endIdx + 1);
            technicalIndicators.macd = technicalIndicators.macd.slice(startIdx, endIdx + 1);
            technicalIndicators.osc = technicalIndicators.osc.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.upper = technicalIndicators.bollinger.upper.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.middle = technicalIndicators.bollinger.middle.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.lower = technicalIndicators.bollinger.lower.slice(startIdx, endIdx + 1);

            // Recalculate volume analysis with filtered data
            const filteredVolumes = stockData.map(d => d.volume);
            const last20Volumes = filteredVolumes.slice(-Math.min(20, filteredVolumes.length));
            technicalIndicators.avgVolume = last20Volumes.reduce((a, b) => a + b, 0) / last20Volumes.length;
            technicalIndicators.volumeRatio = filteredVolumes[filteredVolumes.length - 1] / technicalIndicators.avgVolume;

            // Support and Resistance (last 20 days of filtered data)
            const recentHighs = highs.slice(startIdx, endIdx + 1).slice(-20);
            const recentLows = lows.slice(startIdx, endIdx + 1).slice(-20);
            technicalIndicators.resistance = Math.max(...recentHighs);
            technicalIndicators.support = Math.min(...recentLows);

            // Generate alerts
            technicalIndicators.alerts = generateAlerts();
        }

        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / period);
                }
            }
            return result;
        }

        function calculateRSI(data, period) {
            const result = [];
            let gains = [];
            let losses = [];

            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    result.push(null);
                    continue;
                }

                const change = data[i] - data[i - 1];
                const gain = change > 0 ? change : 0;
                const loss = change < 0 ? -change : 0;

                gains.push(gain);
                losses.push(loss);

                if (i < period) {
                    result.push(null);
                } else {
                    const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
                    const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
                    
                    if (avgLoss === 0) {
                        result.push(100);
                    } else {
                        const rs = avgGain / avgLoss;
                        result.push(100 - (100 / (1 + rs)));
                    }
                }
            }
            return result;
        }

        function calculateKD(highs, lows, closes, period) {
            const k = [];
            const d = [];
            let prevK = 50;
            let prevD = 50;

            for (let i = 0; i < closes.length; i++) {
                if (i < period - 1) {
                    k.push(null);
                    d.push(null);
                    continue;
                }

                const highN = Math.max(...highs.slice(i - period + 1, i + 1));
                const lowN = Math.min(...lows.slice(i - period + 1, i + 1));
                
                const rsv = highN === lowN ? 50 : ((closes[i] - lowN) / (highN - lowN)) * 100;
                
                const currentK = (2/3) * prevK + (1/3) * rsv;
                const currentD = (2/3) * prevD + (1/3) * currentK;
                
                k.push(currentK);
                d.push(currentD);
                
                prevK = currentK;
                prevD = currentD;
            }

            return { k, d };
        }

        function calculateMACD(data) {
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            
            const dif = [];
            for (let i = 0; i < data.length; i++) {
                if (ema12[i] === null || ema26[i] === null) {
                    dif.push(null);
                } else {
                    dif.push(ema12[i] - ema26[i]);
                }
            }

            const macd = calculateEMA(dif.filter(d => d !== null), 9);
            const paddedMacd = Array(data.length - macd.length).fill(null).concat(macd);

            const osc = [];
            for (let i = 0; i < data.length; i++) {
                if (dif[i] === null || paddedMacd[i] === null) {
                    osc.push(null);
                } else {
                    osc.push((dif[i] - paddedMacd[i]) * 2);
                }
            }

            return { dif, macd: paddedMacd, osc };
        }

        function calculateEMA(data, period) {
            const result = [];
            const multiplier = 2 / (period + 1);
            
            const validData = data.filter(d => d !== null);
            if (validData.length < period) {
                return data.map(() => null);
            }

            let ema = validData.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            let validIndex = 0;
            for (let i = 0; i < data.length; i++) {
                if (data[i] === null) {
                    result.push(null);
                    continue;
                }
                
                if (validIndex < period - 1) {
                    result.push(null);
                } else if (validIndex === period - 1) {
                    result.push(ema);
                } else {
                    ema = (data[i] - ema) * multiplier + ema;
                    result.push(ema);
                }
                validIndex++;
            }
            
            return result;
        }

        function calculateBollinger(data, period) {
            const middle = calculateMA(data, period);
            const upper = [];
            const lower = [];

            for (let i = 0; i < data.length; i++) {
                if (middle[i] === null) {
                    upper.push(null);
                    lower.push(null);
                } else {
                    const slice = data.slice(i - period + 1, i + 1);
                    const std = Math.sqrt(slice.reduce((sum, val) => sum + Math.pow(val - middle[i], 2), 0) / period);
                    upper.push(middle[i] + 2 * std);
                    lower.push(middle[i] - 2 * std);
                }
            }

            return { upper, middle, lower };
        }

        function generateAlerts() {
            const alerts = [];
            const n = stockData.length - 1;
            const closes = stockData.map(d => d.close);
            
            // 1. MA Cross Analysis
            const ma5 = technicalIndicators.ma5;
            const ma10 = technicalIndicators.ma10;
            const ma20 = technicalIndicators.ma20;
            
            if (ma5[n] && ma20[n] && ma5[n-1] && ma20[n-1]) {
                // Golden Cross
                if (ma5[n] > ma20[n] && ma5[n-1] <= ma20[n-1]) {
                    alerts.push({
                        type: 'bullish',
                        priority: 1,
                        title: 'ÂùáÁ∑öÈªÉÈáë‰∫§Âèâ',
                        description: 'MA5 Âæû‰∏ãÊñπÁ©øË∂ä MA20Ôºå‰∏≠ÊúüË∂®Âã¢ÂèØËÉΩËΩâÂ§ö'
                    });
                }
                // Death Cross
                if (ma5[n] < ma20[n] && ma5[n-1] >= ma20[n-1]) {
                    alerts.push({
                        type: 'bearish',
                        priority: 1,
                        title: 'ÂùáÁ∑öÊ≠ª‰∫°‰∫§Âèâ',
                        description: 'MA5 Âæû‰∏äÊñπË∑åÁ†¥ MA20Ôºå‰∏≠ÊúüË∂®Âã¢ÂèØËÉΩËΩâÁ©∫'
                    });
                }
            }

            // MA Arrangement
            if (ma5[n] && ma10[n] && ma20[n]) {
                if (ma5[n] > ma10[n] && ma10[n] > ma20[n]) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: 'Â§öÈ†≠ÊéíÂàó',
                        description: 'MA5 > MA10 > MA20ÔºåÂùáÁ∑öÂëàÁèæÂ§öÈ†≠ÊéíÂàó'
                    });
                } else if (ma5[n] < ma10[n] && ma10[n] < ma20[n]) {
                    alerts.push({
                        type: 'bearish',
                        priority: 2,
                        title: 'Á©∫È†≠ÊéíÂàó',
                        description: 'MA5 < MA10 < MA20ÔºåÂùáÁ∑öÂëàÁèæÁ©∫È†≠ÊéíÂàó'
                    });
                }
            }

            // 2. Support/Resistance Analysis
            const currentClose = closes[n];
            const resistance = technicalIndicators.resistance;
            const support = technicalIndicators.support;

            if (currentClose > resistance * 0.995 && closes[n-1] <= resistance * 0.995) {
                alerts.push({
                    type: 'bullish',
                    priority: 1,
                    title: 'Á™ÅÁ†¥Â£ìÂäõ‰Ωç',
                    description: `ËÇ°ÂÉπÁ™ÅÁ†¥20Êó•È´òÈªû ${resistance.toFixed(2)} ÂÖÉ`
                });
            }
            if (currentClose < support * 1.005 && closes[n-1] >= support * 1.005) {
                alerts.push({
                    type: 'bearish',
                    priority: 1,
                    title: 'Ë∑åÁ†¥ÊîØÊíê‰Ωç',
                    description: `ËÇ°ÂÉπË∑åÁ†¥20Êó•‰ΩéÈªû ${support.toFixed(2)} ÂÖÉ`
                });
            }
            if (currentClose >= resistance * 0.97 && currentClose < resistance) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: 'Êé•ËøëÂ£ìÂäõ‰Ωç',
                    description: `ËÇ°ÂÉπÊé•Ëøë20Êó•È´òÈªû ${resistance.toFixed(2)} ÂÖÉÔºåÁïôÊÑèÁ™ÅÁ†¥ÊàñÂõûÊ™î`
                });
            }
            if (currentClose <= support * 1.03 && currentClose > support) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: 'Êé•ËøëÊîØÊíê‰Ωç',
                    description: `ËÇ°ÂÉπÊé•Ëøë20Êó•‰ΩéÈªû ${support.toFixed(2)} ÂÖÉÔºåÁïôÊÑèË∑åÁ†¥ÊàñÂèçÂΩà`
                });
            }

            // 3. Volume Analysis
            const volumeRatio = technicalIndicators.volumeRatio;
            const change = currentClose - closes[n-1];

            if (volumeRatio >= 2) {
                if (change > 0) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: 'ÈáèÂ¢ûÂÉπÊº≤',
                        description: `Êàê‰∫§ÈáèÁÇ∫Âπ≥ÂùáÈáèÁöÑ ${volumeRatio.toFixed(1)} ÂÄçÔºåÈÖçÂêàÂÉπÊ†º‰∏äÊº≤ÔºåÂ§öÊñπÂº∑Âã¢`
                    });
                } else {
                    alerts.push({
                        type: 'warning',
                        priority: 2,
                        title: 'ÈáèÂ¢ûÂÉπË∑å',
                        description: `Êàê‰∫§ÈáèÁÇ∫Âπ≥ÂùáÈáèÁöÑ ${volumeRatio.toFixed(1)} ÂÄçÔºåÈÖçÂêàÂÉπÊ†º‰∏ãË∑åÔºåÁïôÊÑèË≥£Â£ì`
                    });
                }
            } else if (volumeRatio < 0.5) {
                alerts.push({
                    type: 'neutral',
                    priority: 3,
                    title: 'Êàê‰∫§ÈáèËêéÁ∏Æ',
                    description: 'Êàê‰∫§Èáè‰ΩéÊñºÂπ≥ÂùáÈáè50%ÔºåÂ∏ÇÂ†¥ËßÄÊúõÊ∞£Ê∞õÊøÉÂéö'
                });
            }

            // 4. KD Analysis
            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            const prevK = technicalIndicators.k[n-1];
            const prevD = technicalIndicators.d[n-1];

            if (k > 80 && d > 80) {
                alerts.push({
                    type: 'warning',
                    priority: 2,
                    title: 'KD Ë∂ÖË≤∑',
                    description: `K=${k.toFixed(1)}, D=${d.toFixed(1)}ÔºåËÇ°ÂÉπÂèØËÉΩÈù¢Ëá®ÂõûÊ™îÂ£ìÂäõ`
                });
            }
            if (k < 20 && d < 20) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'KD Ë∂ÖË≥£',
                    description: `K=${k.toFixed(1)}, D=${d.toFixed(1)}ÔºåËÇ°ÂÉπÂèØËÉΩÂá∫ÁèæÂèçÂΩà`
                });
            }
            if (k > d && prevK <= prevD) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'KD ÈªÉÈáë‰∫§Âèâ',
                    description: 'K ÂÄºÂæû‰∏ãÊñπÁ©øË∂ä D ÂÄºÔºåÁü≠Á∑öË≤∑ÈÄ≤Ë®äËôü'
                });
            }
            if (k < d && prevK >= prevD) {
                alerts.push({
                    type: 'bearish',
                    priority: 2,
                    title: 'KD Ê≠ª‰∫°‰∫§Âèâ',
                    description: 'K ÂÄºÂæû‰∏äÊñπË∑åÁ†¥ D ÂÄºÔºåÁü≠Á∑öË≥£Âá∫Ë®äËôü'
                });
            }

            // 5. RSI Analysis
            const rsi = technicalIndicators.rsi[n];
            if (rsi > 80) {
                alerts.push({
                    type: 'warning',
                    priority: 2,
                    title: 'RSI Ë∂ÖË≤∑',
                    description: `RSI=${rsi.toFixed(1)}ÔºåËÇ°ÂÉπÂèØËÉΩÈÅéÁÜ±`
                });
            }
            if (rsi < 20) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'RSI Ë∂ÖË≥£',
                    description: `RSI=${rsi.toFixed(1)}ÔºåËÇ°ÂÉπÂèØËÉΩË∂ÖË∑å`
                });
            }

            // 6. MACD Analysis
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            const prevDif = technicalIndicators.dif[n-1];
            const prevMacd = technicalIndicators.macd[n-1];
            const prevOsc = technicalIndicators.osc[n-1];

            if (dif && macd && prevDif && prevMacd) {
                if (dif > macd && prevDif <= prevMacd) {
                    alerts.push({
                        type: 'bullish',
                        priority: 1,
                        title: 'MACD ÈªÉÈáë‰∫§Âèâ',
                        description: 'DIF Âæû‰∏ãÊñπÁ©øË∂ä MACDÔºå‰∏≠ÊúüË∂®Âã¢ÂèØËÉΩËΩâÂ§ö'
                    });
                }
                if (dif < macd && prevDif >= prevMacd) {
                    alerts.push({
                        type: 'bearish',
                        priority: 1,
                        title: 'MACD Ê≠ª‰∫°‰∫§Âèâ',
                        description: 'DIF Âæû‰∏äÊñπË∑åÁ†¥ MACDÔºå‰∏≠ÊúüË∂®Âã¢ÂèØËÉΩËΩâÁ©∫'
                    });
                }
            }
            if (osc && prevOsc) {
                if (osc > 0 && prevOsc <= 0) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: 'Êü±ÁãÄÈ´îÁøªÊ≠£',
                        description: 'MACD Êü±ÁãÄÈ´îÁî±Ë≤†ËΩâÊ≠£ÔºåÂãïËÉΩËΩâÂº∑'
                    });
                }
                if (osc < 0 && prevOsc >= 0) {
                    alerts.push({
                        type: 'bearish',
                        priority: 2,
                        title: 'Êü±ÁãÄÈ´îÁøªË≤†',
                        description: 'MACD Êü±ÁãÄÈ´îÁî±Ê≠£ËΩâË≤†ÔºåÂãïËÉΩËΩâÂº±'
                    });
                }
            }

            // 7. Bollinger Bands
            const upper = technicalIndicators.bollinger.upper[n];
            const lower = technicalIndicators.bollinger.lower[n];

            if (currentClose >= upper) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: 'Ëß∏ÂèäÂ∏ÉÊûó‰∏äËªå',
                    description: 'ËÇ°ÂÉπËß∏ÂèäÂ∏ÉÊûóÈÄöÈÅì‰∏äËªåÔºåÁü≠Á∑öÂèØËÉΩÈÅéÁÜ±'
                });
            }
            if (currentClose <= lower) {
                alerts.push({
                    type: 'bullish',
                    priority: 3,
                    title: 'Ëß∏ÂèäÂ∏ÉÊûó‰∏ãËªå',
                    description: 'ËÇ°ÂÉπËß∏ÂèäÂ∏ÉÊûóÈÄöÈÅì‰∏ãËªåÔºåÁü≠Á∑öÂèØËÉΩË∂ÖË∑å'
                });
            }

            return alerts;
        }

        function updateUI() {
            const n = stockData.length - 1;
            const latestData = stockData[n];
            const prevData = stockData[n - 1];

            // Update stock header
            document.getElementById('stockName').textContent = stockName;
            document.getElementById('displayCode').textContent = currentStockCode;
            
            // Update market tag
            const marketTag = document.getElementById('marketTag');
            if (currentMarket === 'twse') {
                marketTag.textContent = '‰∏äÂ∏Ç';
                marketTag.className = 'market-tag twse';
            } else {
                marketTag.textContent = '‰∏äÊ´É';
                marketTag.className = 'market-tag tpex';
            }
            
            const startDateDisplay = document.getElementById('startDate').value;
            const endDateDisplay = document.getElementById('endDate').value;
            document.getElementById('stockDate').textContent = `ÂàÜÊûêÊúüÈñìÔºö${startDateDisplay} Ëá≥ ${endDateDisplay}ÔºàÂÖ± ${stockData.length} Á≠Ü‰∫§ÊòìÊó•Ôºâ`;
            
            const priceElement = document.getElementById('currentPrice');
            const changeElement = document.getElementById('priceChange');
            
            priceElement.textContent = latestData.close.toFixed(2);
            
            const change = latestData.close - prevData.close;
            const changePercent = (change / prevData.close * 100);
            
            if (change >= 0) {
                priceElement.className = 'current-price price-up';
                changeElement.innerHTML = `<span style="color: var(--accent-up);">‚ñ≤ ${change.toFixed(2)} (+${changePercent.toFixed(2)}%)</span>`;
            } else {
                priceElement.className = 'current-price price-down';
                changeElement.innerHTML = `<span style="color: var(--accent-down);">‚ñº ${Math.abs(change).toFixed(2)} (${changePercent.toFixed(2)}%)</span>`;
            }

            // Update overview cards
            const techScore = calculateTechScore();
            document.getElementById('techScore').textContent = techScore + '/100';
            document.getElementById('techProgress').style.width = techScore + '%';
            
            if (techScore >= 70) {
                document.getElementById('techProgress').style.background = 'var(--accent-up)';
            } else if (techScore >= 50) {
                document.getElementById('techProgress').style.background = 'var(--accent-yellow)';
            } else {
                document.getElementById('techProgress').style.background = 'var(--accent-down)';
            }

            const rsi = technicalIndicators.rsi[n];
            document.getElementById('rsiValue').textContent = rsi ? rsi.toFixed(1) : '-';
            document.getElementById('rsiStatus').textContent = rsi > 70 ? 'Ë∂ÖË≤∑ÂçÄ' : rsi < 30 ? 'Ë∂ÖË≥£ÂçÄ' : '‰∏≠ÊÄßÂçÄ';

            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            document.getElementById('kdValue').textContent = k && d ? `${k.toFixed(1)}/${d.toFixed(1)}` : '-';
            document.getElementById('kdStatus').textContent = k > 80 ? 'Ë∂ÖË≤∑ÂçÄ' : k < 20 ? 'Ë∂ÖË≥£ÂçÄ' : '‰∏≠ÊÄßÂçÄ';

            document.getElementById('volumeRatio').textContent = technicalIndicators.volumeRatio.toFixed(2) + 'x';
            document.getElementById('volumeStatus').textContent = technicalIndicators.volumeRatio >= 2 ? 'ÊîæÈáè' : 
                technicalIndicators.volumeRatio < 0.5 ? 'ËêéÁ∏Æ' : 'Ê≠£Â∏∏';

            // Key levels
            document.getElementById('resistanceLevel').textContent = technicalIndicators.resistance.toFixed(2);
            document.getElementById('supportLevel').textContent = technicalIndicators.support.toFixed(2);
            document.getElementById('ma5Value').textContent = technicalIndicators.ma5[n] ? technicalIndicators.ma5[n].toFixed(2) : '-';
            document.getElementById('ma20Value').textContent = technicalIndicators.ma20[n] ? technicalIndicators.ma20[n].toFixed(2) : '-';

            const ma5 = technicalIndicators.ma5[n];
            const ma10 = technicalIndicators.ma10[n];
            const ma20 = technicalIndicators.ma20[n];
            if (ma5 > ma10 && ma10 > ma20) {
                document.getElementById('maStatus').textContent = 'üìà Â§öÈ†≠ÊéíÂàó';
                document.getElementById('maStatus').style.color = 'var(--accent-up)';
            } else if (ma5 < ma10 && ma10 < ma20) {
                document.getElementById('maStatus').textContent = 'üìâ Á©∫È†≠ÊéíÂàó';
                document.getElementById('maStatus').style.color = 'var(--accent-down)';
            } else {
                document.getElementById('maStatus').textContent = '‚û°Ô∏è Á≥æÁµêÊï¥ÁêÜ';
                document.getElementById('maStatus').style.color = 'var(--accent-yellow)';
            }

            // Update chart day counts
            const dayCount = stockData.length;
            document.getElementById('priceChartDays').textContent = `(${dayCount}Êó•)`;
            document.getElementById('kdChartDays').textContent = `(${dayCount}Êó•)`;
            document.getElementById('macdChartDays').textContent = `(${dayCount}Êó•)`;

            // Update KD card values
            document.getElementById('currentK').textContent = k ? k.toFixed(2) : '-';
            document.getElementById('currentD').textContent = d ? d.toFixed(2) : '-';
            updateKDSignal();

            // Update MACD card values
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            document.getElementById('currentDIF').textContent = dif ? dif.toFixed(3) : '-';
            document.getElementById('currentMACD').textContent = macd ? macd.toFixed(3) : '-';
            document.getElementById('currentOSC').textContent = osc ? osc.toFixed(3) : '-';
            if (osc) {
                document.getElementById('currentOSC').style.color = osc >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
            }
            updateMACDSignal();

            // Draw charts
            drawPriceChart();
            drawKDChart();
            drawMACDChart();

            // Update technical table
            updateTechnicalTable();

            // Update alerts
            updateAlerts();

            // Generate AI report
            generateAIReport();
            
            // Êõ¥Êñ∞Á±åÁ¢ºÈù¢
            updateInstitutionalDisplay();
            
            // È†êÂÖàË®àÁÆóÊ≥¢Êµ™ÁêÜË´ñ
            if (stockData.length >= 30) {
                try {
                    window.elliottWaveData = detectElliottWaves(stockData);
                    console.log('Elliott Wave prepared:', window.elliottWaveData.currentWave);
                } catch (e) {
                    console.error('Elliott Wave error:', e);
                }
            }
        }

        function calculateTechScore() {
            let score = 50; // Base score
            const n = stockData.length - 1;
            const alerts = technicalIndicators.alerts;

            // Adjust based on alerts
            alerts.forEach(alert => {
                const weight = alert.priority === 1 ? 8 : alert.priority === 2 ? 5 : 3;
                if (alert.type === 'bullish') {
                    score += weight;
                } else if (alert.type === 'bearish') {
                    score -= weight;
                }
            });

            // Adjust based on MA position
            const close = stockData[n].close;
            const ma20 = technicalIndicators.ma20[n];
            if (ma20 && close > ma20) score += 5;
            if (ma20 && close < ma20) score -= 5;

            return Math.max(0, Math.min(100, Math.round(score)));
        }

        function updateKDSignal() {
            const n = stockData.length - 1;
            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            const signalElement = document.getElementById('kdSignal');
            
            if (k > 80 && d > 80) {
                signalElement.textContent = '‚ö†Ô∏è Ë∂ÖË≤∑';
                signalElement.style.color = 'var(--accent-down)';
            } else if (k < 20 && d < 20) {
                signalElement.textContent = 'üí° Ë∂ÖË≥£';
                signalElement.style.color = 'var(--accent-up)';
            } else if (k > d) {
                signalElement.textContent = 'üìà ÂÅèÂ§ö';
                signalElement.style.color = 'var(--accent-up)';
            } else {
                signalElement.textContent = 'üìâ ÂÅèÁ©∫';
                signalElement.style.color = 'var(--accent-down)';
            }
        }

        function updateMACDSignal() {
            const n = stockData.length - 1;
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            const signalElement = document.getElementById('macdSignal');
            
            if (dif > macd && osc > 0) {
                signalElement.textContent = 'üìà Â§öÊñπÂº∑Âã¢';
                signalElement.style.color = 'var(--accent-up)';
            } else if (dif < macd && osc < 0) {
                signalElement.textContent = 'üìâ Á©∫ÊñπÂº∑Âã¢';
                signalElement.style.color = 'var(--accent-down)';
            } else if (dif > macd) {
                signalElement.textContent = '‚ÜóÔ∏è ÂÅèÂ§ö';
                signalElement.style.color = 'var(--accent-up)';
            } else {
                signalElement.textContent = '‚ÜòÔ∏è ÂÅèÁ©∫';
                signalElement.style.color = 'var(--accent-down)';
            }
        }

        function drawPriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (charts.priceChart) {
                charts.priceChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));
            
            charts.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Êî∂Áõ§ÂÉπ',
                            data: stockData.map(d => d.close),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'MA5',
                            data: technicalIndicators.ma5,
                            borderColor: '#f59e0b',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA10',
                            data: technicalIndicators.ma10,
                            borderColor: '#8b5cf6',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA20',
                            data: technicalIndicators.ma20,
                            borderColor: '#10b981',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        function drawKDChart() {
            const ctx = document.getElementById('kdChart').getContext('2d');
            
            if (charts.kdChart) {
                charts.kdChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));

            charts.kdChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'K',
                            data: technicalIndicators.k,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'D',
                            data: technicalIndicators.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        },
                        annotation: {
                            annotations: {
                                overbought: {
                                    type: 'box',
                                    yMin: 80,
                                    yMax: 100,
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 0
                                },
                                oversold: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: 20,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 0
                                },
                                line80: {
                                    type: 'line',
                                    yMin: 80,
                                    yMax: 80,
                                    borderColor: 'rgba(16, 185, 129, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5]
                                },
                                line20: {
                                    type: 'line',
                                    yMin: 20,
                                    yMax: 20,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                stepSize: 20
                            }
                        }
                    }
                }
            });
        }

        function drawMACDChart() {
            const ctx = document.getElementById('macdChart').getContext('2d');
            
            if (charts.macdChart) {
                charts.macdChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));
            const osc = technicalIndicators.osc;
            
            // Prepare bar colors - Âè∞ÁÅ£ËÇ°Â∏ÇÔºöÊº≤Á¥ÖË∑åÁ∂†
            const barColors = osc.map(v => v >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)');

            charts.macdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Êü±ÁãÄÈ´î',
                            data: osc,
                            backgroundColor: barColors,
                            borderWidth: 0
                        },
                        {
                            type: 'line',
                            label: 'DIF',
                            data: technicalIndicators.dif,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'MACD',
                            data: technicalIndicators.macd,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        },
                        annotation: {
                            annotations: {
                                zeroLine: {
                                    type: 'line',
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: 'rgba(148, 163, 184, 0.5)',
                                    borderWidth: 1
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        // ===== Á±åÁ¢ºÈù¢ÂàÜÊûê =====
        function drawInstitutionalChart() {
            if (!institutionalHistory || institutionalHistory.length === 0) {
                document.getElementById('institutionalAnalysis').innerHTML = '<p style="color: var(--accent-yellow);">‚ö†Ô∏è Á±åÁ¢ºÊï∏ÊìöÊö´ÁÑ°Ê≥ïÂèñÂæóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ</p>';
                return;
            }
            
            const ctx = document.getElementById('institutionalChart').getContext('2d');
            
            if (charts.institutionalChart) {
                charts.institutionalChart.destroy();
            }
            
            const labels = institutionalHistory.map(d => d.date.substring(5));
            const foreignData = institutionalHistory.map(d => d.foreign / 1000); // ËΩâÊèõÁÇ∫ÂçÉÂºµ
            const investmentData = institutionalHistory.map(d => d.investment / 1000);
            const dealerData = institutionalHistory.map(d => d.dealer / 1000);
            const priceData = institutionalHistory.map(d => d.price);
            
            charts.institutionalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Â§ñË≥á (ÂçÉÂºµ)',
                            data: foreignData,
                            backgroundColor: foreignData.map(v => v >= 0 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(59, 130, 246, 0.4)'),
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Êäï‰ø° (ÂçÉÂºµ)',
                            data: investmentData,
                            backgroundColor: investmentData.map(v => v >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(239, 68, 68, 0.4)'),
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Ëá™ÁáüÂïÜ (ÂçÉÂºµ)',
                            data: dealerData,
                            backgroundColor: dealerData.map(v => v >= 0 ? 'rgba(168, 85, 247, 0.8)' : 'rgba(168, 85, 247, 0.4)'),
                            borderColor: '#a855f7',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'ËÇ°ÂÉπ',
                            data: priceData,
                            type: 'line',
                            borderColor: '#f59e0b',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b',
                            yAxisID: 'y1',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#94a3b8' }
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8'
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(45, 58, 79, 0.5)' },
                            ticks: { color: '#64748b', maxTicksLimit: 12 }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: 'rgba(45, 58, 79, 0.5)' },
                            ticks: { color: '#64748b' },
                            title: {
                                display: true,
                                text: 'Ë≤∑Ë≥£Ë∂Ö (ÂçÉÂºµ)',
                                color: '#64748b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#f59e0b' },
                            title: {
                                display: true,
                                text: 'ËÇ°ÂÉπ',
                                color: '#f59e0b'
                            }
                        }
                    }
                }
            });
        }
        
        function updateInstitutionalDisplay() {
            // Êõ¥Êñ∞Áï∂Êó•Ë≤∑Ë≥£Ë∂ÖÂç°Áâá
            if (institutionalData) {
                const foreign = institutionalData.foreign || 0;
                const investment = institutionalData.investment || 0;
                const dealer = institutionalData.dealer || 0;
                const total = foreign + investment + dealer;
                
                const foreignEl = document.getElementById('foreignNet');
                const investmentEl = document.getElementById('investmentNet');
                const dealerEl = document.getElementById('dealerNet');
                const totalEl = document.getElementById('totalInstitutional');
                
                foreignEl.textContent = `${foreign >= 0 ? '+' : ''}${foreign.toLocaleString()} Âºµ`;
                foreignEl.style.color = foreign >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                
                investmentEl.textContent = `${investment >= 0 ? '+' : ''}${investment.toLocaleString()} Âºµ`;
                investmentEl.style.color = investment >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                
                dealerEl.textContent = `${dealer >= 0 ? '+' : ''}${dealer.toLocaleString()} Âºµ`;
                dealerEl.style.color = dealer >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                
                totalEl.textContent = `${total >= 0 ? '+' : ''}${total.toLocaleString()} Âºµ`;
                totalEl.style.color = total >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                
                // ÁîüÊàêÁ±åÁ¢ºÂàÜÊûêÊñáÂ≠ó
                generateInstitutionalAnalysis(foreign, investment, dealer, total);
            }
            
            // Áπ™Ë£ΩÂúñË°®
            drawInstitutionalChart();
        }
        
        function generateInstitutionalAnalysis(foreign, investment, dealer, total) {
            let html = '';
            
            // Â§ñË≥áÂàÜÊûê
            if (foreign > 0) {
                html += `<p>üè¶ <strong>Â§ñË≥áË≤∑Ë∂Ö ${foreign.toLocaleString()} Âºµ</strong>ÔºöÂ§ñË≥áÊåÅÁ∫åÁúãÂ•ΩÔºåÁÇ∫ËÇ°ÂÉπÂ∏∂‰æÜÊîØÊíêÂäõÈÅì„ÄÇ</p>`;
            } else if (foreign < 0) {
                html += `<p>üè¶ <strong>Â§ñË≥áË≥£Ë∂Ö ${Math.abs(foreign).toLocaleString()} Âºµ</strong>ÔºöÂ§ñË≥áË™øÁØÄÊåÅËÇ°ÔºåÈúÄÁïôÊÑèÂæåÁ∫åÂãïÂêë„ÄÇ</p>`;
            } else {
                html += `<p>üè¶ <strong>Â§ñË≥á‰ªäÊó•ÁÑ°Ë≤∑Ë≥£Ë∂Ö</strong>ÔºöÂ§ñË≥áËßÄÊúõ‰∏≠„ÄÇ</p>`;
            }
            
            // Êäï‰ø°ÂàÜÊûê
            if (investment > 0) {
                html += `<p>üìà <strong>Êäï‰ø°Ë≤∑Ë∂Ö ${investment.toLocaleString()} Âºµ</strong>ÔºöÊäï‰ø°ÊåÅÁ∫åÂä†Á¢ºÔºåÈ°ØÁ§∫Ê≥ï‰∫∫ÁúãÂ•ΩÂæåÂ∏Ç„ÄÇ</p>`;
            } else if (investment < 0) {
                html += `<p>üìà <strong>Êäï‰ø°Ë≥£Ë∂Ö ${Math.abs(investment).toLocaleString()} Âºµ</strong>ÔºöÊäï‰ø°Ë™øÁØÄÈÉ®‰ΩçÔºåÂèØËÉΩÁç≤Âà©‰∫ÜÁµê„ÄÇ</p>`;
            } else {
                html += `<p>üìà <strong>Êäï‰ø°‰ªäÊó•ÁÑ°Ë≤∑Ë≥£Ë∂Ö</strong>ÔºöÊäï‰ø°ËßÄÊúõ‰∏≠„ÄÇ</p>`;
            }
            
            // Ëá™ÁáüÂïÜÂàÜÊûê
            if (dealer > 0) {
                html += `<p>üè¢ <strong>Ëá™ÁáüÂïÜË≤∑Ë∂Ö ${dealer.toLocaleString()} Âºµ</strong>ÔºöËá™ÁáüÂïÜÈÄ≤Â†¥‰ΩàÂ±Ä„ÄÇ</p>`;
            } else if (dealer < 0) {
                html += `<p>üè¢ <strong>Ëá™ÁáüÂïÜË≥£Ë∂Ö ${Math.abs(dealer).toLocaleString()} Âºµ</strong>ÔºöËá™ÁáüÂïÜË™øÁØÄÊåÅËÇ°„ÄÇ</p>`;
            } else {
                html += `<p>üè¢ <strong>Ëá™ÁáüÂïÜ‰ªäÊó•ÁÑ°Ë≤∑Ë≥£Ë∂Ö</strong>ÔºöËá™ÁáüÂïÜËßÄÊúõ‰∏≠„ÄÇ</p>`;
            }
            
            // Á∏ΩÁµê
            html += '<hr style="border-color: var(--border-color); margin: 15px 0;">';
            if (total > 0) {
                html += `<p style="color: var(--accent-up);"><strong>üìä ‰∏âÂ§ßÊ≥ï‰∫∫ÂêàË®àË≤∑Ë∂Ö ${total.toLocaleString()} Âºµ</strong>ÔºåÁ±åÁ¢ºÈù¢ÂÅèÂ§öÔºåÊúâÂà©ËÇ°ÂÉπ‰∏äÊº≤„ÄÇ</p>`;
            } else if (total < 0) {
                html += `<p style="color: var(--accent-down);"><strong>üìä ‰∏âÂ§ßÊ≥ï‰∫∫ÂêàË®àË≥£Ë∂Ö ${Math.abs(total).toLocaleString()} Âºµ</strong>ÔºåÁ±åÁ¢ºÈù¢ÂÅèÁ©∫ÔºåÈúÄÁïôÊÑèËÇ°ÂÉπÂ£ìÂäõ„ÄÇ</p>`;
            } else {
                html += `<p><strong>üìä ‰∏âÂ§ßÊ≥ï‰∫∫‰ªäÊó•Ë≤∑Ë≥£Ë∂ÖÊåÅÂπ≥</strong>ÔºåÁ±åÁ¢ºÈù¢‰∏≠ÊÄß„ÄÇ</p>`;
            }
            
            // Ê≠∑Âè≤Ë∂®Âã¢ÂàÜÊûê
            if (institutionalHistory && institutionalHistory.length >= 5) {
                const recent5 = institutionalHistory.slice(-5);
                const totalForeign = recent5.reduce((sum, d) => sum + d.foreign, 0);
                const totalInvestment = recent5.reduce((sum, d) => sum + d.investment, 0);
                
                html += `<p style="margin-top: 10px; color: var(--text-secondary);">üìÜ Ëøë5Êó•Â§ñË≥áÁ¥ØË®à${totalForeign >= 0 ? 'Ë≤∑Ë∂Ö' : 'Ë≥£Ë∂Ö'} ${Math.abs(totalForeign).toLocaleString()} ÂºµÔºåÊäï‰ø°Á¥ØË®à${totalInvestment >= 0 ? 'Ë≤∑Ë∂Ö' : 'Ë≥£Ë∂Ö'} ${Math.abs(totalInvestment).toLocaleString()} Âºµ„ÄÇ</p>`;
            }
            
            document.getElementById('institutionalAnalysis').innerHTML = html;
        }

        function updateTechnicalTable() {
            const tbody = document.getElementById('technicalBody');
            tbody.innerHTML = '';

            // Show last 20 days
            const recentData = stockData.slice(-20).reverse();
            
            recentData.forEach((data, index) => {
                const realIndex = stockData.length - 1 - index;
                const prevClose = realIndex > 0 ? stockData[realIndex - 1].close : data.close;
                const change = data.close - prevClose;
                const changeClass = change >= 0 ? 'price-up' : 'price-down';
                const changeSymbol = change >= 0 ? '+' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.date}</td>
                    <td>${data.close.toFixed(2)}</td>
                    <td class="${changeClass}">${changeSymbol}${change.toFixed(2)}</td>
                    <td>${(data.volume / 1000).toFixed(0)}K</td>
                    <td>${technicalIndicators.ma5[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.ma10[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.ma20[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.rsi[realIndex]?.toFixed(1) || '-'}</td>
                    <td>${technicalIndicators.k[realIndex]?.toFixed(1) || '-'}</td>
                    <td>${technicalIndicators.d[realIndex]?.toFixed(1) || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAlerts() {
            const alerts = technicalIndicators.alerts;
            const container = document.getElementById('alertsList');
            container.innerHTML = '';

            let bullishCount = 0, bearishCount = 0, warningCount = 0;
            let alertScore = 0;

            // Sort alerts by priority
            alerts.sort((a, b) => a.priority - b.priority);

            alerts.forEach(alert => {
                // Count types
                if (alert.type === 'bullish') {
                    bullishCount++;
                    alertScore += alert.priority === 1 ? 20 : alert.priority === 2 ? 10 : 5;
                } else if (alert.type === 'bearish') {
                    bearishCount++;
                    alertScore -= alert.priority === 1 ? 20 : alert.priority === 2 ? 10 : 5;
                } else if (alert.type === 'warning') {
                    warningCount++;
                }

                // Get icon and tag
                let icon, tagClass, tagText;
                switch (alert.type) {
                    case 'bullish':
                        icon = 'üü¢';
                        tagClass = 'tag-bullish';
                        tagText = 'ÁúãÊº≤';
                        break;
                    case 'bearish':
                        icon = 'üî¥';
                        tagClass = 'tag-bearish';
                        tagText = 'ÁúãË∑å';
                        break;
                    case 'warning':
                        icon = 'üü°';
                        tagClass = 'tag-warning';
                        tagText = 'Ë≠¶Âëä';
                        break;
                    default:
                        icon = '‚ö™';
                        tagClass = 'tag-neutral';
                        tagText = '‰∏≠ÊÄß';
                }

                const alertHtml = `
                    <div class="alert-item priority-${alert.priority}">
                        <span class="alert-icon">${icon}</span>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-desc">${alert.description}</div>
                        </div>
                        <span class="alert-tag ${tagClass}">${tagText}</span>
                    </div>
                `;
                container.innerHTML += alertHtml;
            });

            // Update counts
            document.getElementById('bullishCount').textContent = bullishCount;
            document.getElementById('bearishCount').textContent = bearishCount;
            document.getElementById('warningCount').textContent = warningCount;

            // Update score
            alertScore = Math.max(-100, Math.min(100, alertScore));
            const scoreElement = document.getElementById('alertScore');
            scoreElement.textContent = (alertScore >= 0 ? '+' : '') + alertScore;
            
            if (alertScore >= 30) {
                scoreElement.style.color = 'var(--accent-up)';
            } else if (alertScore <= -30) {
                scoreElement.style.color = 'var(--accent-down)';
            } else {
                scoreElement.style.color = 'var(--accent-yellow)';
            }
        }

        function generateAIReport() {
            const n = stockData.length - 1;
            const latestData = stockData[n];
            const techScore = calculateTechScore();
            const alerts = technicalIndicators.alerts;

            // Calculate sentiment
            let stance = '‰∏≠ÊÄß';
            if (techScore >= 70) stance = 'ÂÅèÂ§ö';
            else if (techScore >= 90) stance = 'Ê•µÂ∫¶ÁúãÂ§ö';
            else if (techScore <= 30) stance = 'ÂÅèÁ©∫';
            else if (techScore <= 10) stance = 'Ê•µÂ∫¶ÁúãÁ©∫';

            // Generate report content
            let report = `
<div class="analysis-section">
    <h4>üìä Á±åÁ¢ºÈù¢Ë©ïÂàÜÔºö${institutionalData ? '65' : 'N/A'}/100</h4>
    <p>Á±åÁ¢ºÂàÜÊûêÔºö${institutionalData ? `Â§ñË≥á‰ªäÊó•${institutionalData.foreign >= 0 ? 'Ë≤∑Ë∂Ö' : 'Ë≥£Ë∂Ö'} ${Math.abs(institutionalData.foreign).toLocaleString()} ÂºµÔºåÊäï‰ø°${institutionalData.investment >= 0 ? 'Ë≤∑Ë∂Ö' : 'Ë≥£Ë∂Ö'} ${Math.abs(institutionalData.investment).toLocaleString()} ÂºµÔºåËá™ÁáüÂïÜ${institutionalData.dealer >= 0 ? 'Ë≤∑Ë∂Ö' : 'Ë≥£Ë∂Ö'} ${Math.abs(institutionalData.dealer).toLocaleString()} Âºµ„ÄÇ` : 'Á±åÁ¢ºÊï∏ÊìöÊö´ÁÑ°Ê≥ïÂèñÂæóÔºåË´ãÂèÉËÄÉÊäÄË°ìÈù¢ÂàÜÊûê„ÄÇ'}</p>
</div>

<div class="analysis-section">
    <h4>üì∞ Ê∂àÊÅØÈù¢Ë©ïÂàÜÔºöÂæÖÊêúÂ∞ã/100</h4>
    <p>Âª∫Ë≠∞ÊêúÂ∞ãÊúÄÊñ∞ÂÖ¨Âè∏ÁáüÈÅã„ÄÅÁî¢Ê•≠ÂãïÊÖã„ÄÅÊ≥ïË™™ÊúÉ„ÄÅË≤°Â†±Á≠âË≥áË®äÔºå‰ª•Áç≤ÂæóÂÆåÊï¥Ê∂àÊÅØÈù¢ÂàÜÊûê„ÄÇ</p>
</div>

<hr style="border-color: var(--border-color); margin: 20px 0;">

<div class="analysis-section">
    <h4>üéØ Á∂úÂêàÁ†îÂà§</h4>
    
    <p><strong>üìç Â§öÁ©∫Á´ãÂ†¥Ôºö${stance}</strong></p>
    
    <p><strong>üìà Áü≠Á∑öÈ†êÊ∏¨Ôºö</strong>${generatePrediction()}</p>
    
    <p><strong>üéØ ÈóúÈçµÂÉπ‰ΩçÔºö</strong></p>
    <ul style="list-style: none; padding-left: 20px;">
        <li>‚Ä¢ Â£ìÂäõÔºö${technicalIndicators.resistance.toFixed(2)} ÂÖÉ</li>
        <li>‚Ä¢ ÊîØÊíêÔºö${technicalIndicators.support.toFixed(2)} ÂÖÉ</li>
    </ul>
</div>

<div class="analysis-section">
    <h4>üí° Êìç‰ΩúÂª∫Ë≠∞</h4>
    ${generateSuggestion()}
</div>

<div class="analysis-section">
    <h4>‚ö†Ô∏è È¢®Èö™ÊèêÈÜí</h4>
    <ul style="list-style: none; padding-left: 0;">
        ${generateRisks()}
    </ul>
</div>
`;

            document.getElementById('aiReportContent').innerHTML = report;
        }

        function generatePrediction() {
            const n = stockData.length - 1;
            const ma5 = technicalIndicators.ma5[n];
            const ma20 = technicalIndicators.ma20[n];
            const close = stockData[n].close;
            const k = technicalIndicators.k[n];
            
            if (ma5 > ma20 && close > ma20) {
                return 'ÊäÄË°ìÈù¢Á´ôÁ©©ÂùáÁ∑ö‰πã‰∏äÔºåÈÖçÂêàÂùáÁ∑öÂ§öÈ†≠ÊéíÂàóÔºåÈ†êÊúüÁ∂≠ÊåÅÂ§öÊñπËµ∞Âã¢„ÄÇ';
            } else if (ma5 < ma20 && close < ma20) {
                return 'ÊäÄË°ìÈù¢Ë∑åÁ†¥ÂùáÁ∑öÔºåÈÖçÂêàÂùáÁ∑öÁ©∫È†≠ÊéíÂàóÔºåÁü≠Á∑öÂÅèÂº±Êï¥ÁêÜ„ÄÇ';
            } else if (k < 20) {
                return 'KD ÈÄ≤ÂÖ•Ë∂ÖË≥£ÂçÄÔºåÊúâÊ©üÊúÉÂá∫ÁèæÊäÄË°ìÊÄßÂèçÂΩà„ÄÇ';
            } else if (k > 80) {
                return 'KD ÈÄ≤ÂÖ•Ë∂ÖË≤∑ÂçÄÔºåÁü≠Á∑öÁïôÊÑèÂõûÊ™îÂ£ìÂäõ„ÄÇ';
            }
            return 'ÁõÆÂâçËôïÊñºÂùáÁ∑öÁ≥æÁµêÊï¥ÁêÜÈöéÊÆµÔºåÂª∫Ë≠∞Á≠âÂæÖÊñπÂêëÊòéÁ¢∫ÂæåÂÜçË°åÂ∏ÉÂ±Ä„ÄÇ';
        }

        function generateSuggestion() {
            const n = stockData.length - 1;
            const close = stockData[n].close;
            const support = technicalIndicators.support;
            const resistance = technicalIndicators.resistance;
            const techScore = calculateTechScore();
            
            const stopLoss = (support * 0.97).toFixed(2);
            const target = (resistance * 1.03).toFixed(2);
            
            if (techScore >= 70) {
                return `
                    <ul style="list-style: none; padding-left: 0;">
                        <li>‚Ä¢ Á≠ñÁï•ÔºöÈ†ÜÂã¢ÂÅèÂ§öÊìç‰Ωú</li>
                        <li>‚Ä¢ ÈÄ≤Â†¥Ôºö${support.toFixed(2)} ÂÖÉÈôÑËøëÂàÜÊâπÂ∏ÉÂ±Ä</li>
                        <li>‚Ä¢ ÂÅúÊêçÔºö${stopLoss} ÂÖÉÔºàÁ¥Ñ -3%Ôºâ</li>
                        <li>‚Ä¢ ÂÅúÂà©Ôºö${target} ÂÖÉÔºàÁ¥Ñ +${((target/close - 1) * 100).toFixed(1)}%Ôºâ</li>
                    </ul>
                `;
            } else if (techScore <= 30) {
                return `
                    <ul style="list-style: none; padding-left: 0;">
                        <li>‚Ä¢ Á≠ñÁï•Ôºö‰øùÂÆàËßÄÊúõÊàñÊ∏õÁ¢º</li>
                        <li>‚Ä¢ Ëã•ÊåÅÊúâÔºöÂèØÊñºÂèçÂΩàÊôÇÊ∏õÁ¢º</li>
                        <li>‚Ä¢ Á©∫ÊâãËÄÖÔºöÂª∫Ë≠∞Á≠âÂæÖÊ≠¢Á©©Ë®äËôü</li>
                        <li>‚Ä¢ ÈóúÊ≥®Ôºö${support.toFixed(2)} ÂÖÉÊòØÂê¶ÊúâÊïàÊîØÊíê</li>
                    </ul>
                `;
            }
            return `
                <ul style="list-style: none; padding-left: 0;">
                    <li>‚Ä¢ Á≠ñÁï•ÔºöÂçÄÈñìÊìç‰ΩúÊàñËßÄÊúõ</li>
                    <li>‚Ä¢ ‰∏äÊ™îÂ£ìÂäõÔºö${resistance.toFixed(2)} ÂÖÉ</li>
                    <li>‚Ä¢ ‰∏ãÊ™îÊîØÊíêÔºö${support.toFixed(2)} ÂÖÉ</li>
                    <li>‚Ä¢ Âª∫Ë≠∞ÔºöÁ≠âÂæÖÁ™ÅÁ†¥ÊñπÂêëÊòéÁ¢∫ÂæåÂÜçË°åÂ∏ÉÂ±Ä</li>
                </ul>
            `;
        }

        function generateRisks() {
            const risks = [];
            const n = stockData.length - 1;
            const k = technicalIndicators.k[n];
            const volumeRatio = technicalIndicators.volumeRatio;
            
            risks.push('<li>‚Ä¢ Â§ßÁõ§Á≥ªÁµ±ÊÄßÈ¢®Èö™ÈúÄÊåÅÁ∫åÈóúÊ≥®</li>');
            
            if (k > 80) {
                risks.push('<li>‚Ä¢ KD ÊåáÊ®ôË∂ÖË≤∑ÔºåÁïôÊÑèÁü≠Á∑öÂõûÊ™îÈ¢®Èö™</li>');
            }
            if (volumeRatio < 0.5) {
                risks.push('<li>‚Ä¢ Êàê‰∫§ÈáèËêéÁ∏ÆÔºåÊµÅÂãïÊÄßÈ¢®Èö™ËºÉÈ´ò</li>');
            }
            if (volumeRatio > 2) {
                risks.push('<li>‚Ä¢ Êàê‰∫§ÈáèÁï∞Â∏∏ÊîæÂ§ßÔºåÁïôÊÑè‰∏ªÂäõÂãïÂêë</li>');
            }
            risks.push('<li>‚Ä¢ Âª∫Ë≠∞ÊêúÂ∞ãÊúÄÊñ∞Ê∂àÊÅØÈù¢Ë≥áË®ä‰ª•ÂÆåÂñÑÂàÜÊûê</li>');
            
            return risks.join('');
        }

        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');

            // Redraw charts if needed
            if (tabId === 'kd-chart' && charts.kdChart) {
                charts.kdChart.update();
            }
            if (tabId === 'macd-chart' && charts.macdChart) {
                charts.macdChart.update();
            }
            if (tabId === 'elliott-wave' && stockData.length > 0) {
                analyzeElliottWave();
            }
        }

        function copyReport() {
            const reportContent = document.getElementById('aiReportContent').innerText;
            navigator.clipboard.writeText(reportContent).then(() => {
                alert('Â†±ÂëäÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ');
            });
        }

        // ===== ÊéíË°åÊ¶úÂäüËÉΩ =====
        let currentRankingType = 'gainers';
        
        // Êë∫Áñä/Â±ïÈñãÊéíË°åÊ¶ú
        function toggleRankingSection() {
            const section = document.getElementById('rankingSection');
            section.classList.toggle('collapsed');
            
            // ‰øùÂ≠òÁãÄÊÖãÂà∞ localStorage
            const isCollapsed = section.classList.contains('collapsed');
            localStorage.setItem('ranking_collapsed', isCollapsed ? 'true' : 'false');
        }
        
        // ÂàùÂßãÂåñÊôÇËÆÄÂèñÊë∫ÁñäÁãÄÊÖã
        function initRankingState() {
            const isCollapsed = localStorage.getItem('ranking_collapsed') === 'true';
            if (isCollapsed) {
                document.getElementById('rankingSection').classList.add('collapsed');
            }
        }
        
        function switchRankingType(type) {
            currentRankingType = type;
            document.querySelectorAll('.ranking-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.ranking-tab-btn[data-type="${type}"]`).classList.add('active');
            
            const headerMap = {
                'gainers': 'Êàê‰∫§Èáè(Âºµ)',
                'losers': 'Êàê‰∫§Èáè(Âºµ)',
                'volume': 'Êàê‰∫§Èáè(Âºµ)',
                'value': 'Êàê‰∫§ÂÄº(ÂÑÑ)'
            };
            document.getElementById('rankingValueHeader').textContent = headerMap[type];
            document.getElementById('rankingTableContainer').style.display = 'none';
        }

        async function fetchRankingData() {
            const market = document.getElementById('rankingMarket').value;
            const loading = document.getElementById('rankingLoading');
            const tableContainer = document.getElementById('rankingTableContainer');
            const updateTime = document.getElementById('rankingUpdateTime');
            
            loading.style.display = 'flex';
            tableContainer.style.display = 'none';
            updateTime.textContent = '‚è≥ Ê≠£Âú®ËºâÂÖ•ÊéíË°åÊ¶ú...';
            
            try {
                let data = [];
                
                if (market === 'tse') {
                    data = await fetchTWSERanking(currentRankingType);
                } else {
                    data = await fetchTPExRanking(currentRankingType);
                }
                
                console.log('Ranking result:', data);
                
                if (data.length > 0) {
                    renderRankingTable(data);
                    tableContainer.style.display = 'block';
                    const now = new Date();
                    updateTime.textContent = 'üìÖ Êõ¥Êñ∞ÊôÇÈñì: ' + now.toLocaleString('zh-TW');
                } else {
                    updateTime.textContent = '‚ùå ÁÑ°Ê≥ïÂèñÂæóÊéíË°åÊ¶úË≥áÊñôÔºåË´ãÁ®çÂæåÂÜçË©¶';
                }
            } catch (error) {
                console.error('ÊéíË°åÊ¶úËºâÂÖ•Â§±Êïó:', error);
                updateTime.textContent = '‚ùå ËºâÂÖ•Â§±Êïó: ' + error.message;
            } finally {
                loading.style.display = 'none';
            }
        }

        // ÂæûË≠â‰∫§ÊâÄÁç≤Âèñ‰∏äÂ∏ÇÊéíË°åÊ¶ú
        async function fetchTWSERanking(type) {
            const datesToTry = getRecentTradeDates(5);
            
            for (const dateStr of datesToTry) {
                try {
                    console.log('Trying TWSE date:', dateStr);
                    
                    // Áµ±‰∏Ä‰ΩøÁî® MI_INDEX ÂÖ®Â∏ÇÂ†¥Ë≥áÊñôÔºåËá™Ë°åÊéíÂ∫è
                    const url = 'https://www.twse.com.tw/rwd/zh/afterTrading/MI_INDEX?date=' + dateStr + '&type=ALLBUT0999&response=json';
                    const data = await fetchWithProxy(url);
                    
                    if (data && data.stat === 'OK' && data.tables) {
                        const result = parseTWSEAllData(data, type);
                        if (result.length > 0) {
                            console.log('Found TWSE data for', dateStr, 'type:', type);
                            return result;
                        }
                    }
                } catch (e) {
                    console.log('TWSE fetch error for', dateStr, e.message);
                }
            }
            return [];
        }
        
        function getRecentTradeDates(days) {
            const dates = [];
            let d = new Date();
            while (dates.length < days) {
                const dow = d.getDay();
                if (dow !== 0 && dow !== 6) {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dates.push(y + m + day);
                }
                d.setDate(d.getDate() - 1);
            }
            return dates;
        }
        
        function parseTWSEAllData(data, type) {
            let stocks = [];
            const pn = (v) => {
                if (!v || v === '--') return 0;
                return parseFloat(String(v).replace(/,/g, '').replace(/‚àí/g, '-').replace(/[+]/g, '')) || 0;
            };
            
            if (data.tables) {
                // MI_INDEX Ê†ºÂºè: ÈÄöÂ∏∏Âú® tables[8] ÊàñÂÖ∂‰ªñ‰ΩçÁΩÆÊúâÂÄãËÇ°Ë≥áÊñô
                // Ê¨Ñ‰Ωç: Ë≠âÂà∏‰ª£Ëôü, Ë≠âÂà∏ÂêçÁ®±, Êàê‰∫§ËÇ°Êï∏, Êàê‰∫§Á≠ÜÊï∏, Êàê‰∫§ÈáëÈ°ç, ÈñãÁõ§ÂÉπ, ÊúÄÈ´òÂÉπ, ÊúÄ‰ΩéÂÉπ, Êî∂Áõ§ÂÉπ, Êº≤Ë∑å(+/-), Êº≤Ë∑åÂÉπÂ∑Æ, ÊúÄÂæåÊè≠Á§∫Ë≤∑ÂÉπ, ...
                data.tables.forEach(t => {
                    if (t.data && t.fields && t.fields.length >= 10) {
                        t.data.forEach(row => {
                            const code = String(row[0] || '').trim();
                            if (/^\d{4}$/.test(code)) {
                                const vol = pn(row[2]);      // Êàê‰∫§ËÇ°Êï∏
                                const val = pn(row[4]);      // Êàê‰∫§ÈáëÈ°ç
                                const close = pn(row[8]);    // Êî∂Áõ§ÂÉπ
                                const changeSign = String(row[9] || '').trim(); // +/- Á¨¶Ëôü
                                let change = pn(row[10]);    // Êº≤Ë∑åÂÉπÂ∑Æ
                                
                                // ËôïÁêÜÊº≤Ë∑åÁ¨¶Ëôü
                                if (changeSign === '-' || changeSign.includes('-')) {
                                    change = -Math.abs(change);
                                } else if (changeSign === '+' || changeSign.includes('+')) {
                                    change = Math.abs(change);
                                }
                                
                                const prevClose = close - change;
                                const pct = prevClose > 0 ? (change / prevClose) * 100 : 0;
                                
                                if (close > 0) {
                                    stocks.push({
                                        code: code,
                                        name: String(row[1] || '').trim(),
                                        price: close,
                                        change: change,
                                        changePercent: pct,
                                        volume: vol,
                                        value: val
                                    });
                                }
                            }
                        });
                    }
                });
            }
            
            // Ê†πÊìöÈ°ûÂûãÊéíÂ∫è
            if (type === 'gainers') {
                stocks.sort((a, b) => b.changePercent - a.changePercent);
            } else if (type === 'losers') {
                stocks.sort((a, b) => a.changePercent - b.changePercent);
            } else if (type === 'volume') {
                stocks.sort((a, b) => b.volume - a.volume);
            } else {
                stocks.sort((a, b) => b.value - a.value);
            }
            
            return stocks.slice(0, 20).map((s, i) => ({
                rank: i + 1,
                code: s.code,
                name: s.name,
                price: s.price.toFixed(2),
                change: s.change,
                changePercent: s.changePercent,
                value: type === 'volume' 
                    ? (s.volume / 1000).toLocaleString() + ' Âºµ'
                    : type === 'value'
                    ? (s.value / 100000000).toFixed(2) + ' ÂÑÑ'
                    : (s.volume / 1000).toLocaleString() + ' Âºµ'
            }));
        }

        // ÂæûÊ´ÉË≤∑‰∏≠ÂøÉÁç≤Âèñ‰∏äÊ´ÉÊéíË°åÊ¶ú  
        async function fetchTPExRanking(type) {
            const datesToTry = getRecentROCDates(5);
            
            for (const dateStr of datesToTry) {
                try {
                    console.log('Trying TPEx date:', dateStr);
                    const url = 'https://www.tpex.org.tw/web/stock/aftertrading/otc_quotes_no1430/stk_wn1430_result.php?l=zh-tw&o=json&d=' + dateStr + '&se=EW';
                    const data = await fetchWithProxy(url);
                    
                    if (data && data.aaData && data.aaData.length > 0) {
                        console.log('Found TPEx data for', dateStr);
                        return parseTPExData(data.aaData, type);
                    }
                } catch (e) {
                    console.log('TPEx fetch error for', dateStr, e.message);
                }
            }
            return [];
        }
        
        function getRecentROCDates(days) {
            const dates = [];
            let d = new Date();
            while (dates.length < days) {
                const dow = d.getDay();
                if (dow !== 0 && dow !== 6) {
                    const y = d.getFullYear() - 1911;
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dates.push(y + '/' + m + '/' + day);
                }
                d.setDate(d.getDate() - 1);
            }
            return dates;
        }
        
        function parseTPExData(aaData, type) {
            const pn = (v) => {
                if (v == null || v === '--') return 0;
                return parseFloat(String(v).replace(/,/g, '').replace(/‚àí/g, '-')) || 0;
            };
            
            let stocks = aaData.map(row => {
                const code = String(row[0] || '').trim();
                const name = String(row[1] || '').trim();
                const price = pn(row[2]);
                const change = pn(row[3]);
                const vol = pn(row[8]);
                const val = pn(row[9]);
                const prevP = price - change;
                const pct = prevP > 0 ? (change / prevP) * 100 : 0;
                return { code, name, price, change, changePercent: pct, volume: vol, value: val };
            }).filter(s => /^\d{4}$/.test(s.code) && s.price > 0);
            
            if (type === 'gainers') stocks.sort((a, b) => b.changePercent - a.changePercent);
            else if (type === 'losers') stocks.sort((a, b) => a.changePercent - b.changePercent);
            else if (type === 'volume') stocks.sort((a, b) => b.volume - a.volume);
            else stocks.sort((a, b) => b.value - a.value);
            
            return stocks.slice(0, 20).map((s, i) => ({
                rank: i + 1,
                code: s.code,
                name: s.name,
                price: s.price.toFixed(2),
                change: s.change,
                changePercent: s.changePercent,
                value: type === 'volume' ? (s.volume / 1000).toLocaleString() + ' Âºµ' : (s.value / 100000000).toFixed(2) + ' ÂÑÑ'
            }));
        }

        function renderRankingTable(data) {
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = '';
            
            data.forEach((item, index) => {
                const isUp = item.change > 0;
                const isDown = item.change < 0;
                const colorClass = isUp ? 'color: var(--accent-up);' : (isDown ? 'color: var(--accent-down);' : '');
                const changeSymbol = isUp ? '+' : '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);">
                        <span class="ranking-rank ${index < 3 ? 'top3' : 'normal'}">${item.rank}</span>
                    </td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-weight: 600; color: var(--accent-cyan);">${item.code}</td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-family: 'Noto Sans TC', sans-serif;">${item.name}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); font-weight: 600;">${item.price}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); ${colorClass} font-weight: 600;">${changeSymbol}${typeof item.change === 'number' ? item.change.toFixed(2) : item.change}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); ${colorClass} font-weight: 600;">${changeSymbol}${typeof item.changePercent === 'number' ? item.changePercent.toFixed(2) : item.changePercent}%</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">${item.value}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);">
                        <button onclick="loadStockFromRanking('${item.code}')" style="background: var(--accent-blue); border: none; border-radius: 6px; padding: 6px 12px; color: white; cursor: pointer; font-size: 0.85rem;">üìä ÂàÜÊûê</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadStockFromRanking(code) {
            document.getElementById('stockCode').value = code;
            // Ê™¢Ê∏¨ÊòØ‰∏äÂ∏ÇÈÇÑÊòØ‰∏äÊ´ÉÔºàÊ†πÊìöÁï∂ÂâçÊéíË°åÊ¶úÈÅ∏ÊìáÔºâ
            const market = document.getElementById('rankingMarket').value === 'tse' ? 'twse' : 'tpex';
            selectMarket(market);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            startAnalysis();
        }

        // ===== Ê≥¢Êµ™ÁêÜË´ñÂàÜÊûê =====
        function analyzeElliottWave() {
            console.log('analyzeElliottWave called, stockData length:', stockData.length);
            
            if (stockData.length < 30) {
                document.getElementById('elliottAnalysis').innerHTML = '<p style="color: var(--accent-yellow);">‚ö†Ô∏è Ë´ãËºâÂÖ•Ëá≥Â∞ë 30 Á≠Ü‰∫§ÊòìÊó•Ë≥áÊñô‰ª•ÈÄ≤Ë°åÊ≥¢Êµ™ÂàÜÊûê„ÄÇ</p>';
                document.getElementById('currentWavePosition').textContent = 'Êï∏Êìö‰∏çË∂≥';
                document.getElementById('currentWaveDesc').textContent = 'Ë´ãÈÅ∏ÊìáÊõ¥Èï∑ÁöÑÂàÜÊûêÊúüÈñì';
                document.getElementById('wavePrediction').innerHTML = '<p style="color: var(--text-secondary);">ÈúÄË¶ÅÊõ¥Â§öÊï∏ÊìöÊâçËÉΩÈÄ≤Ë°åÊ≥¢Êµ™È†êÊ∏¨„ÄÇ</p>';
                return;
            }
            
            try {
                const waveAnalysis = detectElliottWaves(stockData);
                console.log('Wave analysis result:', waveAnalysis);
                renderElliottWaveDisplay(waveAnalysis);
                setTimeout(() => { drawElliottChart(waveAnalysis); }, 100);
                calculateFibonacciLevels(waveAnalysis);
            } catch (error) {
                console.error('Elliott Wave analysis error:', error);
                document.getElementById('elliottAnalysis').innerHTML = `<p style="color: var(--accent-yellow);">‚ö†Ô∏è Ê≥¢Êµ™ÂàÜÊûêÁôºÁîüÈåØË™§: ${error.message}</p>`;
            }
        }
        
        function detectElliottWaves(data) {
            const currentPrice = parseFloat(data[data.length - 1].close);
            const recentData = data.slice(-120);
            
            // ===== Á¨¨‰∏ÄÊ≠•ÔºöÊâæÂá∫ÊâÄÊúâËΩâÊäòÈªû =====
            const pivots = [];
            const windowSize = Math.max(2, Math.min(5, Math.floor(recentData.length / 25)));
            
            for (let i = windowSize; i < recentData.length - windowSize; i++) {
                const closePrice = parseFloat(recentData[i].close);
                const windowData = recentData.slice(i - windowSize, i + windowSize + 1);
                const maxClose = Math.max(...windowData.map(d => parseFloat(d.close)));
                const minClose = Math.min(...windowData.map(d => parseFloat(d.close)));
                
                if (closePrice >= maxClose && !pivots.some(p => Math.abs(p.index - i) < windowSize && p.type === 'high')) {
                    pivots.push({ index: i, price: closePrice, type: 'high', date: recentData[i].date });
                }
                if (closePrice <= minClose && !pivots.some(p => Math.abs(p.index - i) < windowSize && p.type === 'low')) {
                    pivots.push({ index: i, price: closePrice, type: 'low', date: recentData[i].date });
                }
            }
            
            // Ê™¢Êü•ÊúÄÊñ∞Êï∏ÊìöÊòØÂê¶ÁÇ∫ËøëÊúüÈ´ò‰ΩéÈªû
            const lastIdx = recentData.length - 1;
            const lastClose = parseFloat(recentData[lastIdx].close);
            const last10 = recentData.slice(-10);
            const max10 = Math.max(...last10.map(d => parseFloat(d.close)));
            const min10 = Math.min(...last10.map(d => parseFloat(d.close)));
            
            if (lastClose >= max10 && !pivots.some(p => p.index >= lastIdx - 2 && p.type === 'high')) {
                pivots.push({ index: lastIdx, price: lastClose, type: 'high', date: recentData[lastIdx].date });
            }
            if (lastClose <= min10 && !pivots.some(p => p.index >= lastIdx - 2 && p.type === 'low')) {
                pivots.push({ index: lastIdx, price: lastClose, type: 'low', date: recentData[lastIdx].date });
            }
            
            pivots.sort((a, b) => a.index - b.index);
            
            // ===== Á¨¨‰∫åÊ≠•ÔºöÂêà‰ΩµÂêåÈ°ûÂûãËΩâÊäòÈªû =====
            const mergedPivots = [];
            for (const pivot of pivots) {
                if (mergedPivots.length === 0) {
                    mergedPivots.push(pivot);
                } else {
                    const last = mergedPivots[mergedPivots.length - 1];
                    if (pivot.type === last.type) {
                        if ((pivot.type === 'high' && pivot.price > last.price) ||
                            (pivot.type === 'low' && pivot.price < last.price)) {
                            mergedPivots[mergedPivots.length - 1] = pivot;
                        }
                    } else {
                        mergedPivots.push(pivot);
                    }
                }
            }
            
            // ===== Á¨¨‰∏âÊ≠•ÔºöÈÅéÊøæÂ∞èÊ≥¢ÂãïÔºà1.5%Ôºâ=====
            const avgPrice = recentData.reduce((s, d) => s + parseFloat(d.close), 0) / recentData.length;
            const minSwing = avgPrice * 0.015;
            
            const significantPivots = [];
            for (const pivot of mergedPivots) {
                if (significantPivots.length === 0) {
                    significantPivots.push(pivot);
                } else {
                    const last = significantPivots[significantPivots.length - 1];
                    if (Math.abs(pivot.price - last.price) >= minSwing) {
                        significantPivots.push(pivot);
                    }
                }
            }
            
            // ===== Á¨¨ÂõõÊ≠•ÔºöÁ¢∫‰øùÈ´ò‰ΩéÈªû‰∫§Êõø =====
            const alternatingPivots = [];
            for (const pivot of significantPivots) {
                if (alternatingPivots.length === 0) {
                    alternatingPivots.push(pivot);
                } else {
                    const last = alternatingPivots[alternatingPivots.length - 1];
                    if (pivot.type !== last.type) {
                        alternatingPivots.push(pivot);
                    } else {
                        if ((pivot.type === 'high' && pivot.price > last.price) ||
                            (pivot.type === 'low' && pivot.price < last.price)) {
                            alternatingPivots[alternatingPivots.length - 1] = pivot;
                        }
                    }
                }
            }
            
            console.log('Pivots found:', alternatingPivots.length, alternatingPivots.map(p => `${p.type}@${p.price.toFixed(2)}`).join('‚Üí'));
            
            // ===== Á¨¨‰∫îÊ≠•ÔºöÂª∫ÊßãÊ≥¢Êµ™ =====
            const waves = [];
            const recentPivots = alternatingPivots.slice(-9);
            
            for (let i = 1; i < recentPivots.length; i++) {
                const prev = recentPivots[i - 1];
                const curr = recentPivots[i];
                waves.push({
                    start: prev.price,
                    end: curr.price,
                    startDate: prev.date,
                    endDate: curr.date,
                    type: curr.price > prev.price ? 'up' : 'down'
                });
            }
            
            console.log('Waves built:', waves.length, waves.map(w => `${w.type}(${w.start.toFixed(2)}‚Üí${w.end.toFixed(2)})`).join(' | '));
            
            // ===== Á¨¨ÂÖ≠Ê≠•ÔºöÊ®ôË®òÊ≥¢Êµ™ÔºàËâæÁï•ÁâπÊ®ôÊ∫ñÂ∫èÂàóÔºâ=====
            // 1(‚Üë) ‚Üí 2(‚Üì) ‚Üí 3(‚Üë) ‚Üí 4(‚Üì) ‚Üí 5(‚Üë) ‚Üí A(‚Üì) ‚Üí B(‚Üë) ‚Üí C(‚Üì)
            const waveSequence = [
                { label: 1, dir: 'up', impulse: true },
                { label: 2, dir: 'down', impulse: false },
                { label: 3, dir: 'up', impulse: true },
                { label: 4, dir: 'down', impulse: false },
                { label: 5, dir: 'up', impulse: true },
                { label: 'A', dir: 'down', impulse: false },
                { label: 'B', dir: 'up', impulse: false },
                { label: 'C', dir: 'down', impulse: false }
            ];
            
            const labeledWaves = [];
            if (waves.length > 0) {
                // Á¨¨‰∏ÄÂÄãÊ≥¢Êµ™ÊòØ‰∏äÊº≤‚ÜíÂæû1ÈñãÂßãÔºå‰∏ãË∑å‚ÜíÂæû2ÈñãÂßã
                let seqIdx = waves[0].type === 'up' ? 0 : 1;
                
                for (let i = 0; i < waves.length && i < 8; i++) {
                    const w = waves[i];
                    const seq = waveSequence[seqIdx % 8];
                    labeledWaves.push({
                        number: seq.label,
                        start: w.start,
                        end: w.end,
                        startDate: w.startDate,
                        endDate: w.endDate,
                        type: w.type,
                        isImpulse: seq.impulse
                    });
                    seqIdx++;
                }
            }
            
            console.log('Labeled waves:', labeledWaves.map(w => `Wave${w.number}(${w.type})`).join('‚Üí'));
            
            // ===== Á¨¨‰∏ÉÊ≠•ÔºöÂà§Êñ∑Áï∂ÂâçÊ≥¢Êµ™‰ΩçÁΩÆ =====
            let currentWave = '?';
            
            if (labeledWaves.length > 0) {
                const lastWave = labeledWaves[labeledWaves.length - 1];
                const lastLabel = lastWave.number;
                const lastEnd = lastWave.end;
                const lastStart = lastWave.start;
                const priceChange = (currentPrice - lastEnd) / lastEnd;
                const pricePos = currentPrice > lastEnd ? 'above' : 'below';
                
                console.log(`Last wave: ${lastLabel}, end: ${lastEnd.toFixed(2)}, current: ${currentPrice.toFixed(2)}, change: ${(priceChange*100).toFixed(2)}%, pos: ${pricePos}`);
                
                // Ê†πÊìöËâæÁï•ÁâπÊ≥¢Êµ™ÁêÜË´ñÂà§Êñ∑Áï∂Ââç‰ΩçÁΩÆ
                if (typeof lastLabel === 'number') {
                    switch(lastLabel) {
                        case 1: // Á¨¨1Êµ™ÁµêÊùüÔºà‰∏äÊº≤ÁµêÊùüÔºâ
                            // Êµ™2‰∏çÂèØËÉΩÂÆåÂÖ®ÂõûÊí§Êµ™1
                            if (priceChange < -0.02) {
                                currentWave = 2; // ÈÄ≤ÂÖ•Á¨¨2Êµ™‰øÆÊ≠£
                            } else if (priceChange > 0.03) {
                                currentWave = 1; // ÈÇÑÂú®Á¨¨1Êµ™Âª∂Á∫å
                            } else {
                                currentWave = pricePos === 'below' ? 2 : 1;
                            }
                            break;
                        case 2: // Á¨¨2Êµ™ÁµêÊùüÔºà‰∏ãË∑åÁµêÊùüÔºâ
                            if (priceChange > 0.02) {
                                currentWave = 3; // ÈÄ≤ÂÖ•Á¨¨3Êµ™ÔºàÈÄöÂ∏∏ÊúÄÂº∑Ôºâ
                            } else if (priceChange < -0.03) {
                                currentWave = 2; // ÈÇÑÂú®Á¨¨2Êµ™
                            } else {
                                currentWave = pricePos === 'above' ? 3 : 2;
                            }
                            break;
                        case 3: // Á¨¨3Êµ™ÁµêÊùüÔºà‰∏äÊº≤ÁµêÊùüÔºåÈÄöÂ∏∏ÊúÄÂº∑ÊúÄÈï∑Ôºâ
                            if (priceChange < -0.02) {
                                currentWave = 4; // ÈÄ≤ÂÖ•Á¨¨4Êµ™‰øÆÊ≠£
                            } else if (priceChange > 0.03) {
                                currentWave = 3; // ÈÇÑÂú®Á¨¨3Êµ™
                            } else {
                                currentWave = pricePos === 'below' ? 4 : 3;
                            }
                            break;
                        case 4: // Á¨¨4Êµ™ÁµêÊùüÔºà‰∏ãË∑åÁµêÊùüÔºâ
                            // Êµ™4ÁöÑ‰ΩéÈªû‰∏çËÉΩËàáÊµ™1È†ÇÈªûÈáçÁñä
                            if (priceChange > 0.02) {
                                currentWave = 5; // ÈÄ≤ÂÖ•Á¨¨5Êµ™
                            } else if (priceChange < -0.03) {
                                currentWave = 4; // ÈÇÑÂú®Á¨¨4Êµ™
                            } else {
                                currentWave = pricePos === 'above' ? 5 : 4;
                            }
                            break;
                        case 5: // Á¨¨5Êµ™ÁµêÊùüÔºà‰∏äÊº≤ÁµêÊùüÔºåÂ∏ÇÂ†¥ÁãÇÁÜ±Ôºâ
                            if (priceChange < -0.03) {
                                currentWave = 'A'; // ÈñãÂßãABC‰øÆÊ≠£
                            } else if (priceChange > 0.05) {
                                currentWave = 1; // Êñ∞Âæ™Áí∞ÈñãÂßã
                            } else {
                                currentWave = 5; // ÈÇÑÂú®Á¨¨5Êµ™
                            }
                            break;
                    }
                } else {
                    // ABC ‰øÆÊ≠£Êµ™
                    switch(lastLabel) {
                        case 'A': // AÊµ™ÁµêÊùüÔºà‰∏ãË∑åÁµêÊùüÔºâ
                            if (priceChange > 0.02) {
                                currentWave = 'B'; // ÂèçÂΩàÈÄ≤ÂÖ•BÊµ™
                            } else {
                                currentWave = 'A';
                            }
                            break;
                        case 'B': // BÊµ™ÁµêÊùüÔºàÂèçÂΩàÁµêÊùüÔºåÂ§öÈ†≠Èô∑Èò±Ôºâ
                            if (priceChange > 0.08) {
                                currentWave = 1; // Êñ∞Âæ™Áí∞ÈñãÂßã
                            } else if (priceChange < -0.02) {
                                currentWave = 'C'; // ÈÄ≤ÂÖ•CÊµ™‰∏ãË∑å
                            } else if (priceChange > 0.03) {
                                currentWave = 1; // ÂèØËÉΩÊñ∞Âæ™Áí∞
                            } else {
                                currentWave = pricePos === 'below' ? 'C' : 'B';
                            }
                            break;
                        case 'C': // CÊµ™ÁµêÊùüÔºà‰∏ãË∑åÁµêÊùüÔºåÁ†¥Â£ûÂäõÂº∑Ôºâ
                            if (priceChange > 0.03) {
                                currentWave = 1; // Êñ∞Âæ™Áí∞ÈñãÂßã
                            } else if (priceChange < -0.02) {
                                currentWave = 'C'; // ÈÇÑÂú®CÊµ™
                            } else {
                                currentWave = pricePos === 'above' ? 1 : 'C';
                            }
                            break;
                    }
                }
                
                console.log('Determined current wave:', currentWave);
            }
            
            // ===== Á¨¨ÂÖ´Ê≠•ÔºöÂà§Êñ∑Ë∂®Âã¢ =====
            let trend = 'Áõ§Êï¥';
            if (recentData.length >= 20) {
                const startPrice = parseFloat(recentData[recentData.length - 20].close);
                const change = (currentPrice - startPrice) / startPrice;
                if (change > 0.05) trend = '‰∏äÂçáË∂®Âã¢';
                else if (change < -0.05) trend = '‰∏ãÈôçË∂®Âã¢';
            }
            
            // ===== Á¨¨‰πùÊ≠•ÔºöÊ≥¢Êµ™Ë¶èÂâáÊ™¢Êü• =====
            const rules = [];
            const w1 = labeledWaves.find(w => w.number === 1);
            const w2 = labeledWaves.find(w => w.number === 2);
            const w3 = labeledWaves.find(w => w.number === 3);
            const w4 = labeledWaves.find(w => w.number === 4);
            const w5 = labeledWaves.find(w => w.number === 5);
            
            // Ë¶èÂâá1: Êµ™2‰∏çÂèØËÉΩÂÆåÂÖ®ÂõûÊí§Êµ™1
            if (w1 && w2) {
                const w1Start = Math.min(w1.start, w1.end);
                const w2End = Math.min(w2.start, w2.end);
                rules.push({
                    rule: 'Êµ™2‰∏çÂèØËÉΩÂÆåÂÖ®ÂõûÊí§Êµ™1',
                    valid: w2End >= w1Start * 0.99
                });
            }
            
            // Ë¶èÂâá2: Êµ™3‰∏çÂèØËÉΩÊòØÈ©ÖÂãïÊµ™‰∏≠ÊúÄÁü≠‰∏ÄÊµ™
            if (w1 && w3) {
                const w1Len = Math.abs(w1.end - w1.start);
                const w3Len = Math.abs(w3.end - w3.start);
                const w5Len = w5 ? Math.abs(w5.end - w5.start) : Infinity;
                const isW3Shortest = w3Len < w1Len && w3Len < w5Len;
                rules.push({
                    rule: 'Êµ™3‰∏çÂèØËÉΩÊòØÊúÄÁü≠Êé®ÂãïÊµ™',
                    valid: !isW3Shortest
                });
            }
            
            // Ë¶èÂâá3: Êµ™4ÁöÑ‰ΩéÈªû‰∏çËÉΩËàáÊµ™1È†ÇÈªûÈáçÁñä
            if (w1 && w4) {
                const w1Top = Math.max(w1.start, w1.end);
                const w4Low = Math.min(w4.start, w4.end);
                rules.push({
                    rule: 'Êµ™4‰ΩéÈªû‰∏çËÉΩËàáÊµ™1È†ÇÈªûÈáçÁñä',
                    valid: w4Low >= w1Top * 0.99
                });
            }
            
            // Ë®àÁÆóÂÉπÊ†ºËÆäÂãï
            let lastWaveEnd = null;
            let priceChangePercent = null;
            if (labeledWaves.length > 0) {
                lastWaveEnd = labeledWaves[labeledWaves.length - 1].end;
                priceChangePercent = ((currentPrice - lastWaveEnd) / lastWaveEnd * 100).toFixed(2);
            }
            
            // ÊúÄËøë5Â§©Êï∏Êìö
            const recentDays = data.slice(-5).map(d => ({
                date: d.date,
                open: parseFloat(d.open || d.close),
                high: parseFloat(d.high || d.close),
                low: parseFloat(d.low || d.close),
                close: parseFloat(d.close)
            }));
            
            return {
                waves: labeledWaves,
                currentWave,
                currentPrice,
                lastWaveEnd,
                priceChangePercent,
                rules,
                trend,
                pivots: alternatingPivots.slice(-10),
                recentDays,
                prices: recentData.map(d => parseFloat(d.close))
            };
        }
        
        function renderElliottWaveDisplay(analysis) {
            const displayWave = analysis.currentWave || '?';
            
            // Êõ¥Êñ∞Ê≥¢Êµ™‰ΩçÁΩÆ
            const wavePos = document.getElementById('currentWavePosition');
            wavePos.textContent = `Á¨¨ ${displayWave} Êµ™`;
            
            // Ê†πÊìöÊ≥¢Êµ™È°ûÂûãË®≠ÂÆöÈ°èËâ≤
            if (typeof displayWave === 'number' && displayWave % 2 === 1) {
                wavePos.style.color = 'var(--accent-up)'; // Êé®ÂãïÊµ™ 1, 3, 5
            } else if (typeof displayWave === 'number') {
                wavePos.style.color = 'var(--accent-cyan)'; // ‰øÆÊ≠£Êµ™ 2, 4
            } else if (displayWave === 'B') {
                wavePos.style.color = 'var(--accent-yellow)'; // BÊµ™ÂèçÂΩà
            } else {
                wavePos.style.color = 'var(--accent-down)'; // A, C Êµ™
            }
            
            // ÂÉπÊ†ºËÆäÂãïÊèèËø∞
            let priceChangeDesc = '';
            if (analysis.lastWaveEnd && analysis.priceChangePercent) {
                const change = parseFloat(analysis.priceChangePercent);
                if (change > 0) {
                    priceChangeDesc = `<span style="color: var(--accent-up);">‚Üë${analysis.priceChangePercent}%</span> Ëá™‰∏äÊµ™`;
                } else if (change < 0) {
                    priceChangeDesc = `<span style="color: var(--accent-down);">‚Üì${Math.abs(change).toFixed(2)}%</span> Ëá™‰∏äÊµ™`;
                }
            }
            
            document.getElementById('currentWaveDesc').innerHTML = `${analysis.trend} | ÁèæÂÉπ: ${analysis.currentPrice?.toFixed(2) || '--'} ${priceChangeDesc}`;
            
            // Êõ¥Êñ∞Ë∂®Âã¢
            const trendEl = document.getElementById('elliottTrend');
            if (analysis.trend === '‰∏äÂçáË∂®Âã¢') {
                trendEl.innerHTML = `<span style="color: var(--accent-up);">üìà ${analysis.trend}</span>`;
            } else if (analysis.trend === '‰∏ãÈôçË∂®Âã¢') {
                trendEl.innerHTML = `<span style="color: var(--accent-down);">üìâ ${analysis.trend}</span>`;
            } else {
                trendEl.innerHTML = `<span style="color: var(--accent-yellow);">‚û°Ô∏è ${analysis.trend}</span>`;
            }
            
            // Êõ¥Êñ∞Ë≤ªÊ≥¢Á¥çÂ•ë‰ΩçÁΩÆÔºàÂü∫ÊñºÁï∂ÂâçÊ≥¢Êµ™Ôºâ
            document.getElementById('elliottStrength').textContent = `${analysis.waves.length} ÂÄãÊ≥¢Êµ™`;
            
            // Êõ¥Êñ∞ÂàÜÊûêÂÖßÂÆπ
            document.getElementById('elliottAnalysis').innerHTML = generateWaveAnalysisHTML(analysis);
            
            // Êõ¥Êñ∞È†êÊ∏¨
            document.getElementById('wavePrediction').innerHTML = getWaveAdvice(analysis.currentWave, analysis.trend);
        }
        
        function generateWaveAnalysisHTML(analysis) {
            let html = '';
            
            // Ê≥¢Êµ™Ë®àÊï∏Ë¶ñË¶∫Âåñ
            html += `<div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">`;
            [1, 2, 3, 4, 5].forEach(n => {
                const isCurrent = analysis.currentWave === n;
                const bgColor = isCurrent ? 'var(--accent-up)' : 'var(--bg-hover)';
                const textColor = isCurrent ? 'white' : 'var(--text-secondary)';
                html += `<div style="width: 36px; height: 36px; border-radius: 50%; background: ${bgColor}; color: ${textColor}; display: flex; align-items: center; justify-content: center; font-weight: 600;">${n}</div>`;
            });
            ['A', 'B', 'C'].forEach(n => {
                const isCurrent = analysis.currentWave === n;
                const bgColor = isCurrent ? 'var(--accent-down)' : 'var(--bg-hover)';
                const textColor = isCurrent ? 'white' : 'var(--text-secondary)';
                html += `<div style="width: 36px; height: 36px; border-radius: 50%; background: ${bgColor}; color: ${textColor}; display: flex; align-items: center; justify-content: center; font-weight: 600;">${n}</div>`;
            });
            html += `</div>`;
            
            // Ê≥¢Êµ™Ë¶èÂâáÊ™¢Êü•
            html += `<div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin-bottom: 15px;">`;
            html += `<h4 style="margin: 0 0 10px 0; font-size: 0.95rem;">üìã Ê≥¢Êµ™Ë¶èÂâáÊ™¢Êü•</h4>`;
            if (analysis.rules.length > 0) {
                analysis.rules.forEach(r => {
                    const icon = r.valid ? '‚úÖ' : '‚ùå';
                    const color = r.valid ? 'var(--accent-up)' : 'var(--accent-down)';
                    html += `<div style="padding: 5px 0; color: ${color};">${icon} ${r.rule}</div>`;
                });
            } else {
                html += `<p style="color: var(--text-muted);">Ë≥áÊñô‰∏çË∂≥ÔºåÁÑ°Ê≥ïÂÆåÊï¥È©óË≠âÊ≥¢Êµ™Ë¶èÂâá</p>`;
            }
            html += `</div>`;
            
            // ËøëÊúüÊ≥¢Êµ™
            html += `<div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin-bottom: 15px;">`;
            html += `<h4 style="margin: 0 0 10px 0; font-size: 0.95rem;">üìä ËøëÊúüÊ≥¢Êµ™</h4>`;
            if (analysis.waves.length > 0) {
                analysis.waves.slice(-5).forEach((w, i, arr) => {
                    const isLastWave = i === arr.length - 1;
                    const bgStyle = isLastWave ? 'background: var(--bg-hover); margin: 0 -8px; padding: 8px; border-radius: 6px;' : '';
                    const color = w.type === 'up' ? 'var(--accent-up)' : 'var(--accent-down)';
                    const arrow = w.type === 'up' ? '‚Üë' : '‚Üì';
                    html += `<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color); ${bgStyle}">
                        <span>Á¨¨ ${w.number} Êµ™ (${w.isImpulse ? 'Êé®Âãï' : '‰øÆÊ≠£'})${isLastWave ? ' ‚Üê ÊúÄËøë' : ''}</span>
                        <span style="color: ${color}; font-family: 'JetBrains Mono', monospace;">
                            ${w.start.toFixed(2)} ‚Üí ${w.end.toFixed(2)} ${arrow}
                        </span>
                    </div>`;
                });
                
                // ÁèæÂÉπ‰Ωç
                if (analysis.lastWaveEnd) {
                    const changeColor = parseFloat(analysis.priceChangePercent) >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                    const sign = parseFloat(analysis.priceChangePercent) >= 0 ? '+' : '';
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 5px; border-top: 2px dashed var(--border-color);">
                        <span style="color: var(--accent-blue); font-weight: 600;">üìç ÁèæÂÉπ‰Ωç</span>
                        <span style="font-family: 'JetBrains Mono', monospace;">
                            ${analysis.lastWaveEnd.toFixed(2)} ‚Üí <span style="color: var(--accent-blue); font-weight: 600;">${analysis.currentPrice.toFixed(2)}</span>
                            <span style="color: ${changeColor}; margin-left: 5px;">(${sign}${analysis.priceChangePercent}%)</span>
                        </span>
                    </div>`;
                }
            } else {
                html += `<p style="color: var(--text-muted);">Ê≥¢Âãï‰∏çË∂≥ÔºåÁÑ°Ê≥ïË≠òÂà•ÊòéÁ¢∫Ê≥¢Êµ™</p>`;
            }
            html += `</div>`;
            
            // ÊúÄËøë‰∫§ÊòìÊó•Êï∏Êìö
            if (analysis.recentDays && analysis.recentDays.length > 0) {
                html += `<div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px;">`;
                html += `<h4 style="margin: 0 0 10px 0; font-size: 0.95rem;">üìÖ ÊúÄËøë‰∫§ÊòìÊó•Êï∏Êìö</h4>`;
                html += `<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">`;
                html += `<thead><tr style="background: var(--bg-hover);">
                    <th style="padding: 8px; text-align: left;">Êó•Êúü</th>
                    <th style="padding: 8px; text-align: right;">ÈñãÁõ§</th>
                    <th style="padding: 8px; text-align: right;">ÊúÄÈ´ò</th>
                    <th style="padding: 8px; text-align: right;">ÊúÄ‰Ωé</th>
                    <th style="padding: 8px; text-align: right;">Êî∂Áõ§</th>
                </tr></thead><tbody>`;
                analysis.recentDays.slice().reverse().forEach(d => {
                    const closeColor = d.close >= d.open ? 'var(--accent-up)' : 'var(--accent-down)';
                    html += `<tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 6px 8px;">${d.date}</td>
                        <td style="padding: 6px 8px; text-align: right; font-family: 'JetBrains Mono', monospace;">${d.open.toFixed(2)}</td>
                        <td style="padding: 6px 8px; text-align: right; font-family: 'JetBrains Mono', monospace;">${d.high.toFixed(2)}</td>
                        <td style="padding: 6px 8px; text-align: right; font-family: 'JetBrains Mono', monospace;">${d.low.toFixed(2)}</td>
                        <td style="padding: 6px 8px; text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 600; color: ${closeColor};">${d.close.toFixed(2)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            // ÊèêÁ§∫
            html += `<div style="margin-top: 15px; padding: 10px 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                üí° Ê≥¢Êµ™ÂàÜÊûêÂü∫Êñº<strong>Êî∂Áõ§ÂÉπ</strong>Ë≠òÂà•ËΩâÊäòÈªû„ÄÇÊ≥¢Êµ™ÁêÜË´ñÁÇ∫‰∏ªËßÄÂàÜÊûêÂ∑•ÂÖ∑ÔºåÂª∫Ë≠∞Êê≠ÈÖçÂÖ∂‰ªñÊåáÊ®ôÁ∂úÂêàÂà§Êñ∑„ÄÇ
            </div>`;
            
            return html;
        }
        
        function getWaveAdvice(wave, trend) {
            const advices = {
                1: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-up); font-weight: 600; margin-bottom: 10px;">üöÄ Á¨¨1Êµ™ - Êñ∞Ë∂®Âã¢Ëµ∑Èªû</p>
                    <p>Á¨¨1Êµ™ÁÇ∫Êñ∞Ë∂®Âã¢ÁöÑËµ∑ÈªûÔºåÈÄöÂ∏∏ÊòØÁØâÂ∫ïÂèçÂΩàÈöéÊÆµ„ÄÇÊ≠§ÊôÇÂ∏ÇÂ†¥Âçä‰ø°ÂçäÁñëÔºåÊàê‰∫§ÈáèÂèØËÉΩ‰∏çÂ§ß„ÄÇ</p>
                    <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>ÂèØÂ∞èÈáèË©¶ÂñÆÔºåË®≠Â•ΩÂÅúÊêçÔºåÁ≠âÂæÖÁ™ÅÁ†¥Á¢∫Ë™ç„ÄÇ</p>
                </div>`,
                2: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-cyan); font-weight: 600; margin-bottom: 10px;">‚è∏Ô∏è Á¨¨2Êµ™ - ÂõûË™øÊï¥ÁêÜ</p>
                    <p>Á¨¨2Êµ™ÁÇ∫ÂõûË™øÊï¥ÁêÜÈöéÊÆµÔºåÈÄöÂ∏∏ÂõûÊí§Á¨¨1Êµ™ÁöÑ 38.2%-61.8%„ÄÇ‰∏çÊúÉË∑åÁ†¥Á¨¨1Êµ™Ëµ∑Èªû„ÄÇ</p>
                    <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>Á≠âÂæÖÂõûË™øÂà∞ÊîØÊíê‰ΩçÂæåÈÄ≤Â†¥ÔºåÊòØËºÉÂ•ΩÁöÑË≤∑Èªû„ÄÇ</p>
                </div>`,
                3: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-up); font-weight: 600; margin-bottom: 10px;">üî• Á¨¨3Êµ™ - ‰∏ªÂçáÊÆµ</p>
                    <p>Á¨¨3Êµ™ÈÄöÂ∏∏ÊòØÊúÄÂº∑ÂãÅÁöÑ‰∏äÊº≤Ê≥¢ÊÆµÔºåÊàê‰∫§ÈáèÊîæÂ§ßÔºåÂ∏ÇÂ†¥‰ø°ÂøÉÂ¢ûÂº∑„ÄÇÁµïÂ∞ç‰∏çÊúÉÊòØÊúÄÁü≠ÁöÑÊé®ÂãïÊµ™„ÄÇ</p>
                    <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>ÂèØÁ©çÊ•µÂÅöÂ§öÔºåÊåÅËÇ°Á∫åÊä±Ôºå‰ΩÜÊ≥®ÊÑè‰∏çË¶ÅËøΩÈ´ò„ÄÇ</p>
                </div>`,
                4: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-cyan); font-weight: 600; margin-bottom: 10px;">‚è∏Ô∏è Á¨¨4Êµ™ - Êï¥ÁêÜÊúü</p>
                    <p>Á¨¨4Êµ™ÁÇ∫Êï¥ÁêÜÊúüÔºåÈÄöÂ∏∏ÂõûÊí§Á¨¨3Êµ™ÁöÑ 38.2%„ÄÇ‰∏çÊúÉËàáÁ¨¨1Êµ™ÂÉπÊ†ºÂçÄÈñìÈáçÁñä„ÄÇ</p>
                    <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>ÈÄ¢‰ΩéÂ∏ÉÂ±ÄÔºåÁ≠âÂæÖÁ¨¨5Êµ™ÁöÑÂà∞‰æÜ„ÄÇ</p>
                </div>`,
                5: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-yellow); font-weight: 600; margin-bottom: 10px;">‚ö†Ô∏è Á¨¨5Êµ™ - Êú´ÂçáÊÆµ</p>
                    <p>Á¨¨5Êµ™ÂèØËÉΩÊòØÊúÄÂæå‰∏ÄÊ≥¢‰∏äÊº≤ÔºåÊº≤ÂπÖÈÄöÂ∏∏Â∞èÊñºÁ¨¨3Êµ™„ÄÇÂèØËÉΩÂá∫ÁèæÈáèÂÉπËÉåÈõ¢„ÄÇ</p>
                    <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>ÈúÄË≠¶ÊÉïÂèçËΩâÈ¢®Èö™ÔºåËÄÉÊÖÆÈÄêÊ≠•Áç≤Âà©‰∫ÜÁµê„ÄÇ</p>
                </div>`,
                'A': `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-down); font-weight: 600; margin-bottom: 10px;">üìâ AÊµ™ - ‰øÆÊ≠£ÈñãÂßã</p>
                    <p>AÊµ™‰øÆÊ≠£ÈñãÂßãÔºåÂ§öÊï∏‰∫∫Ë™çÁÇ∫Âè™ÊòØÂõûÊ™îÔºå‰ΩÜÂØ¶Èöõ‰∏äË∂®Âã¢ÂèØËÉΩÂ∑≤Á∂ìÂèçËΩâ„ÄÇ</p>
                    <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>Ê∏õÁ¢ºÊàñËßÄÊúõÔºå‰∏çÂÆúÊê∂ÂèçÂΩà„ÄÇ</p>
                </div>`,
                'B': `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-yellow); font-weight: 600; margin-bottom: 10px;">üîÑ BÊµ™ - ÂèçÂΩàÈô∑Èò±</p>
                    <p>BÊµ™ÂèçÂΩàÈÄöÂ∏∏ÊòØÈô∑Èò±ÔºåÂÆπÊòìËÆì‰∫∫Ë™§‰ª•ÁÇ∫Ë∑åÂã¢ÁµêÊùü„ÄÇÊàê‰∫§ÈáèÈÄöÂ∏∏ËºÉAÊµ™Â∞è„ÄÇ</p>
                    <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>‰∏çÂÆúËøΩÈ´òÔºåÂèØËÄÉÊÖÆÈÄ¢È´òÊ∏õÁ¢º„ÄÇ</p>
                </div>`,
                'C': `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-down); font-weight: 600; margin-bottom: 10px;">üí° CÊµ™ - ‰øÆÊ≠£Êú´Á´Ø</p>
                    <p>CÊµ™‰øÆÊ≠£Êú´Á´ØÔºåË∑åÂã¢ÂèØËÉΩÂç≥Â∞áÁµêÊùü„ÄÇÂ∏ÇÂ†¥ÊÇ≤ËßÄÊÉÖÁ∑íÈÅîÂà∞È´òÂ≥∞„ÄÇ</p>
                    <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>ÂèØÈñãÂßãÁïôÊÑèÂèçÂΩàË≤∑ÈªûÔºåÁÇ∫Êñ∞Âæ™Áí∞ÂÅöÊ∫ñÂÇô„ÄÇ</p>
                </div>`
            };
            
            return advices[wave] || `<div style="line-height: 1.8;">
                <p style="color: var(--text-secondary);">ÁõÆÂâçÊ≥¢Êµ™‰ΩçÁΩÆÈúÄÊåÅÁ∫åËßÄÂØüÁ¢∫Ë™ç„ÄÇ</p>
                <p><strong>Ë∂®Âã¢Âà§Êñ∑Ôºö</strong>${trend}</p>
                <p><strong>üí° Âª∫Ë≠∞Ôºö</strong>Á≠âÂæÖÊõ¥ÊòéÁ¢∫ÁöÑË®äËôüÂá∫ÁèæÔºåÁµêÂêàÂÖ∂‰ªñÊäÄË°ìÊåáÊ®ôÁ∂úÂêàÂà§Êñ∑„ÄÇ</p>
            </div>`;
        }

        function drawElliottChart(analysis) {
            const ctx = document.getElementById('elliottChart').getContext('2d');
            
            if (charts.elliottChart) {
                charts.elliottChart.destroy();
            }
            
            // ‰ΩøÁî®ÊúÄËøë 60 Â§©ÁöÑÊï∏Êìö
            const recentData = stockData.slice(-60);
            const labels = recentData.map(d => d.date.substring(5));
            const prices = recentData.map(d => parseFloat(d.close));
            
            // Ê®ôË®òËΩâÊäòÈªû
            const pivotHighs = new Array(prices.length).fill(null);
            const pivotLows = new Array(prices.length).fill(null);
            
            // Â∞á pivots ÁöÑ index Â∞çÊáâÂà∞ recentData
            const dataStartIndex = stockData.length - recentData.length;
            
            if (analysis.pivots) {
                analysis.pivots.forEach(p => {
                    const adjustedIndex = p.index - dataStartIndex;
                    if (adjustedIndex >= 0 && adjustedIndex < prices.length) {
                        if (p.type === 'high') {
                            pivotHighs[adjustedIndex] = p.price;
                        } else {
                            pivotLows[adjustedIndex] = p.price;
                        }
                    }
                });
            }
            
            charts.elliottChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Êî∂Áõ§ÂÉπ',
                            data: prices,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Ê≥¢Êµ™È´òÈªû',
                            data: pivotHighs,
                            borderColor: 'transparent',
                            backgroundColor: '#ef4444',
                            pointRadius: 8,
                            pointStyle: 'triangle',
                            showLine: false
                        },
                        {
                            label: 'Ê≥¢Êµ™‰ΩéÈªû',
                            data: pivotLows,
                            borderColor: 'transparent',
                            backgroundColor: '#10b981',
                            pointRadius: 8,
                            pointStyle: 'triangle',
                            rotation: 180,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#94a3b8' }
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8'
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(45, 58, 79, 0.5)' },
                            ticks: { color: '#64748b', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(45, 58, 79, 0.5)' },
                            ticks: { color: '#64748b' }
                        }
                    }
                }
            });
        }

        function calculateFibonacciLevels(analysis) {
            if (!analysis.prices || analysis.prices.length < 10) return;
            
            const prices = analysis.prices;
            
            // ÊâæÊúÄËøëÁöÑÈáçË¶ÅÈ´ò‰ΩéÈªû
            let high = Math.max(...prices.slice(-30));
            let low = Math.min(...prices.slice(-30));
            
            const diff = high - low;
            
            // Ë®àÁÆóË≤ªÊ≥¢Á¥çÂ•ëÊ∞¥Âπ≥
            const levels = {
                0: low,
                236: low + diff * 0.236,
                382: low + diff * 0.382,
                50: low + diff * 0.5,
                618: low + diff * 0.618,
                786: low + diff * 0.786,
                100: high,
                1618: low + diff * 1.618
            };
            
            // Êõ¥Êñ∞È°ØÁ§∫
            document.getElementById('fib0').textContent = levels[0].toFixed(2);
            document.getElementById('fib236').textContent = levels[236].toFixed(2);
            document.getElementById('fib382').textContent = levels[382].toFixed(2);
            document.getElementById('fib50').textContent = levels[50].toFixed(2);
            document.getElementById('fib618').textContent = levels[618].toFixed(2);
            document.getElementById('fib786').textContent = levels[786].toFixed(2);
            document.getElementById('fib100').textContent = levels[100].toFixed(2);
            document.getElementById('fib1618').textContent = levels[1618].toFixed(2);
            
            // Âà§Êñ∑Áï∂ÂâçÂÉπÊ†ºÂú®Âì™ÂÄãÂçÄÈñì
            const currentPrice = analysis.currentPrice;
            let fibPosition = '';
            
            if (currentPrice <= levels[236]) fibPosition = '0% - 23.6%';
            else if (currentPrice <= levels[382]) fibPosition = '23.6% - 38.2%';
            else if (currentPrice <= levels[50]) fibPosition = '38.2% - 50%';
            else if (currentPrice <= levels[618]) fibPosition = '50% - 61.8%';
            else if (currentPrice <= levels[786]) fibPosition = '61.8% - 78.6%';
            else if (currentPrice <= levels[100]) fibPosition = '78.6% - 100%';
            else fibPosition = '> 100% (Âª∂‰º∏)';
            
            document.getElementById('fibonacciLevel').textContent = fibPosition;
        }
    </script>
</body>
</html>
